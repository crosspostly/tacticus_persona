<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integration Test - Character Stats with Equipment</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a2e;
            color: #e4e4e4;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        h1, h2 {
            color: #00d4ff;
            text-align: center;
        }
        .test-section {
            background: #16213e;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            border-left: 4px solid #00d4ff;
        }
        .test-case {
            background: #0f1a2e;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success {
            border-left: 4px solid #00ff88;
        }
        .error {
            border-left: 4px solid #ef4444;
        }
        .stat-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        .stat-table th, .stat-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #1a1a2e;
        }
        .stat-table th {
            color: #00d4ff;
            font-weight: bold;
        }
        .value {
            color: #00ff88;
            font-weight: bold;
        }
        .loading {
            text-align: center;
            color: #00d4ff;
            font-size: 1.2em;
        }
    </style>
</head>
<body>
    <h1>üß™ Integration Test: Character Stats Calculator</h1>
    <div id="loading" class="loading">Loading data...</div>
    <div id="results" style="display: none;"></div>

    <script>
        const RARITY_NAMES = ['Common', 'Uncommon', 'Rare', 'Epic', 'Legendary', 'Mythic'];
        let equipmentUpgrades = {};
        let characters = [];

        async function loadEquipmentUpgrades() {
            try {
                const response = await fetch('equipment_upgrades.json');
                if (!response.ok) {
                    throw new Error('equipment_upgrades.json not found');
                }
                equipmentUpgrades = await response.json();
                return true;
            } catch (error) {
                console.error('‚ùå Failed to load equipment upgrades:', error);
                return false;
            }
        }

        async function loadCharacterData() {
            try {
                const response = await fetch('data.json');
                if (!response.ok) {
                    throw new Error('data.json not found');
                }
                const data = await response.json();
                characters = data.characters || data;
                return true;
            } catch (error) {
                console.error('‚ùå Failed to load character data:', error);
                return false;
            }
        }

        function getEquipmentTier(rarityName, level) {
            const rarityMaxTiers = {
                'Common': 'Iron',
                'Uncommon': 'Bronze',
                'Rare': 'Silver',
                'Epic': 'Gold',
                'Legendary': 'Diamond',
                'Mythic': 'Diamond'
            };
            
            let tier, rank;
            
            if (level >= 51) {
                tier = 'Diamond'; rank = 'III';
            } else if (level >= 46) {
                tier = 'Diamond'; rank = 'II';
            } else if (level >= 41) {
                tier = 'Diamond'; rank = 'I';
            } else if (level >= 36) {
                tier = 'Gold'; rank = 'III';
            } else if (level >= 31) {
                tier = 'Gold'; rank = 'II';
            } else if (level >= 26) {
                tier = 'Gold'; rank = 'I';
            } else if (level >= 21) {
                tier = 'Silver'; rank = 'III';
            } else if (level >= 18) {
                tier = 'Silver'; rank = 'II';
            } else if (level >= 16) {
                tier = 'Silver'; rank = 'I';
            } else if (level >= 13) {
                tier = 'Bronze'; rank = 'III';
            } else if (level >= 11) {
                tier = 'Bronze'; rank = 'II';
            } else if (level >= 9) {
                tier = 'Bronze'; rank = 'I';
            } else if (level >= 6) {
                tier = 'Iron'; rank = 'III';
            } else if (level >= 4) {
                tier = 'Iron'; rank = 'II';
            } else if (level >= 2) {
                tier = 'Iron'; rank = 'I';
            } else {
                tier = 'Stone'; rank = 'III';
            }
            
            const maxTier = rarityMaxTiers[rarityName] || 'Stone';
            const tierOrder = ['Stone', 'Iron', 'Bronze', 'Silver', 'Gold', 'Diamond'];
            
            if (tierOrder.indexOf(tier) > tierOrder.indexOf(maxTier)) {
                tier = maxTier;
                rank = 'I';
            }
            
            return { tier, rank };
        }

        function getEquipmentBonuses(rarityName, level) {
            if (!equipmentUpgrades || Object.keys(equipmentUpgrades).length === 0) {
                return { hp: 0, armor: 0, damage: 0 };
            }
            
            const { tier, rank } = getEquipmentTier(rarityName, level);
            
            let totalBonuses = { hp: 0, armor: 0, damage: 0 };
            const tierOrder = ['Stone', 'Iron', 'Bronze', 'Silver', 'Gold', 'Diamond'];
            const rankOrder = ['I', 'II', 'III'];
            
            for (const currentTier of tierOrder) {
                if (!equipmentUpgrades[currentTier]) continue;
                
                for (const currentRank of rankOrder) {
                    if (!equipmentUpgrades[currentTier][currentRank]) continue;
                    
                    const bonus = equipmentUpgrades[currentTier][currentRank];
                    totalBonuses.hp += bonus.hp || 0;
                    totalBonuses.armor += bonus.armor || 0;
                    totalBonuses.damage += bonus.damage || 0;
                    
                    if (currentTier === tier && currentRank === rank) {
                        return totalBonuses;
                    }
                }
                
                if (currentTier === tier) break;
            }
            
            return totalBonuses;
        }

        function getCharacterStatsFromData(characterName, rarityName, level) {
            const character = characters.find(c => c.name === characterName);
            if (!character) {
                return null;
            }

            const baseStats = {
                hp: parseInt(character.baseStats?.health || 100),
                armor: parseInt(character.baseStats?.armour || 10),
                dmg: parseInt(character.baseStats?.damage || 15)
            };

            const allTables = [
                ...(character.activeAbility?.tables || []),
                ...(character.passiveAbility?.tables || [])
            ];

            if (allTables.length === 0) {
                const equipmentBonuses = getEquipmentBonuses(rarityName, level);
                return {
                    hp: baseStats.hp + equipmentBonuses.hp,
                    armor: baseStats.armor + equipmentBonuses.armor,
                    dmg: baseStats.dmg + equipmentBonuses.damage,
                    source: 'base'
                };
            }

            let targetTable = null;
            for (let i = 0; i < allTables.length; i++) {
                const table = allTables[i];
                const headers = table[0];
                const hasHealth = headers.some(h => h.includes('Health') || h.includes('HP'));
                const hasArmour = headers.some(h => h.includes('Armour') || h.includes('Armor'));
                const hasDamage = headers.some(h => h.includes('Damage') && !h.includes('Piercing') && !h.includes('3x'));
                
                if (hasHealth || hasArmour || hasDamage) {
                    targetTable = table;
                    break;
                }
            }

            if (!targetTable) {
                const equipmentBonuses = getEquipmentBonuses(rarityName, level);
                return {
                    hp: baseStats.hp + equipmentBonuses.hp,
                    armor: baseStats.armor + equipmentBonuses.armor,
                    dmg: baseStats.dmg + equipmentBonuses.damage,
                    source: 'base'
                };
            }

            const tableHeaders = targetTable[0];
            const rarityIndex = tableHeaders.indexOf('Rarity');
            const healthIndex = tableHeaders.findIndex(h => h.includes('Health') || h.includes('HP'));
            const armourIndex = tableHeaders.findIndex(h => h.includes('Armour') || h.includes('Armor'));
            const damageIndex = tableHeaders.findIndex(h => h.includes('Damage') && !h.includes('Piercing') && !h.includes('3x'));
            
            let targetRow = null;
            for (let i = 1; i < targetTable.length; i++) {
                const row = targetTable[i];
                if (row[rarityIndex] === rarityName) {
                    targetRow = row;
                    break;
                }
            }

            if (!targetRow) {
                const equipmentBonuses = getEquipmentBonuses(rarityName, level);
                return {
                    hp: baseStats.hp + equipmentBonuses.hp,
                    armor: baseStats.armor + equipmentBonuses.armor,
                    dmg: baseStats.dmg + equipmentBonuses.damage,
                    source: 'base'
                };
            }

            let hp = baseStats.hp;
            let armor = baseStats.armor;
            let dmg = baseStats.dmg;
            
            if (healthIndex !== -1) {
                const hpValue = targetRow[healthIndex];
                if (hpValue && typeof hpValue === 'string' && hpValue.includes('-')) {
                    const [min, max] = hpValue.split('-').map(v => parseInt(v.trim()));
                    hp = Math.round((min + max) / 2);
                } else if (hpValue && !isNaN(parseInt(hpValue))) {
                    hp = parseInt(hpValue);
                }
            }
            
            if (armourIndex !== -1) {
                const armorValue = targetRow[armourIndex];
                if (armorValue && typeof armorValue === 'string' && armorValue.includes('-')) {
                    const [min, max] = armorValue.split('-').map(v => parseInt(v.trim()));
                    armor = Math.round((min + max) / 2);
                } else if (armorValue && !isNaN(parseInt(armorValue))) {
                    armor = parseInt(armorValue);
                }
            }
            
            if (damageIndex !== -1) {
                const dmgValue = targetRow[damageIndex];
                if (dmgValue && typeof dmgValue === 'string' && dmgValue.includes('-')) {
                    const [min, max] = dmgValue.split('-').map(v => parseInt(v.trim()));
                    dmg = Math.round((min + max) / 2);
                } else if (dmgValue && !isNaN(parseInt(dmgValue))) {
                    dmg = parseInt(dmgValue);
                }
            }
            
            const equipmentBonuses = getEquipmentBonuses(rarityName, level);
            
            return {
                hp: hp + equipmentBonuses.hp,
                armor: armor + equipmentBonuses.armor,
                dmg: dmg + equipmentBonuses.damage,
                source: 'table',
                baseHP: hp,
                baseArmor: armor,
                baseDmg: dmg,
                equipmentBonuses: equipmentBonuses
            };
        }

        async function runTests() {
            const loadingDiv = document.getElementById('loading');
            const resultsDiv = document.getElementById('results');
            
            loadingDiv.textContent = 'Loading equipment_upgrades.json...';
            const equipmentLoaded = await loadEquipmentUpgrades();
            
            if (!equipmentLoaded) {
                loadingDiv.innerHTML = '<div class="test-section error">‚ùå Failed to load equipment_upgrades.json</div>';
                return;
            }

            loadingDiv.textContent = 'Loading data.json...';
            const dataLoaded = await loadCharacterData();
            
            if (!dataLoaded) {
                loadingDiv.innerHTML = '<div class="test-section error">‚ùå Failed to load data.json</div>';
                return;
            }

            loadingDiv.style.display = 'none';
            resultsDiv.style.display = 'block';

            let html = '<h2>‚úÖ All Data Loaded Successfully</h2>';

            // Test 1: Equipment Tier Mapping
            html += '<div class="test-section"><h3>Test 1: Equipment Tier Mapping</h3>';
            const tierTests = [
                { rarity: 'Common', level: 1, expected: 'Stone III' },
                { rarity: 'Common', level: 8, expected: 'Iron I' },
                { rarity: 'Epic', level: 28, expected: 'Gold I' },
                { rarity: 'Legendary', level: 50, expected: 'Diamond II' },
                { rarity: 'Mythic', level: 55, expected: 'Diamond III' },
            ];

            tierTests.forEach(test => {
                const { tier, rank } = getEquipmentTier(test.rarity, test.level);
                const result = `${tier} ${rank}`;
                const isSuccess = result === test.expected;
                const icon = isSuccess ? '‚úÖ' : '‚ùå';
                const cssClass = isSuccess ? 'success' : 'error';
                html += `<div class="test-case ${cssClass}">${icon} ${test.rarity} Lvl ${test.level}: ${result} (expected: ${test.expected})</div>`;
            });
            html += '</div>';

            // Test 2: Equipment Bonuses Calculation
            html += '<div class="test-section"><h3>Test 2: Equipment Bonuses</h3>';
            const bonusTests = [
                { rarity: 'Epic', level: 28 },
                { rarity: 'Legendary', level: 50 },
                { rarity: 'Common', level: 8 },
            ];

            bonusTests.forEach(test => {
                const bonuses = getEquipmentBonuses(test.rarity, test.level);
                const { tier, rank } = getEquipmentTier(test.rarity, test.level);
                html += `
                    <div class="test-case success">
                        <strong>${test.rarity} Lvl ${test.level}</strong> (Max Tier: ${tier} ${rank})<br>
                        HP: +${bonuses.hp} | Armor: +${bonuses.armor} | Damage: +${bonuses.damage}
                    </div>
                `;
            });
            html += '</div>';

            // Test 3: Character Stats with Equipment
            html += '<div class="test-section"><h3>Test 3: Character Stats (Base + Equipment)</h3>';
            const charTests = [
                { name: 'Marshal Dreir', rarity: 'Epic', level: 35 },
                { name: 'Calandis', rarity: 'Legendary', level: 50 },
            ];

            charTests.forEach(test => {
                const stats = getCharacterStatsFromData(test.name, test.rarity, test.level);
                if (stats) {
                    const { tier, rank } = getEquipmentTier(test.rarity, test.level);
                    html += `
                        <div class="test-case success">
                            <strong>${test.name}</strong> (${test.rarity} Lvl ${test.level})<br>
                            Equipment: ${tier} ${rank}<br>
                            <table class="stat-table">
                                <tr>
                                    <th>Stat</th>
                                    <th>Base</th>
                                    <th>Equipment</th>
                                    <th>Total</th>
                                </tr>
                                <tr>
                                    <td>HP</td>
                                    <td>${stats.baseHP || 'N/A'}</td>
                                    <td>+${stats.equipmentBonuses?.hp || 0}</td>
                                    <td class="value">${stats.hp}</td>
                                </tr>
                                <tr>
                                    <td>Armor</td>
                                    <td>${stats.baseArmor || 'N/A'}</td>
                                    <td>+${stats.equipmentBonuses?.armor || 0}</td>
                                    <td class="value">${stats.armor}</td>
                                </tr>
                                <tr>
                                    <td>Damage</td>
                                    <td>${stats.baseDmg || 'N/A'}</td>
                                    <td>+${stats.equipmentBonuses?.damage || 0}</td>
                                    <td class="value">${stats.dmg}</td>
                                </tr>
                            </table>
                            Source: ${stats.source === 'table' ? 'Ability Tables' : 'Base Stats'}
                        </div>
                    `;
                } else {
                    html += `<div class="test-case error">‚ùå Character "${test.name}" not found</div>`;
                }
            });
            html += '</div>';

            resultsDiv.innerHTML = html;
        }

        runTests();
    </script>
</body>
</html>
