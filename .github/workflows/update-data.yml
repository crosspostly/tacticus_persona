name: Monthly Data Update

on:
  # Ğ—Ğ°Ğ¿ÑƒÑĞº 1-Ğ³Ğ¾ Ñ‡Ğ¸ÑĞ»Ğ° ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ Ğ¼ĞµÑÑÑ†Ğ° Ğ² 00:00 UTC
  schedule:
    - cron: '0 0 1 * *'
  # Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm install
      
      - name: Parse TacticusTable API
        run: |
          echo "ğŸŒ Fetching data from api.tacticustable.com..."
          node parse_tacticustable_api.js --force
          echo "âœ… API data parsed successfully"
      
      - name: Backup old data.json
        run: |
          if [ -f data.json ]; then
            cp data.json data.json.backup
            echo "ğŸ“¦ Backup created: data.json.backup"
          fi
      
      - name: Update data.json (merge API data)
        run: |
          echo "ğŸ”„ Merging tacticustable_heroes_stats.json into data.json..."
          
          # ĞŸÑ€Ğ¾ÑÑ‚Ğ¾Ğ¹ ÑĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ´Ğ»Ñ Ğ¾Ğ±ÑŠĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
          node -e '
            const fs = require("fs");
            const oldData = JSON.parse(fs.readFileSync("data.json", "utf8"));
            const newData = JSON.parse(fs.readFileSync("tacticustable_heroes_stats.json", "utf8"));
            
            // Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ ĞºĞ°Ñ€Ñ‚Ñƒ ÑÑ‚Ğ°Ñ€Ñ‹Ñ… Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ¶ĞµĞ¹ Ğ¿Ğ¾ Ğ¸Ğ¼ĞµĞ½Ğ¸
            const oldCharsMap = new Map();
            oldData.characters.forEach(char => {
              oldCharsMap.set(char.name, char);
            });
            
            // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ¸Ğ»Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ¶ĞµĞ¹
            const updatedChars = newData.characters.map(newChar => {
              const oldChar = oldCharsMap.get(newChar.name);
              
              if (oldChar) {
                // Ğ•ÑĞ»Ğ¸ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ¶ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚, Ğ¾Ğ±ÑŠĞµĞ´Ğ¸Ğ½ÑĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
                // API Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ¼ĞµÑÑ‚ Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚, Ğ½Ğ¾ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹ Ğ¸Ğ· ÑÑ‚Ğ°Ñ€Ğ¾Ğ³Ğ¾ data.json
                return {
                  ...oldChar,
                  ...newChar,
                  activeAbility: {
                    ...newChar.activeAbility,
                    tables: oldChar.activeAbility?.tables || []
                  },
                  passiveAbility: {
                    ...newChar.passiveAbility,
                    tables: oldChar.passiveAbility?.tables || []
                  }
                };
              } else {
                // ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ¶
                return newChar;
              }
            });
            
            // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ¼ĞµÑ‚Ğ°-Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
            const updatedData = {
              meta: {
                total: updatedChars.length,
                successful: updatedChars.length,
                failed: 0,
                lastUpdate: new Date().toISOString(),
                source: "api.tacticustable.com",
                apiVersion: newData.meta.apiVersion
              },
              characters: updatedChars.sort((a, b) => a.name.localeCompare(b.name))
            };
            
            fs.writeFileSync("data.json", JSON.stringify(updatedData, null, 2));
            console.log(`âœ… Updated data.json with ${updatedChars.length} characters`);
          '
      
      - name: Check for changes
        id: check_changes
        run: |
          if git diff --exit-code data.json tacticustable_heroes_stats.json; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No changes detected"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Changes detected"
          fi
      
      - name: Commit and push if changed
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ backup Ğ¸ raw ĞºÑÑˆ
          git rm -f data.json.backup 2>/dev/null || true
          git rm -f raw_game_info.json 2>/dev/null || true
          
          git add data.json tacticustable_heroes_stats.json
          
          git commit -m "ğŸ”„ Monthly data update from TacticusTable API
          
          - Updated character stats and abilities
          - Merged with existing ability tables
          - Source: api.tacticustable.com
          - Updated at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          
          git push
          
          echo "âœ… Changes committed and pushed"
      
      - name: Summary
        if: always()
        run: |
          echo "ğŸ“Š Update Summary:"
          echo "===================="
          
          if [ "${{ steps.check_changes.outputs.changed }}" == "true" ]; then
            echo "âœ… Data was updated and pushed to repository"
          else
            echo "â„¹ï¸ No changes detected, repository is up-to-date"
          fi
          
          # ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºÑƒ
          echo ""
          echo "ğŸ“ˆ Current statistics:"
          node -e '
            const data = require("./data.json");
            console.log(`Total characters: ${data.meta.total}`);
            console.log(`Last update: ${data.meta.lastUpdate || "N/A"}`);
            console.log(`API version: ${data.meta.apiVersion || "N/A"}`);
          '
