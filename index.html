<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tacticus Matchup Analyzer - 100 Characters</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a2e;
            color: #e4e4e4;
            padding: 20px;
        }
        .container { max-width: 1900px; margin: 0 auto; }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #00d4ff;
            font-size: 2.5em;
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        }
        
        /* üéØ –ò–ö–û–ù–ö–ê –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò –í –ü–†–ê–í–û–ú –í–ï–†–•–ù–ï–ú –£–ì–õ–£ */
        .sync-icon {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 48px;
            height: 48px;
            background: #00ff88;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0, 255, 136, 0.4);
            transition: all 0.3s;
            font-size: 1.5em;
        }
        .sync-icon:hover {
            background: #00d4ff;
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 212, 255, 0.6);
        }
        .sync-icon.loading {
            animation: rotate 1s linear infinite;
        }
        .sync-icon.success {
            background: #00ff88;
        }
        .sync-icon.error {
            background: #ef4444;
        }
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .sync-tooltip {
            position: fixed;
            top: 75px;
            right: 20px;
            background: #16213e;
            padding: 10px 15px;
            border-radius: 8px;
            border: 2px solid #00d4ff;
            font-size: 0.75em;
            max-width: 250px;
            z-index: 999;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            display: none;
        }
        .sync-tooltip.show {
            display: block;
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: #00d4ff;
            font-size: 1.5em;
            font-weight: bold;
        }
        .loading-overlay.hidden {
            display: none;
        }
        
        /* üéöÔ∏è –ú–û–î–ò–§–ò–ö–ê–¢–û–†–´ */
        .modifiers {
            background: #16213e;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        .modifier-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px 15px;
            background: #0f1a2e;
            border-radius: 5px;
            transition: all 0.3s;
        }
        .modifier-toggle:hover {
            background: #1a2a3e;
        }
        .modifier-toggle input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        .modifier-toggle label {
            cursor: pointer;
            font-size: 0.9em;
        }
        
        .filters {
            background: #16213e;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        .filter-group { display: flex; flex-direction: column; gap: 8px; }
        .filter-group label { color: #00d4ff; font-weight: bold; font-size: 0.9em; }
        select {
            padding: 10px;
            background: #0f1a2e;
            color: #e4e4e4;
            border: 2px solid #00d4ff;
            border-radius: 5px;
            font-size: 0.95em;
            cursor: pointer;
        }
        .limit-group {
            grid-column: span 3;
            display: flex;
            align-items: center;
            gap: 15px;
            justify-content: center;
            padding-top: 10px;
            border-top: 2px solid #0f1a2e;
        }
        .legend {
            background: #16213e;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        .legend-item { display: flex; align-items: center; gap: 8px; }
        .legend-color { width: 30px; height: 20px; border-radius: 3px; }
        .dominate { background: #00ff00; }
        .advantage { background: #4ade80; }
        .balanced { background: #fbbf24; }
        .disadvantage { background: #fb923c; }
        .dominated { background: #ef4444; }
        .matrix-container {
            background: #16213e;
            padding: 20px;
            border-radius: 10px;
            overflow: auto;
            max-height: 70vh;
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            font-size: 0.75em; 
        }
        th, td {
            padding: 8px 4px;
            text-align: center;
            border: 1px solid #0f1a2e;
            min-width: 85px;
        }
        th {
            background: #0f1a2e;
            color: #00d4ff;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        th:first-child, td:first-child {
            position: sticky;
            left: 0;
            background: #0f1a2e;
            font-weight: bold;
            z-index: 5;
            min-width: 140px;
            text-align: left;
            padding-left: 10px;
        }
        th:first-child { z-index: 15; }
        td { cursor: pointer; transition: all 0.2s; position: relative; }
        td:hover {
            transform: scale(1.05);
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
            z-index: 100;
        }
        .cell-dominate { background: #00ff00; color: #000; font-weight: bold; }
        .cell-advantage { background: #4ade80; color: #000; }
        .cell-balanced { background: #fbbf24; color: #000; }
        .cell-disadvantage { background: #fb923c; color: #fff; }
        .cell-dominated { background: #ef4444; color: #fff; }
        
        .detail-panel {
            position: fixed;
            right: -550px;
            top: 0;
            width: 520px;
            height: 100vh;
            background: #16213e;
            box-shadow: -5px 0 20px rgba(0, 0, 0, 0.7);
            padding: 30px;
            overflow-y: auto;
            transition: right 0.3s ease;
            z-index: 1000;
        }
        .detail-panel.active { right: 0; }
        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #ef4444;
            color: #fff;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 1.5em;
            cursor: pointer;
            line-height: 0;
        }
        .close-btn:hover { background: #dc2626; }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #0f1a2e;
        }
        .tab {
            padding: 10px 20px;
            background: #0f1a2e;
            border: none;
            color: #e4e4e4;
            cursor: pointer;
            border-radius: 5px 5px 0 0;
            font-weight: bold;
        }
        .tab.active {
            background: #00d4ff;
            color: #1a1a2e;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        .panel-title {
            font-size: 1.6em;
            color: #00d4ff;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }
        .char-card {
            background: #0f1a2e;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .char-card h3 { 
            color: #00ff88; 
            margin-bottom: 10px; 
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .char-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #00d4ff;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #1a1a2e;
            font-size: 0.9em;
        }
        .stat-label { color: #00d4ff; font-weight: bold; }
        .vs-divider {
            text-align: center;
            font-size: 2em;
            color: #ff6b6b;
            margin: 15px 0;
            font-weight: bold;
        }
        .metric-box {
            background: #1a1a2e;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #00d4ff;
        }
        .metric-box h4 { color: #00d4ff; margin-bottom: 8px; font-size: 1em; }
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            text-align: center;
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
        }
        .trade-indicator {
            background: #0f1a2e;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 2px solid;
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
        }
        .trade-indicator.dominate {
            border-color: #00ff00;
            color: #00ff00;
        }
        .trade-indicator.advantage {
            border-color: #4ade80;
            color: #4ade80;
        }
        .trade-indicator.balanced {
            border-color: #fbbf24;
            color: #fbbf24;
        }
        .trade-indicator.disadvantage {
            border-color: #fb923c;
            color: #fb923c;
        }
        .trade-indicator.dominated {
            border-color: #ef4444;
            color: #ef4444;
        }
        .synergy-list {
            list-style: none;
            padding: 0;
        }
        .synergy-item {
            background: #1a1a2e;
            padding: 12px;
            margin: 8px 0;
            border-radius: 5px;
            border-left: 3px solid #00ff88;
        }
        .partner-badge {
            display: inline-block;
            background: #0f1a2e;
            padding: 5px 10px;
            border-radius: 15px;
            margin: 3px;
            font-size: 0.85em;
            border: 1px solid #00d4ff;
        }
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: #00d4ff;
        }
        .tooltip {
            position: absolute;
            background: #0f1a2e;
            border: 2px solid #00d4ff;
            border-radius: 8px;
            padding: 15px;
            display: none;
            z-index: 999;
            max-width: 320px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
            transition: all 0.2s ease;
        }
        @media (max-width: 768px) {
            .tooltip {
                max-width: 280px;
                font-size: 0.9em;
            }
            .tooltip img {
                width: 60px;
                height: 60px;
            }
        }
        .tooltip.active { 
            display: block; 
            animation: tooltipFadeIn 0.2s ease;
        }
        @keyframes tooltipFadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .tooltip img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-bottom: 10px;
            border: 2px solid #00d4ff;
            box-shadow: 0 2px 10px rgba(0, 212, 255, 0.3);
            object-fit: cover;
            background: #16213e;
        }
        .tooltip .char-name {
            font-weight: bold;
            color: #00d4ff;
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        .tooltip .char-stats {
            font-size: 0.85em;
            line-height: 1.4;
        }
        .tooltip .stat-row {
            display: flex;
            justify-content: space-between;
            margin: 2px 0;
        }
        .tooltip .stat-label {
            color: #888;
        }
        .tooltip .stat-value {
            color: #fff;
            font-weight: bold;
        }
        
        .bonus-icon {
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 0.75em;
            color: #ffcc00;
            animation: bonusPulse 1.5s infinite;
        }

        @keyframes bonusPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.2); }
        }

        .conditional-bonus-item {
            background: linear-gradient(135deg, rgba(255, 204, 0, 0.15), rgba(0, 212, 255, 0.1));
            padding: 10px;
            margin: 8px 0;
            border-radius: 6px;
            border: 2px solid #ffcc00;
        }

        .bonus-badge {
            display: inline-block;
            background: #ffcc00;
            color: #1a1a2e;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7em;
            font-weight: bold;
            margin-left: 5px;
        }
        
        /* üìñ –†–ê–°–ö–†–´–¢–ò–ï –î–ï–¢–ê–õ–ï–ô */
        .expand-btn {
            background: #0f1a2e;
            border: 1px solid #00d4ff;
            color: #00d4ff;
            padding: 5px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
            margin-top: 8px;
            transition: all 0.2s;
        }
        .expand-btn:hover {
            background: #00d4ff;
            color: #1a1a2e;
        }
        .detail-text {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            font-size: 0.85em;
            color: #ccc;
            margin-top: 8px;
            line-height: 1.5;
        }
        .detail-text.expanded {
            max-height: 500px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚öîÔ∏è Warhammer 40K: Tacticus - Matchup Analyzer</h1>
        
        <!-- üéØ –ò–ö–û–ù–ö–ê –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò -->
        <div class="sync-icon" id="syncIcon" onclick="syncAllData()" title="–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö">
            üîÑ
        </div>
        <div class="sync-tooltip" id="syncTooltip"></div>
        
        <!-- üéöÔ∏è –ú–û–î–ò–§–ò–ö–ê–¢–û–†–´ -->
        <div class="modifiers">
            <div class="modifier-toggle">
                <input type="checkbox" id="modTerrain" onchange="onModifierChange()">
                <label for="modTerrain">üèîÔ∏è Terrain (+50% dmg)</label>
            </div>
            <div class="modifier-toggle">
                <input type="checkbox" id="modHighGround" onchange="onModifierChange()">
                <label for="modHighGround">‚¨ÜÔ∏è High Ground (+50% dmg)</label>
            </div>
            <div class="modifier-toggle">
                <input type="checkbox" id="modCrit" onchange="onModifierChange()">
                <label for="modCrit">üí• Crit Chance (avg +10% dmg)</label>
            </div>
            <div class="modifier-toggle">
                <input type="checkbox" id="modRazor" onchange="onModifierChange()">
                <label for="modRazor">üî™ Razor Wire (+50% dmg taken)</label>
            </div>
        </div>
        
        <div class="filters">
            <div class="filter-group">
                <label>üéØ –°–û–†–¢–ò–†–û–í–ö–ê</label>
                <select id="sortOrder">
                    <option value="alpha">–ê–ª—Ñ–∞–≤–∏—Ç (A-Z)</option>
                    <option value="hp">–ü–æ HP (–±–æ–ª—å—à–µ ‚Üí –º–µ–Ω—å—à–µ)</option>
                    <option value="armor">–ü–æ –±—Ä–æ–Ω–µ (–±–æ–ª—å—à–µ ‚Üí –º–µ–Ω—å—à–µ)</option>
                    <option value="damage">–ü–æ —É—Ä–æ–Ω—É (–±–æ–ª—å—à–µ ‚Üí –º–µ–Ω—å—à–µ)</option>
                </select>
            </div>

            <div class="filter-group">
                <label>üè∞ –§–†–ê–ö–¶–ò–Ø</label>
                <select id="factionFilter">
                    <option value="">–í—Å–µ —Ñ—Ä–∞–∫—Ü–∏–∏</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>‚ú® –¢–†–ï–ô–¢</label>
                <select id="traitFilter">
                    <option value="">–í—Å–µ —Ç—Ä–µ–π—Ç—ã</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>üó°Ô∏è –§–ò–õ–¨–¢–† –ê–¢–ê–ö–£–Æ–©–ò–•</label>
                <select id="attackerFilter">
                    <option value="">–í—Å–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>üõ°Ô∏è –§–ò–õ–¨–¢–† –ó–ê–©–ò–©–ê–Æ–©–ò–•–°–Ø</label>
                <select id="defenderFilter">
                    <option value="">–í—Å–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏</option>
                </select>
            </div>

            <div class="filter-group">
                <label>‚ö° –¢–ò–ü –£–†–û–ù–ê</label>
                <select id="damageTypeFilter">
                    <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
                    <option value="melee">–¢–æ–ª—å–∫–æ Melee</option>
                    <option value="ranged">–¢–æ–ª—å–∫–æ Ranged</option>
                    <option value="both">–û–±–∞ —Ç–∏–ø–∞</option>
                </select>
            </div>
            
            <div class="limit-group">
                <label>üìä –ü–û–ö–ê–ó–ê–¢–¨ –ü–ï–†–í–´–•</label>
                <select id="limitSelect">
                    <option value="20">20 –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π</option>
                    <option value="30">30 –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π</option>
                    <option value="50" selected>50 –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π</option>
                    <option value="100">–í—Å–µ (100)</option>
                </select>
            </div>
        </div>

        <div class="legend">
            <div class="legend-item"><div class="legend-color dominate"></div><span>–î–æ–º–∏–Ω–∏—Ä—É—é (2x –±—ã—Å—Ç—Ä–µ–µ)</span></div>
            <div class="legend-item"><div class="legend-color advantage"></div><span>–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ (1.5x)</span></div>
            <div class="legend-item"><div class="legend-color balanced"></div><span>–ë–∞–ª–∞–Ω—Å (¬±30%)</span></div>
            <div class="legend-item"><div class="legend-color disadvantage"></div><span>–ù–µ–¥–æ—Å—Ç–∞—Ç–æ–∫ (1.5x –º–µ–¥–ª–µ–Ω–Ω–µ–µ)</span></div>
            <div class="legend-item"><div class="legend-color dominated"></div><span>–î–æ–º–∏–Ω–∏—Ä—É—é—Ç (2x –º–µ–¥–ª–µ–Ω–Ω–µ–µ)</span></div>
        </div>

        <div class="matrix-container">
            <div id="loading" class="loading">
                –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...
            </div>
            <table id="matchupTable" style="display: none;">
                <thead id="tableHead"></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <div class="detail-panel" id="detailPanel">
        <button class="close-btn" onclick="closeDetail()">√ó</button>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('analysis')">üìä –ê–Ω–∞–ª–∏–∑</button>
            <button class="tab" onclick="switchTab('synergy')">ü§ù –°–∏–Ω–µ—Ä–≥–∏—è</button>
            <button class="tab" onclick="switchTab('counters')">‚ö†Ô∏è –ö–æ–Ω—Ç—Ä—ã</button>
        </div>
        
        <div id="detailContent">
            <div id="analysisTab" class="tab-content active"></div>
            <div id="synergyTab" class="tab-content"></div>
            <div id="countersTab" class="tab-content"></div>
        </div>
    </div>
    
    <div class="tooltip" id="tooltip"></div>
    
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div>
            <div>‚öîÔ∏è –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö...</div>
            <div style="font-size: 0.7em; margin-top: 10px;">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ</div>
        </div>
    </div>

    <script>
        const PIERCE_RATIOS = {
            'Psychic': 100, 'Direct': 100, 'Piercing': 80, 'Melta': 75,
            'Plasma': 65, 'Eviscerating': 50, 'Power': 40, 'Flame': 30,
            'Energy': 30, 'Bolter': 20, 'Chain': 20, 'Pulse': 20,
            'Blast': 15, 'Heavy Round': 15, 'Bio': 15, 'Molecular': 15,
            'Particle': 15, 'Toxic': 15, 'Las': 10, 'Projectile': 5,
            'Physical': 1
        };
        
        const MACHINES_OF_WAR = [
            'Biovore', 'Exorcist', 'Forgefiend', 'Galatian',
            'Malleus Rocket Launcher', 'Plagueburst Crawler',
            'Rukkatrukk', "Tson'ji"
        ];

        let traitsDB = [];
        let characterTraitsDB = [];
        let conditionalBonusesDB = [];
        let characterFactionsDB = [];
        let characterAttackTypesDB = [];
        let passiveAbilitiesDB = [];
        let characters = [];
        let matchupMatrix = {};
        let synergyDatabase = {};
        let counterDatabase = {};
        let currentLimit = 50;
        let currentAttacker = null;
        let currentDefender = null;

        // –ì–ª–æ–±–∞–ª—å–Ω–æ–µ –∑–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–π –ø–æ–ª–∑—É–Ω–∫–æ–≤
        let atkRarityValue = 0;   // –†–µ–¥–∫–æ—Å—Ç—å –∞—Ç–∞–∫—É—é—â–µ–≥–æ (0-5)
        let atkLevelValue = 1;    // –£—Ä–æ–≤–µ–Ω—å –∞—Ç–∞–∫—É—é—â–µ–≥–æ (1-55)
        let defRarityValue = 0;   // –†–µ–¥–∫–æ—Å—Ç—å –∑–∞—â–∏—Ç–Ω–∏–∫–∞ (0-5)
        let defLevelValue = 1;    // –£—Ä–æ–≤–µ–Ω—å –∑–∞—â–∏—Ç–Ω–∏–∫–∞ (1-55)

        window.addEventListener('load', function() {
            syncAllData();
        });

        async function syncAllData() {
            const syncIcon = document.getElementById('syncIcon');
            const syncTooltip = document.getElementById('syncTooltip');
            const loadingOverlay = document.getElementById('loadingOverlay');
            
            syncIcon.classList.add('loading');
            syncTooltip.textContent = 'üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...';
            syncTooltip.classList.add('show');
            loadingOverlay.classList.remove('hidden');
            
            try {
                let mainData = null;
                let dataSource = '';
                
                try {
                    const txtResponse = await fetch('data.json');
                    if (txtResponse.ok) {
                        const txtContent = await txtResponse.text();
                        mainData = JSON.parse(txtContent);
                        dataSource = 'data.json';
                    }
                } catch (e) {
                    console.log('data.json not found, trying data.json...');
                }
                
                if (!mainData) {
                    const jsonResponse = await fetch('data.json');
                    if (!jsonResponse.ok) throw new Error('–§–∞–π–ª—ã –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
                    mainData = await jsonResponse.json();
                    dataSource = 'data.json';
                }
                
                let dataArray = mainData;
                if (mainData.characters && Array.isArray(mainData.characters)) {
                    dataArray = mainData.characters;
                } else if (!Array.isArray(mainData)) {
                    throw new Error('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö');
                }
                
                const [synergyResponse, counterResponse, enhancedSynergyResponse, enhancedCounterResponse] = await Promise.all([
                    fetch('synergy_database.json').catch(() => null),
                    fetch('counter_database.json').catch(() => null),
                    fetch('enhanced_synergy_database.json').catch(() => null),
                    fetch('enhanced_counter_database.json').catch(() => null)
                ]);
                
                if (synergyResponse?.ok) {
                    synergyDatabase = await synergyResponse.json();
                }
                
                if (enhancedSynergyResponse?.ok) {
                    const enhancedData = await enhancedSynergyResponse.json();
                    synergyDatabase = {...synergyDatabase, ...enhancedData};
                }
                
                if (counterResponse?.ok) {
                    counterDatabase = await counterResponse.json();
                }
                
                if (enhancedCounterResponse?.ok) {
                    const enhancedData = await enhancedCounterResponse.json();
                    counterDatabase = {...counterDatabase, ...enhancedData};
                }
                
                await loadConditionalDatabases();
                
                const filtered = dataArray.filter(c => isCharacter(c) && !MACHINES_OF_WAR.includes(c.name));
                
                characters = filtered.map((c, i) => {
                    return {
                        id: i + 1,
                        name: c.name,
                        hp: parseInt(c.baseStats?.health || c.baseHealth || 100),
                        armor: parseInt(c.baseStats?.armour || c.baseArmour || 20),
                        dmg: parseInt(c.baseStats?.damage || c.baseDamage || 15),
                        melee: c.attacks?.melee || c.meleeAttack || 'N/A',
                        ranged: c.attacks?.ranged || c.rangedAttack || 'N/A',
                        traits: c.traits || '',
                        icon: c.images?.heroIcon || c.images?.heroArt || '',
                        faction: c.faction || 'Unknown',
                        activeAbility: c.activeAbility || {},
                        passiveAbility: c.passiveAbility || {},
                        rarities: {} // Disabled unreliable parsing
                    };
                });
                
                characters.sort((a, b) => a.name.localeCompare(b.name));
                
                // ‚úÖ –†–ê–°–°–ß–ò–¢–´–í–ê–ï–ú –í–°–Å 1 –†–ê–ó
                console.log('‚è≥ –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π —Ä–∞—Å—á—ë—Ç –º–∞—Ç—Ä–∏—Ü—ã...');
                const startTime = Date.now();
                
                buildMatchupMatrix();
                
                let calculated = 0;
                const total = characters.length * characters.length;
                
                characters.forEach((attacker, i) => {
                    characters.forEach(defender => {
                        matchupMatrix[attacker.name][defender.name] = calculateMatchup(attacker, defender);
                        calculated++;
                    });
                    
                    if (i % 10 === 0) {
                        const progress = Math.round((calculated / total) * 100);
                        const loadingDiv = loadingOverlay.querySelector('div div');
                        if (loadingDiv) {
                            loadingDiv.textContent = `‚öîÔ∏è –†–∞—Å—á—ë—Ç –º—ç—Ç—á–∞–ø–æ–≤: ${progress}%`;
                        }
                    }
                });
                
                const duration = ((Date.now() - startTime) / 1000).toFixed(2);
                console.log(`‚úÖ ${total} –º—ç—Ç—á–∞–ø–æ–≤ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–æ –∑–∞ ${duration}—Å`);
                
                populateFilters();
                renderTable();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('matchupTable').style.display = 'table';
                loadingOverlay.classList.add('hidden');
                
                syncIcon.classList.remove('loading');
                syncIcon.classList.add('success');
                
                const synergyCount = Object.keys(synergyDatabase).length;
                const counterCount = Object.keys(counterDatabase).length;
                
                syncTooltip.innerHTML = `
                    ‚úÖ ${characters.length} –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π<br>
                    ‚úÖ –°–∏–Ω–µ—Ä–≥–∏–∏: ${synergyCount}<br>
                    ‚úÖ –ö–æ–Ω—Ç—Ä—ã: ${counterCount}<br>
                    <small>–ò—Å—Ç–æ—á–Ω–∏–∫: ${dataSource}</small>
                `;
                
                setTimeout(() => {
                    syncTooltip.classList.remove('show');
                }, 3000);
                
            } catch (error) {
                console.error('Sync error:', error);
                loadingOverlay.classList.add('hidden');
                syncIcon.classList.remove('loading');
                syncIcon.classList.add('error');
                syncIcon.textContent = '‚ùå';
                syncTooltip.innerHTML = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
                syncTooltip.classList.add('show');
            }
        }

        async function loadConditionalDatabases() {
            try {
                const parseCSV = (text) => {
                    const lines = text.trim().split('\n');
                    const headers = lines[0].split(',').map(h => h.trim());
                    return lines.slice(1).map(line => {
                        const values = [];
                        let current = '';
                        let inQuotes = false;

                        for (let char of line) {
                            if (char === '"') {
                                inQuotes = !inQuotes;
                            } else if (char === ',' && !inQuotes) {
                                values.push(current.trim());
                                current = '';
                            } else {
                                current += char;
                            }
                        }
                        values.push(current.trim());

                        return headers.reduce((obj, header, i) => {
                            obj[header] = values[i]?.replace(/^\"|\"$/g, '') || '';
                            return obj;
                        }, {});
                    });
                };

                const [traitsText, charTraitsText, bonusesText, factionsText, attacksText, passivesText] = await Promise.all([
                    fetch('traits_database.csv').then(r => r.ok ? r.text() : null).catch(() => null),
                    fetch('character_traits.csv').then(r => r.ok ? r.text() : null).catch(() => null),
                    fetch('conditional_bonuses.csv').then(r => r.ok ? r.text() : null).catch(() => null),
                    fetch('character_factions.csv').then(r => r.ok ? r.text() : null).catch(() => null),
                    fetch('character_attack_types.csv').then(r => r.ok ? r.text() : null).catch(() => null),
                    fetch('passive_abilities.csv').then(r => r.ok ? r.text() : null).catch(() => null)
                ]);

                if (traitsText) traitsDB = parseCSV(traitsText);
                if (charTraitsText) characterTraitsDB = parseCSV(charTraitsText);
                if (bonusesText) conditionalBonusesDB = parseCSV(bonusesText);
                if (factionsText) characterFactionsDB = parseCSV(factionsText);
                if (attacksText) characterAttackTypesDB = parseCSV(attacksText);
                if (passivesText) passiveAbilitiesDB = parseCSV(passivesText);

                return true;
            } catch (error) {
                console.warn('‚ö†Ô∏è Could not load CSV databases:', error);
                return false;
            }
        }

        function getCharacterTraits(characterName) {
            if (characterTraitsDB.length === 0) {
                const char = characters.find(c => c.name === characterName);
                if (!char || !char.traits) return [];
                return typeof char.traits === 'string' 
                    ? char.traits.split(', ').map(t => t.trim()).filter(t => t)
                    : char.traits;
            }
            return characterTraitsDB
                .filter(row => row.character === characterName)
                .map(row => row.trait);
        }

        function getTraitData(traitName) {
            return traitsDB.find(row => row.trait_name === traitName);
        }

        function getConditionalBonuses(characterName) {
            return conditionalBonusesDB.filter(row => row.character === characterName);
        }

        function getPassiveAbility(characterName) {
            const passive = passiveAbilitiesDB.find(row => row.character === characterName);
            if (!passive) return null;
            
            return {
                name: passive.passive_name,
                type: passive.effect_type,
                damageMult: parseFloat(passive.damage_multiplier) || 1.0,
                defenseMult: parseFloat(passive.defense_multiplier) || 1.0,
                additionalDmg: parseFloat(passive.additional_damage) || 0,
                condition: passive.condition,
                notes: passive.notes
            };
        }

        function isCharacter(entry) {
            return entry.baseStats &&
                   entry.attacks &&
                   (!entry.rawInfobox?.Type ||
                    (entry.rawInfobox?.Type && !entry.rawInfobox.Type.includes("Badge") &&
                     !entry.rawInfobox.Type.includes("Component") &&
                     !entry.rawInfobox.Type.includes("Mythic")));
        }

        function extractAttackInfo(attackStr) {
            if (!attackStr || attackStr === 'N/A') return [null, 0];
            const parts = attackStr.split('/').map(p => p.trim());
            const damageType = parts[0] || 'Physical';
            let hits = 1;
            for (const part of parts) {
                if (part.toLowerCase().includes('hit')) {
                    const match = part.match(/\d+/);
                    if (match) hits = parseInt(match[0]);
                }
            }
            return [damageType, hits];
        }

        function calculateMatchup(attacker, defender) {
            const [rangedType, rangedHits] = extractAttackInfo(attacker.ranged);
            const [meleeType, meleeHits] = extractAttackInfo(attacker.melee);
            
            // –í—ã–±–∏—Ä–∞–µ–º –∞—Ç–∞–∫—É —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º —É—Ä–æ–Ω–æ–º
            let atkType, atkHits;
            
            if (rangedType && rangedHits > 0 && meleeType && meleeHits > 0) {
                // –°—á–∏—Ç–∞–µ–º –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π —É—Ä–æ–Ω –¥–ª—è –æ–±–µ–∏—Ö –∞—Ç–∞–∫
                const rangedPierce = PIERCE_RATIOS[rangedType] || 20;
                const meleePierce = PIERCE_RATIOS[meleeType] || 20;
                
                const rangedPotentialDmg = attacker.dmg * Math.max(rangedPierce / 100, 0.1) * rangedHits;
                const meleePotentialDmg = attacker.dmg * Math.max(meleePierce / 100, 0.1) * meleeHits;
                
                // –í—ã–±–∏—Ä–∞–µ–º –∞—Ç–∞–∫—É —Å –±–æ–ª—å—à–∏–º —É—Ä–æ–Ω–æ–º
                if (rangedPotentialDmg >= meleePotentialDmg) {
                    [atkType, atkHits] = [rangedType, rangedHits];
                } else {
                    [atkType, atkHits] = [meleeType, meleeHits];
                }
            } else if (rangedType && rangedHits > 0) {
                [atkType, atkHits] = [rangedType, rangedHits];
            } else {
                [atkType, atkHits] = [meleeType, meleeHits];
            }

            const pierce = PIERCE_RATIOS[atkType] || 20;

            const atkTraits = getCharacterTraits(attacker.name);
            const defTraits = getCharacterTraits(defender.name);

            let dmg = attacker.dmg;
            let armor = defender.armor;
            let hits = atkHits;

            // ‚úÖ TRAIT MODIFIERS (–ò–°–ü–†–ê–í–õ–ï–ù–û)
            if (atkTraits.includes('Crushing Strike')) {
                hits += 1; // ‚ùó +1 —Ö–∏—Ç, –ù–ï —É—Ä–æ–Ω!
            }

            let incomingMult = 1.0;
            if (defTraits.includes('Resilient')) incomingMult *= 0.8;
            if (defTraits.includes('Terminator Armour')) incomingMult *= 0.8;
            if (defTraits.includes('Mk X Gravis')) incomingMult *= 0.85;

            // Check conditional bonuses
            let hasConditionalBonus = false;
            let conditionalBonusDetails = null;
            const bonuses = getConditionalBonuses(attacker.name);
            bonuses.forEach(bonus => {
                const conditionMet = bonus.condition_type === 'trait' 
                    ? defTraits.includes(bonus.condition_value)
                    : bonus.condition_type === 'faction'
                    ? defender.faction === bonus.condition_value
                    : false;

                if (conditionMet) {
                    hasConditionalBonus = true;
                    let bonusMultiplier = 1.5;
                    if (bonus.bonus_value && bonus.bonus_value !== 'unknown' && !isNaN(parseFloat(bonus.bonus_value))) {
                        bonusMultiplier = 1 + parseFloat(bonus.bonus_value) / 100;
                    }
                    dmg *= bonusMultiplier;
                    conditionalBonusDetails = {
                        name: bonus.ability_name,
                        type: bonus.ability_type,
                        conditionType: bonus.condition_type,
                        target: bonus.condition_value,
                        multiplier: bonusMultiplier
                    };
                }
            });
            
            // Global Modifiers
            if (document.getElementById('modTerrain')?.checked) dmg *= 1.5;
            if (document.getElementById('modHighGround')?.checked) dmg *= 1.5;
            if (document.getElementById('modCrit')?.checked) dmg *= 1.1;
            if (document.getElementById('modRazor')?.checked) incomingMult *= 1.5; // Razor Wire —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –≤—Ö–æ–¥—è—â–∏–π —É—Ä–æ–Ω

            // ‚úÖ DAMAGE FORMULA (–ò–°–ü–†–ê–í–õ–ï–ù–û)
            // Pierce Ratio –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –ö–ê–ö–ê–Ø –ß–ê–°–¢–¨ —É—Ä–æ–Ω–∞ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –±—Ä–æ–Ω—é
            const directDamage = dmg * (pierce / 100); // –≠—Ç–∞ —á–∞—Å—Ç—å –∏–¥—ë—Ç –Ω–∞–ø—Ä—è–º—É—é
            const blockedPortion = dmg * (1 - pierce / 100); // –≠—Ç–∞ —á–∞—Å—Ç—å –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –±—Ä–æ–Ω—ë–π
            const damageAfterArmor = Math.max(0, blockedPortion - armor);

            // –ò—Ç–æ–≥–æ–≤—ã–π —É—Ä–æ–Ω = –ø—Ä—è–º–æ–π + –ø—Ä–æ–±–∏–≤—à–∏–π—Å—è —á–µ—Ä–µ–∑ –±—Ä–æ–Ω—é
            let totalDamage = directDamage + damageAfterArmor;

            // –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–∏–Ω–∏–º—É–º 10% –æ—Ç –±–∞–∑–æ–≤–æ–≥–æ —É—Ä–æ–Ω–∞
            const minimumDamage = dmg * 0.1;
            totalDamage = Math.max(totalDamage, minimumDamage);

            totalDamage *= incomingMult;

            const dmgPerHit = Math.round(totalDamage);
            const totalDmg = dmgPerHit * hits;
            
            // Attack Efficiency: % HP removed per turn
            const attackEff = Math.min(100, (totalDmg / defender.hp) * 100);
            const roundsToKill = defender.hp / Math.max(1, totalDmg);

            // Defense Efficiency: Simplified durability metric
            const armorRatio = armor / Math.max(1, dmg);
            const defenseEff = Math.min(100, Math.max(0, armorRatio * 50 + 25));

            // Calculate return damage (rough estimation for symmetry)
            const [defRangedType, defRangedHits] = extractAttackInfo(defender.ranged);
            const [defMeleeType, defMeleeHits] = extractAttackInfo(defender.melee);
            
            // –í—ã–±–∏—Ä–∞–µ–º –∞—Ç–∞–∫—É –∑–∞—â–∏—Ç–Ω–∏–∫–∞ —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º —É—Ä–æ–Ω–æ–º
            let defAtkType, defAtkHits;
            
            if (defRangedType && defRangedHits > 0 && defMeleeType && defMeleeHits > 0) {
                const defRangedPierce = PIERCE_RATIOS[defRangedType] || 20;
                const defMeleePierce = PIERCE_RATIOS[defMeleeType] || 20;
                
                const defRangedPotentialDmg = defender.dmg * Math.max(defRangedPierce / 100, 0.1) * defRangedHits;
                const defMeleePotentialDmg = defender.dmg * Math.max(defMeleePierce / 100, 0.1) * defMeleeHits;
                
                if (defRangedPotentialDmg >= defMeleePotentialDmg) {
                    [defAtkType, defAtkHits] = [defRangedType, defRangedHits];
                } else {
                    [defAtkType, defAtkHits] = [defMeleeType, defMeleeHits];
                }
            } else if (defRangedType && defRangedHits > 0) {
                [defAtkType, defAtkHits] = [defRangedType, defRangedHits];
            } else {
                [defAtkType, defAtkHits] = [defMeleeType, defMeleeHits];
            }
            
            const defPierce = PIERCE_RATIOS[defAtkType] || 20;

            let defDmg = defender.dmg;
            let myArmor = attacker.armor;

            // ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –§–û–†–ú–£–õ–ê –î–õ–Ø –û–¢–í–ï–¢–ù–û–ì–û –£–†–û–ù–ê
            const defDirectDamage = defDmg * (defPierce / 100);
            const defBlockedPortion = defDmg * (1 - defPierce / 100);
            const defDamageAfterArmor = Math.max(0, defBlockedPortion - myArmor);
            const defTotalDamage = Math.max(defDirectDamage + defDamageAfterArmor, defDmg * 0.1);
            const defTotalDmg = defTotalDamage * defAtkHits;
            const roundsToKillMe = attacker.hp / Math.max(1, defTotalDmg);

            return {
                attack: Math.round(attackEff * 10) / 10,
                defense: Math.round(defenseEff * 10) / 10,
                roundsToKill: Math.round(roundsToKill * 10) / 10,
                roundsToKillMe: Math.round(roundsToKillMe * 10) / 10,
                dmgPerHit: Math.round(dmgPerHit),
                totalDmgPerTurn: Math.round(totalDmg),
                hasConditionalBonus: hasConditionalBonus,
                conditionalBonus: conditionalBonusDetails
            };
        }

        function buildMatchupMatrix() {
            matchupMatrix = {};
            characters.forEach(attacker => {
                matchupMatrix[attacker.name] = {};
                characters.forEach(defender => {
                    matchupMatrix[attacker.name][defender.name] = null;
                });
            });
        }

        // ‚úÖ –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò
        let currentModifiers = {
            terrain: false,
            highGround: false,
            crit: false,
            razor: false
        };

        function onModifierChange() {
            const newMods = {
                terrain: document.getElementById('modTerrain')?.checked || false,
                highGround: document.getElementById('modHighGround')?.checked || false,
                crit: document.getElementById('modCrit')?.checked || false,
                razor: document.getElementById('modRazor')?.checked || false
            };
            
            // –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ä–µ–∞–ª—å–Ω–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
            if (JSON.stringify(newMods) !== JSON.stringify(currentModifiers)) {
                currentModifiers = newMods;
                
                // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –¢–û–õ–¨–ö–û –≤–∏–¥–∏–º—É—é —á–∞—Å—Ç—å —Ç–∞–±–ª–∏—Ü—ã
                console.log('üîÑ –ü–µ—Ä–µ—Å—á—ë—Ç —Å –Ω–æ–≤—ã–º–∏ –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞–º–∏...');
                recalculateVisibleMatchups();
            }
        }

        function recalculateVisibleMatchups() {
            const atkFilter = document.getElementById('attackerFilter').value;
            const defFilter = document.getElementById('defenderFilter').value;
            const limit = parseInt(document.getElementById('limitSelect').value);
            
            let displayedAtk = atkFilter 
                ? characters.filter(c => c.name === atkFilter)
                : characters.slice(0, limit);
            
            let displayedDef = defFilter
                ? characters.filter(c => c.name === defFilter)
                : characters.slice(0, limit);
            
            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –≤–∏–¥–∏–º—ã–µ (50√ó50 –≤–º–µ—Å—Ç–æ 100√ó100)
            displayedAtk.forEach(atk => {
                displayedDef.forEach(def => {
                    matchupMatrix[atk.name][def.name] = calculateMatchup(atk, def);
                });
            });
            
            renderTable();
        }

        function getMatchup(attacker, defender) {
            // ‚úÖ –î–ê–ù–ù–´–ï –£–ñ–ï –†–ê–°–°–ß–ò–¢–ê–ù–´ - –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º
            return matchupMatrix[attacker.name][defender.name];
        }

        function populateFilters() {
            const atkFilter = document.getElementById('attackerFilter');
            const defFilter = document.getElementById('defenderFilter');
            const factionFilter = document.getElementById('factionFilter');
            const traitFilter = document.getElementById('traitFilter');
            
            atkFilter.innerHTML = '<option value="">–í—Å–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏</option>';
            defFilter.innerHTML = '<option value="">–í—Å–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏</option>';
            
            const factions = [...new Set(characters.map(c => c.faction))].sort();
            factionFilter.innerHTML = '<option value="">–í—Å–µ —Ñ—Ä–∞–∫—Ü–∏–∏</option>';
            factions.forEach(faction => {
                if (faction && faction !== 'Unknown') {
                    const opt = document.createElement('option');
                    opt.value = faction;
                    opt.textContent = faction;
                    factionFilter.appendChild(opt);
                }
            });
            
            const allTraits = new Set();
            characters.forEach(char => {
                const traits = getCharacterTraits(char.name);
                traits.forEach(t => allTraits.add(t));
            });
            
            const sortedTraits = [...allTraits].sort();
            traitFilter.innerHTML = '<option value="">–í—Å–µ —Ç—Ä–µ–π—Ç—ã</option>';
            sortedTraits.forEach(trait => {
                if (trait) {
                    const opt = document.createElement('option');
                    opt.value = trait;
                    opt.textContent = trait;
                    traitFilter.appendChild(opt);
                }
            });
            
            characters.forEach(char => {
                const opt1 = document.createElement('option');
                opt1.value = char.name;
                opt1.textContent = char.name;
                atkFilter.appendChild(opt1);
                
                const opt2 = document.createElement('option');
                opt2.value = char.name;
                opt2.textContent = char.name;
                defFilter.appendChild(opt2);
            });
        }

        function getTradeClass(myRounds, theirRounds) {
            const ratio = myRounds / theirRounds;
            if (ratio <= 0.5) return 'cell-dominate';
            if (ratio <= 0.67) return 'cell-advantage';
            if (ratio <= 1.3) return 'cell-balanced';
            if (ratio <= 2.0) return 'cell-disadvantage';
            return 'cell-dominated';
        }

        function renderTable() {
            const atkFilter = document.getElementById('attackerFilter').value;
            const defFilter = document.getElementById('defenderFilter').value;
            const factionFilter = document.getElementById('factionFilter').value;
            const traitFilter = document.getElementById('traitFilter').value;
            const damageTypeFilter = document.getElementById('damageTypeFilter').value;
            const sortOrder = document.getElementById('sortOrder').value;
            const limit = parseInt(document.getElementById('limitSelect').value);
            
            let filteredChars = characters.filter(c => {
                if (factionFilter && c.faction !== factionFilter) return false;
                if (traitFilter && !getCharacterTraits(c.name).includes(traitFilter)) return false;
                if (damageTypeFilter) {
                    const hasMelee = c.melee && c.melee !== 'N/A';
                    const hasRanged = c.ranged && c.ranged !== 'N/A';
                    if (damageTypeFilter === 'melee' && !hasMelee) return false;
                    if (damageTypeFilter === 'ranged' && !hasRanged) return false;
                    if (damageTypeFilter === 'both' && (!hasMelee || !hasRanged)) return false;
                }
                return true;
            });
            
            if (sortOrder === 'alpha') {
                filteredChars.sort((a, b) => a.name.localeCompare(b.name));
            } else if (sortOrder === 'hp') {
                filteredChars.sort((a, b) => b.hp - a.hp);
            } else if (sortOrder === 'armor') {
                filteredChars.sort((a, b) => b.armor - a.armor);
            } else if (sortOrder === 'damage') {
                filteredChars.sort((a, b) => b.dmg - a.dmg);
            }
            
            let displayedAtk = filteredChars.slice(0, limit);
            if (atkFilter) {
                displayedAtk = filteredChars.filter(c => c.name === atkFilter);
            }
            
            let displayedDef = filteredChars.slice(0, limit);
            if (defFilter) {
                displayedDef = filteredChars.filter(c => c.name === defFilter);
            }
            
            const thead = document.getElementById('tableHead');
            const tbody = document.getElementById('tableBody');
            
            thead.innerHTML = '';
            tbody.innerHTML = '';
            
            const headerRow = document.createElement('tr');
            const corner = document.createElement('th');
            corner.textContent = '–ê–¢–ê–ö–£–Æ–©–ò–ô ‚Üì / –ó–ê–©–ò–©–ê–Æ–©–ò–ô–°–Ø ‚Üí';
            corner.colSpan = 1;
            headerRow.appendChild(corner);
            
            displayedDef.forEach((def, index) => {
                const nameTh = document.createElement('th');
                nameTh.innerHTML = `${index + 1}. ${def.name}`;
                nameTh.onmouseenter = (e) => showTooltip(e, def);
                nameTh.onmouseleave = hideTooltip;
                headerRow.appendChild(nameTh);
            });
            thead.appendChild(headerRow);
            
            displayedAtk.forEach((atk, atkIndex) => {
                const row = document.createElement('tr');
                
                const nameCell = document.createElement('td');
                nameCell.innerHTML = `${atkIndex + 1}. ${atk.name}`;
                nameCell.onmouseenter = (e) => showTooltip(e, atk);
                nameCell.onmouseleave = hideTooltip;
                row.appendChild(nameCell);
                
                displayedDef.forEach(def => {
                    const metrics = getMatchup(atk, def);
                    const cell = document.createElement('td');
                    cell.innerHTML = `
                        <div style="font-size: 0.85em; font-weight: 600; position: relative;">
                            ‚öîÔ∏è ${metrics.attack}%
                            ${metrics.hasConditionalBonus ? '<span class="bonus-icon">‚ö°</span>' : ''}
                        </div>
                        <div style="font-size: 0.85em; font-weight: 600; margin-top: 2px;">
                            üõ°Ô∏è ${metrics.defense}%
                        </div>
                    `;
                    cell.className = getTradeClass(metrics.roundsToKill, metrics.roundsToKillMe);
                    cell.onclick = () => showDetail(atk, def, metrics);
                    row.appendChild(cell);
                });
                
                tbody.appendChild(row);
            });
        }

        function showTooltip(event, char) {
            const tooltip = document.getElementById('tooltip');
            const hasImage = char.icon && char.icon.trim() !== '';
            
            tooltip.innerHTML = `
                ${hasImage ? 
                    `<img src="${char.icon}" alt="${char.name}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                     <div style="width:80px;height:80px;background:#16213e;border-radius:50%;margin-bottom:10px;display:none;align-items:center;justify-content:center;color:#888;font-size:2em;">üë§</div>` : 
                    '<div style="width:80px;height:80px;background:#16213e;border-radius:50%;margin-bottom:10px;display:flex;align-items:center;justify-content:center;color:#888;font-size:2em;">üë§</div>'
                }
                <div class="char-name">${char.name}</div>
                <div class="char-stats">
                    <div class="stat-row">
                        <span class="stat-label">HP:</span>
                        <span class="stat-value">${char.hp}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">ARM:</span>
                        <span class="stat-value">${char.armor}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">DMG:</span>
                        <span class="stat-value">${char.dmg}</span>
                    </div>
                    <div style="margin-top:5px;color:#888;font-size:0.9em;">
                        <div>‚öîÔ∏è ${char.melee}</div>
                        <div>üèπ ${char.ranged}</div>
                    </div>
                </div>
            `;
            
            let left = event.pageX + 15;
            let top = event.pageY + 15;
            const tooltipWidth = 320;
            const tooltipHeight = 220;
            
            if (left + tooltipWidth > window.innerWidth) {
                left = event.pageX - tooltipWidth - 15;
            }
            if (top + tooltipHeight > window.innerHeight) {
                top = event.pageY - tooltipHeight - 15;
            }
            
            left = Math.max(10, Math.min(left, window.innerWidth - tooltipWidth - 10));
            top = Math.max(10, Math.min(top, window.innerHeight - tooltipHeight - 10));
            
            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
            tooltip.classList.add('active');
        }

        function hideTooltip() {
            document.getElementById('tooltip').classList.remove('active');
        }

        function showDetail(attacker, defender, metrics) {
            currentAttacker = attacker;
            currentDefender = defender;
            
            const calculatedMetrics = metrics || getMatchup(attacker, defender);
            
            renderAnalysisTab(attacker, defender, calculatedMetrics);
            renderSynergyTab(attacker);
            renderCountersTab(defender);
            
            document.getElementById('detailPanel').classList.add('active');
        }

        function closeDetail() {
            document.getElementById('detailPanel').classList.remove('active');
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        function renderAnalysisTab(atk, def, metrics) {
            currentAttacker = atk;
            currentDefender = def;
            
            const [atkType, atkHits] = extractAttackInfo(atk.ranged)[0] ? extractAttackInfo(atk.ranged) : extractAttackInfo(atk.melee);
            const pierce = PIERCE_RATIOS[atkType] || 20;
            
            const atkTraits = getCharacterTraits(atk.name);
            const defTraits = getCharacterTraits(def.name);
            
            const ratio = metrics.roundsToKill / metrics.roundsToKillMe;
            let tradeResult = '';
            let tradeClass = '';
            
            if (ratio <= 0.5) {
                tradeResult = `üü¢ ${atk.name} –î–û–ú–ò–ù–ò–†–£–ï–¢ (+${(metrics.roundsToKillMe - metrics.roundsToKill).toFixed(1)} —Ä–∞—É–Ω–¥–∞ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞)`;
                tradeClass = 'dominate';
            } else if (ratio <= 0.67) {
                tradeResult = `üü¢ ${atk.name} –∏–º–µ–µ—Ç –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ (+${(metrics.roundsToKillMe - metrics.roundsToKill).toFixed(1)} —Ä–∞—É–Ω–¥–∞)`;
                tradeClass = 'advantage';
            } else if (ratio <= 1.3) {
                tradeResult = `üü° –°–ë–ê–õ–ê–ù–°–ò–†–û–í–ê–ù–ù–´–ô –†–ê–ó–ú–ï–ù (—Ä–∞–∑–Ω–∏—Ü–∞ ${Math.abs(metrics.roundsToKillMe - metrics.roundsToKill).toFixed(1)} —Ä–∞—É–Ω–¥–∞)`;
                tradeClass = 'balanced';
            } else if (ratio <= 2.0) {
                tradeResult = `üî¥ ${def.name} –∏–º–µ–µ—Ç –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ (+${(metrics.roundsToKill - metrics.roundsToKillMe).toFixed(1)} —Ä–∞—É–Ω–¥–∞)`;
                tradeClass = 'disadvantage';
            } else {
                tradeResult = `üî¥ ${def.name} –î–û–ú–ò–ù–ò–†–£–ï–¢ (+${(metrics.roundsToKill - metrics.roundsToKillMe).toFixed(1)} —Ä–∞—É–Ω–¥–∞ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞)`;
                tradeClass = 'dominated';
            }
            
            const atkRarityName = RARITY_NAMES[atkRarityValue] || 'Common';
            const defRarityName = RARITY_NAMES[defRarityValue] || 'Common';

            document.getElementById('analysisTab').innerHTML = `
                <div class="panel-title">–î–ï–¢–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó</div>
                
                <div class="char-card">
                    <h3>
                        ${atk.icon ? `<img src="${atk.icon}" class="char-icon">` : ''}
                        ‚öîÔ∏è ${atk.name}
                    </h3>
                    <div class="stat-row"><span class="stat-label">HP:</span><span>${atk.hp}</span></div>
                    <div class="stat-row"><span class="stat-label">–ë—Ä–æ–Ω—è:</span><span>${atk.armor}</span></div>
                    <div class="stat-row"><span class="stat-label">–£—Ä–æ–Ω:</span><span>${atk.dmg}</span></div>
                    <div class="stat-row"><span class="stat-label">–ë–ª–∏–∂–Ω–∏–π:</span><span>${atk.melee}</span></div>
                    <div class="stat-row"><span class="stat-label">–î–∞–ª—å–Ω–∏–π:</span><span>${atk.ranged}</span></div>
                    <div class="stat-row"><span class="stat-label">Traits:</span><span style="font-size: 0.75em;">${atkTraits.join(', ')}</span></div>
                </div>
                
                <div class="vs-divider">‚öîÔ∏è VS ‚öîÔ∏è</div>
                
                <div class="char-card">
                    <h3>
                        ${def.icon ? `<img src="${def.icon}" class="char-icon">` : ''}
                        üõ°Ô∏è ${def.name}
                    </h3>
                    <div class="stat-row"><span class="stat-label">HP:</span><span>${def.hp}</span></div>
                    <div class="stat-row"><span class="stat-label">–ë—Ä–æ–Ω—è:</span><span>${def.armor}</span></div>
                    <div class="stat-row"><span class="stat-label">–£—Ä–æ–Ω:</span><span>${def.dmg}</span></div>
                    <div class="stat-row"><span class="stat-label">–ë–ª–∏–∂–Ω–∏–π:</span><span>${def.melee}</span></div>
                    <div class="stat-row"><span class="stat-label">–î–∞–ª—å–Ω–∏–π:</span><span>${def.ranged}</span></div>
                    <div class="stat-row"><span class="stat-label">Traits:</span><span style="font-size: 0.75em;">${defTraits.join(', ')}</span></div>
                </div>
                
                <div class="metric-box" style="border-left-color: #00d4ff;">
                    <h4>‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò –†–ï–î–ö–û–°–¢–ò –ò –£–†–û–í–ù–Ø</h4>
                    
                    <div style="margin: 15px 0;">
                        <label style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>üîµ ${atk.name} (–†–µ–¥–∫–æ—Å—Ç—å):</span>
                            <span id="atkRarityLabel" style="color: #00ff88; font-weight: bold;">${atkRarityName}</span>
                        </label>
                        <input type="range" 
                               id="atkRaritySlider" 
                               min="0" max="5" value="${atkRarityValue}" 
                               step="1"
                               style="width: 100%; cursor: pointer;">
                        <div style="display: flex; justify-content: space-between; font-size: 0.7em; color: #888; margin-top: 5px;">
                            <span>Com</span>
                            <span>Unc</span>
                            <span>Rare</span>
                            <span>Epic</span>
                            <span>Leg</span>
                            <span>Myth</span>
                        </div>
                    </div>
                    
                    <div style="margin: 15px 0; padding-top: 10px; border-top: 1px solid #0f1a2e;">
                        <label style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>üîµ ${atk.name} (–£—Ä–æ–≤–µ–Ω—å):</span>
                            <span id="atkLevelLabel" style="color: #00d4ff; font-weight: bold;">${atkLevelValue}</span>
                        </label>
                        <input type="range" 
                               id="atkLevelSlider" 
                               min="1" max="55" value="${atkLevelValue}" 
                               step="1"
                               style="width: 100%; cursor: pointer;">
                        <div style="display: flex; justify-content: space-between; font-size: 0.7em; color: #888; margin-top: 5px;">
                            <span>Lvl 1</span>
                            <span>Lvl 28</span>
                            <span>Lvl 55 (MAX)</span>
                        </div>
                    </div>
                    
                    <div style="margin: 15px 0; padding-top: 10px; border-top: 1px solid #0f1a2e;">
                        <label style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>üî¥ ${def.name} (–†–µ–¥–∫–æ—Å—Ç—å):</span>
                            <span id="defRarityLabel" style="color: #00ff88; font-weight: bold;">${defRarityName}</span>
                        </label>
                        <input type="range" 
                               id="defRaritySlider" 
                               min="0" max="5" value="${defRarityValue}" 
                               step="1"
                               style="width: 100%; cursor: pointer;">
                        <div style="display: flex; justify-content: space-between; font-size: 0.7em; color: #888; margin-top: 5px;">
                            <span>Com</span>
                            <span>Unc</span>
                            <span>Rare</span>
                            <span>Epic</span>
                            <span>Leg</span>
                            <span>Myth</span>
                        </div>
                    </div>
                    
                    <div style="margin: 15px 0; padding-top: 10px; border-top: 1px solid #0f1a2e;">
                        <label style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>üî¥ ${def.name} (–£—Ä–æ–≤–µ–Ω—å):</span>
                            <span id="defLevelLabel" style="color: #00d4ff; font-weight: bold;">${defLevelValue}</span>
                        </label>
                        <input type="range" 
                               id="defLevelSlider" 
                               min="1" max="55" value="${defLevelValue}" 
                               step="1"
                               style="width: 100%; cursor: pointer;">
                        <div style="display: flex; justify-content: space-between; font-size: 0.7em; color: #888; margin-top: 5px;">
                            <span>Lvl 1</span>
                            <span>Lvl 28</span>
                            <span>Lvl 55 (MAX)</span>
                        </div>
                    </div>
                    
                    <div id="rarityStatsDisplay" style="background: #0f1a2e; padding: 12px; border-radius: 5px; margin-top: 15px; font-size: 0.9em;">
                        <div style="text-align: center; color: #888; padding: 20px;">
                            –ó–∞–≥—Ä—É–∑–∫–∞ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫...
                        </div>
                    </div>
                </div>
                
                <div class="metric-box">
                    <h4>‚öîÔ∏è –≠–§–§–ï–ö–¢–ò–í–ù–û–°–¢–¨ –ê–¢–ê–ö–ò</h4>
                    <div class="metric-value" style="background: #${getColorForPct(metrics.attack)}">${metrics.attack}%</div>
                    <p style="font-size: 0.85em; margin-top: 5px; color: #888;">
                        ‚îî‚îÄ –Ø —É–±–∏–≤–∞—é ${def.name} –∑–∞ <strong style="color: #fff;">${metrics.roundsToKill} —Ä–∞—É–Ω–¥–∞</strong><br>
                        ‚îî‚îÄ –£—Ä–æ–Ω –∑–∞ —Ö–æ–¥: ${metrics.totalDmgPerTurn} (${metrics.dmgPerHit} √ó ${atkHits} hits)<br>
                        ‚îî‚îÄ –¢–∏–ø: ${atkType} (${pierce}% pierce)
                    </p>
                </div>
                
                <div class="metric-box">
                    <h4>üõ°Ô∏è –≠–§–§–ï–ö–¢–ò–í–ù–û–°–¢–¨ –ó–ê–©–ò–¢–´</h4>
                    <div class="metric-value" style="background: #${getColorForPct(metrics.defense)}">${metrics.defense}%</div>
                    <p style="font-size: 0.85em; margin-top: 5px; color: #888;">
                        ‚îî‚îÄ ${def.name} —É–±–∏–≤–∞–µ—Ç –º–µ–Ω—è –∑–∞ <strong style="color: #fff;">${metrics.roundsToKillMe} —Ä–∞—É–Ω–¥–∞</strong><br>
                        ‚îî‚îÄ –ú–æ—è –∂–∏–≤—É—á–µ—Å—Ç—å: ${atk.hp} HP / ${atk.armor} armor
                    </p>
                </div>
                
                <div class="trade-indicator ${tradeClass}">
                    ‚öñÔ∏è –ò–¢–û–ì –†–ê–ó–ú–ï–ù–ê<br>
                    <div style="font-size: 0.9em; margin-top: 8px;">
                        ${tradeResult}
                    </div>
                </div>
                
                ${metrics.hasConditionalBonus && metrics.conditionalBonus ? `
                    <div class="metric-box" style="border-left-color: #ffcc00;">
                        <h4>‚ö° –£–°–õ–û–í–ù–´–ô –ë–û–ù–£–°</h4>
                        <div class="conditional-bonus-item">
                            <div style="font-weight: bold; color: #ffcc00; margin-bottom: 5px;">
                                ${metrics.conditionalBonus.name}
                                <span class="bonus-badge">${metrics.conditionalBonus.type}</span>
                            </div>
                            <div style="font-size: 0.85em; color: #ccc; margin: 5px 0;">
                                –£—Å–ª–æ–≤–∏–µ: ${metrics.conditionalBonus.conditionType === 'trait' ? '–¢—Ä–µ–π—Ç' : '–§—Ä–∞–∫—Ü–∏—è'} "${metrics.conditionalBonus.target}" ‚úÖ
                            </div>
                            <div style="font-size: 1.1em; color: #00ff88; margin-top: 8px; font-weight: bold;">
                                –ë–æ–Ω—É—Å: +${Math.round((metrics.conditionalBonus.multiplier - 1) * 100)}% —É—Ä–æ–Ω–∞
                            </div>
                        </div>
                    </div>
                ` : ''}
                
                ${(() => {
                    const atkPassive = getPassiveAbility(atk.name);
                    const defPassive = getPassiveAbility(def.name);
                    
                    let passiveHTML = '';
                    
                    if (atkPassive && atkPassive.type !== 'utility' && atkPassive.type !== 'utility_summon' && atkPassive.type !== 'none' && atkPassive.type !== 'unknown') {
                        passiveHTML += `
                            <div class="metric-box" style="border-left-color: #ffcc00;">
                                <h4>‚ö° –ü–ê–°–°–ò–í–ö–ê –ê–¢–ê–ö–£–Æ–©–ï–ì–û</h4>
                                <div style="background: #0f1a2e; padding: 12px; border-radius: 5px;">
                                    <div style="font-weight: bold; color: #ffcc00; margin-bottom: 8px;">
                                        ${atkPassive.name}
                                    </div>
                                    <div style="font-size: 0.85em; color: #ccc; margin-bottom: 8px;">
                                        ${atkPassive.notes}
                                    </div>
                                    ${atkPassive.damageMult > 1.0 ? `
                                        <div style="color: #00ff88; font-weight: bold;">
                                            ‚úÖ +${Math.round((atkPassive.damageMult - 1) * 100)}% —É—Ä–æ–Ω–∞ (—É—á—Ç–µ–Ω–æ)
                                        </div>
                                    ` : ''}
                                    ${atkPassive.additionalDmg > 0 ? `
                                        <div style="color: #00ff88; font-weight: bold;">
                                            ‚úÖ +${Math.round(atkPassive.additionalDmg)} –¥–æ–ø. —É—Ä–æ–Ω–∞ (—É—á—Ç–µ–Ω–æ)
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    }
                    
                    if (defPassive && defPassive.type !== 'utility' && defPassive.type !== 'utility_summon' && defPassive.type !== 'none' && defPassive.type !== 'unknown') {
                        passiveHTML += `
                            <div class="metric-box" style="border-left-color: #00d4ff;">
                                <h4>üõ°Ô∏è –ü–ê–°–°–ò–í–ö–ê –ó–ê–©–ò–¢–ù–ò–ö–ê</h4>
                                <div style="background: #0f1a2e; padding: 12px; border-radius: 5px;">
                                    <div style="font-weight: bold; color: #00d4ff; margin-bottom: 8px;">
                                        ${defPassive.name}
                                    </div>
                                    <div style="font-size: 0.85em; color: #ccc; margin-bottom: 8px;">
                                        ${defPassive.notes}
                                    </div>
                                    ${defPassive.defenseMult < 1.0 ? `
                                        <div style="color: #00ff88; font-weight: bold;">
                                            ‚úÖ ${Math.round((1 - defPassive.defenseMult) * 100)}% –º–µ–Ω—å—à–µ —É—Ä–æ–Ω–∞ (—É—á—Ç–µ–Ω–æ)
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    }
                    
                    return passiveHTML;
                })()}
            `;
            
            // –ü–æ—Å–ª–µ –≤—Å—Ç–∞–≤–∫–∏ HTML —Å—Ä–∞–∑—É –ø–æ–¥–≤–µ—à–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∑–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
            const atkRaritySlider = document.getElementById('atkRaritySlider');
            const atkLevelSlider = document.getElementById('atkLevelSlider');
            const defRaritySlider = document.getElementById('defRaritySlider');
            const defLevelSlider = document.getElementById('defLevelSlider');
            
            if (atkRaritySlider) {
                atkRaritySlider.addEventListener('input', e => {
                    atkRarityValue = Number(e.target.value);
                    updateMetricsOnly(); // ‚úÖ –ò–ó–ú–ï–ù–ï–ù–û: –ë–ï–ó –†–ï–ö–£–†–°–ò–ò
                });
            }
            
            if (atkLevelSlider) {
                atkLevelSlider.addEventListener('input', e => {
                    atkLevelValue = Number(e.target.value);
                    updateMetricsOnly(); // ‚úÖ –ò–ó–ú–ï–ù–ï–ù–û: –ë–ï–ó –†–ï–ö–£–†–°–ò–ò
                });
            }
            
            if (defRaritySlider) {
                defRaritySlider.addEventListener('input', e => {
                    defRarityValue = Number(e.target.value);
                    updateMetricsOnly(); // ‚úÖ –ò–ó–ú–ï–ù–ï–ù–û: –ë–ï–ó –†–ï–ö–£–†–°–ò–ò
                });
            }
            
            if (defLevelSlider) {
                defLevelSlider.addEventListener('input', e => {
                    defLevelValue = Number(e.target.value);
                    updateMetricsOnly(); // ‚úÖ –ò–ó–ú–ï–ù–ï–ù–û: –ë–ï–ó –†–ï–ö–£–†–°–ò–ò
                });
            }
            
            // ‚úÖ –ò–ó–ú–ï–ù–ï–ù–û: –í–´–ó–´–í–ê–ï–ú updateMetricsOnly –í–ú–ï–°–¢–û updateRarityCalculation
            updateMetricsOnly();
        }

        // ‚úÖ –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø –ë–ï–ó –†–ï–ö–£–†–°–ò–ò
        function updateMetricsOnly() {
            const atkRarityName = RARITY_NAMES[atkRarityValue];
            const defRarityName = RARITY_NAMES[defRarityValue];
            
            document.getElementById('atkRarityLabel').textContent = atkRarityName;
            document.getElementById('defRarityLabel').textContent = defRarityName;
            document.getElementById('atkLevelLabel').textContent = atkLevelValue;
            document.getElementById('defLevelLabel').textContent = defLevelValue;
            
            const atkStats = getCharacterStatsFromData(currentAttacker.name, atkRarityName, atkLevelValue);
            const defStats = getCharacterStatsFromData(currentDefender.name, defRarityName, defLevelValue);
            
            if (!atkStats || !defStats) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫');
                return;
            }
            
            const tempAttacker = {
                ...currentAttacker,
                hp: atkStats.hp,
                armor: atkStats.armor,
                dmg: atkStats.dmg
            };
            
            const tempDefender = {
                ...currentDefender,
                hp: defStats.hp,
                armor: defStats.armor,
                dmg: defStats.dmg
            };
            
            const newMetrics = calculateMatchup(tempAttacker, tempDefender);
            
            // ‚ùó –û–ë–ù–û–í–õ–Ø–ï–ú –¢–û–õ–¨–ö–û HTML –ë–õ–û–ö, –ë–ï–ó renderAnalysisTab
            document.getElementById('rarityStatsDisplay').innerHTML = `
                <div style="text-align: center; color: #00d4ff; font-weight: bold; margin-bottom: 10px;">
                    üìä –¢–ï–ö–£–©–ò–ï –•–ê–†–ê–ö–¢–ï–†–ò–°–¢–ò–ö–ò
                </div>
                <div style="display: flex; justify-content: space-between; margin: 8px 0; padding: 8px; background: rgba(0, 212, 255, 0.1); border-radius: 3px;">
                    <span style="font-weight: 600;">${tempAttacker.name} (${atkRarityName} Lvl ${atkLevelValue}):</span>
                    <span style="color: #00ff88; font-family: monospace;">
                        HP: <strong>${tempAttacker.hp}</strong> | 
                        ARM: <strong>${tempAttacker.armor}</strong> | 
                        DMG: <strong>${tempAttacker.dmg}</strong>
                    </span>
                </div>
                <div style="display: flex; justify-content: space-between; margin: 8px 0; padding: 8px; background: rgba(239, 68, 68, 0.1); border-radius: 3px;">
                    <span style="font-weight: 600;">${tempDefender.name} (${defRarityName} Lvl ${defLevelValue}):</span>
                    <span style="color: #ff6b6b; font-family: monospace;">
                        HP: <strong>${tempDefender.hp}</strong> | 
                        ARM: <strong>${tempDefender.armor}</strong> | 
                        DMG: <strong>${tempDefender.dmg}</strong>
                    </span>
                </div>
                <div style="margin-top: 10px; padding: 8px; background: rgba(0, 255, 136, 0.1); border-radius: 3px; text-align: center; font-size: 0.85em;">
                    ‚öîÔ∏è –£–†–û–ù –ó–ê –•–û–î: ${newMetrics.totalDmgPerTurn} | 
                    üõ°Ô∏è –†–ê–£–ù–î–û–í –î–û –ü–û–ë–ï–î–´: ${newMetrics.roundsToKill}
                </div>
            `;
        }

        function renderSynergyTab(attacker) {
            const synergies = synergyDatabase[attacker.name] || [];
            
            if (synergies.length === 0) {
                document.getElementById('synergyTab').innerHTML = `
                    <div class="panel-title">ü§ù –°–ò–ù–ï–†–ì–ò–Ø</div>
                    <div style="background: #0f1a2e; padding: 15px; border-radius: 8px; text-align: center;">
                        <p style="color: #888;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å–∏–Ω–µ—Ä–≥–∏—è—Ö –¥–ª—è ${attacker.name}</p>
                    </div>
                `;
                return;
            }
            
            let html = `<div class="panel-title">ü§ù –°–ò–ù–ï–†–ì–ò–Ø</div>`;
            
            synergies.forEach((syn, idx) => {
                const partners = syn.partners || [];
                const partnersList = Array.isArray(partners) 
                    ? partners.map(p => `<span class="partner-badge">${p}</span>`).join('')
                    : '';
                
                const shortDesc = syn.effect || syn.best_with || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è';
                const fullDesc = `
                    <strong>–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:</strong> ${syn.effect || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}<br>
                    <strong>–õ—É—á—à–µ –≤—Å–µ–≥–æ —Å:</strong> ${syn.best_with || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}<br>
                    ${syn.positioning ? `<strong>–ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:</strong> ${syn.positioning}<br>` : ''}
                    ${syn.notes ? `<strong>–ü—Ä–∏–º–µ—á–∞–Ω–∏—è:</strong> ${syn.notes}<br>` : ''}
                    ${syn.passive_buffs ? `<strong>–ü–∞—Å—Å–∏–≤–Ω—ã–µ –±–∞—Ñ—Ñ—ã:</strong> ${syn.passive_buffs}<br>` : ''}
                    ${syn.strategy ? `<strong>–°—Ç—Ä–∞—Ç–µ–≥–∏—è:</strong> ${syn.strategy}<br>` : ''}
                    ${syn.active ? `<strong>–ê–∫—Ç–∏–≤–Ω–∞—è:</strong> ${syn.active}<br>` : ''}
                    <small style="color: #666;">–ò—Å—Ç–æ—á–Ω–∏–∫: ${syn.source || 'unknown'}</small>
                `;
                
                html += `
                    <div class="synergy-item">
                        <div style="font-weight: bold; color: #00ff88; margin-bottom: 5px;">
                            ${getTypeIcon(syn.type)} ${formatType(syn.type)}
                        </div>
                        <div style="font-size: 0.9em; margin-bottom: 5px;">${shortDesc}</div>
                        ${partnersList ? `<div style="margin-top: 8px;">${partnersList}</div>` : ''}
                        <button class="expand-btn" onclick="toggleDetail('syn${idx}')">üìñ –ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
                        <div class="detail-text" id="syn${idx}">${fullDesc}</div>
                    </div>
                `;
            });
            
            document.getElementById('synergyTab').innerHTML = html;
        }

        function renderCountersTab(defender) {
            const counters = counterDatabase[defender.name] || [];
            
            if (counters.length === 0) {
                document.getElementById('countersTab').innerHTML = `
                    <div class="panel-title">‚ö†Ô∏è –ö–û–ù–¢–†–´</div>
                    <div style="background: #0f1a2e; padding: 15px; border-radius: 8px;">
                        <div class="synergy-item" style="border-left-color: #00ff88;">
                            ‚úÖ –ù–µ—Ç —è–≤–Ω—ã—Ö —Å–ª–∞–±–æ—Å—Ç–µ–π —É ${defender.name}
                        </div>
                    </div>
                `;
                return;
            }
            
            let html = `<div class="panel-title">‚ö†Ô∏è –ö–û–ù–¢–†–´</div>`;
            
            counters.forEach((counter, idx) => {
                const counterTypes = counter.counter_types || [];
                const typesList = counterTypes.map(t => `<span class="partner-badge" style="border-color: #fbbf24;">${t}</span>`).join('');
                
                const shortDesc = counter.weakness || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è';
                const fullDesc = `
                    <strong>–°–ª–∞–±–æ—Å—Ç—å:</strong> ${counter.weakness || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}<br>
                    <strong>–¢–∏–ø—ã –∫–æ–Ω—Ç—Ä–æ–≤:</strong> ${counterTypes.join(', ') || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}<br>
                    ${counter.counter_trait ? `<strong>–ö–æ–Ω—Ç—Ä—è—â–∏–π —Ç—Ä–µ–π—Ç:</strong> ${counter.counter_trait}<br>` : ''}
                    ${counter.reason ? `<strong>–ü—Ä–∏—á–∏–Ω–∞:</strong> ${counter.reason}<br>` : ''}
                    <strong>–ö–∞–∫ –∫–æ–Ω—Ç—Ä–∏—Ç—å:</strong> ${getCounterStrategy(counter)}<br>
                    <small style="color: #666;">–ò—Å—Ç–æ—á–Ω–∏–∫: ${counter.source || 'unknown'} | –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${counter.confidence || 'medium'}</small>
                `;
                
                html += `
                    <div class="synergy-item" style="border-left-color: #fbbf24;">
                        <div style="font-weight: bold; color: #fbbf24; margin-bottom: 5px;">
                            ${getReasonIcon(counter.reason)} ${formatReason(counter.reason)}
                        </div>
                        <div style="font-size: 0.9em; margin-bottom: 5px;">${shortDesc}</div>
                        ${typesList ? `<div style="margin-top: 8px;">${typesList}</div>` : ''}
                        <button class="expand-btn" onclick="toggleDetail('cnt${idx}')">üìñ –ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
                        <div class="detail-text" id="cnt${idx}">${fullDesc}</div>
                    </div>
                `;
            });
            
            document.getElementById('countersTab').innerHTML = html;
        }
        
        function toggleDetail(id) {
            const element = document.getElementById(id);
            element.classList.toggle('expanded');
        }
        
        function getTypeIcon(type) {
            const icons = {
                'faction_buff': 'üèõÔ∏è',
                'damage_amplifier': 'üí•',
                'multi_hit_team': '‚öîÔ∏è‚öîÔ∏è',
                'multi_hit_damage': 'üó°Ô∏è',
                'suppress_counter': 'üö´',
                'ranged_multi_hit': 'üèπ',
                'summon_warrior': 'üëª',
                'necron_synergy': 'üíÄ',
                'mech_healer': 'üîß',
                'admech_core': '‚öôÔ∏è',
                'reactivate_ability': 'üîÑ',
                'markerlight': 'üéØ',
                'psychic_master': 'üß†',
                'multi_hit_buffer': 'üí™',
                'multi_hit_core': '‚öîÔ∏è',
                'multi_hit_meta': 'üëë',
                'damage_stat_buffer': 'üìà',
                'guardsmen_summoner': 'ü™ñ',
                'resurrect_tank': '‚ôªÔ∏è',
                'passive_healer': 'üíö',
                'admech_reactivator': 'ü§ñ'
            };
            return icons[type] || 'ü§ù';
        }
        
        function formatType(type) {
            return type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }
        
        function getReasonIcon(reason) {
            const icons = {
                'slow_ramp': 'üêå',
                'positioning_dependent': 'üìç',
                'low_defense': '‚ù§Ô∏è',
                'niche_utility': 'üéØ',
                'positioning_squishy': 'üíî',
                'overwatch_counterable': 'üëÅÔ∏è',
                'mech_only': '‚öôÔ∏è',
                'tau_dependent': 'üîµ',
                'positioning_difficult': 'üìê',
                'psychic_resistance': 'üß†',
                'delayed_summon': '‚è±Ô∏è',
                'setup_dependent': 'üîß',
                'can_be_surrounded': '‚≠ï',
                'passive_only_non_lethal': 'üíî',
                'anti_summon': 'üö´üëª',
                'anti_tank_weapons': 'üî´',
                'anti_nurgle': '‚ò†Ô∏è'
            };
            return icons[reason] || '‚ö†Ô∏è';
        }
        
        function formatReason(reason) {
            return reason.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }
        
        function getCounterStrategy(counter) {
            if (counter.counter_types) {
                return `–ò—Å–ø–æ–ª—å–∑—É–π ${counter.counter_types.join(' –∏–ª–∏ ')} –ø—Ä–æ—Ç–∏–≤ —ç—Ç–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞`;
            }
            return '–ê—Ç–∞–∫—É–π —Å–ª–∞–±—ã–µ –º–µ—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ';
        }

        function getColorForPct(pct) {
            if (pct >= 90) return '00ff00';
            if (pct >= 70) return '4ade80';
            if (pct >= 50) return 'fbbf24';
            if (pct >= 30) return 'fb923c';
            return 'ef4444';
        }

        const RARITY_NAMES = ['Common', 'Uncommon', 'Rare', 'Epic', 'Legendary', 'Mythic'];

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ä–µ–∞–ª—å–Ω—ã—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ –∏–∑ data.json
        function getCharacterStatsFromData(characterName, rarityName, level) {
            const character = characters.find(c => c.name === characterName);
            if (!character) {
                return null;
            }

            // –ë–∞–∑–æ–≤—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∏–∑ baseStats (fallback –µ—Å–ª–∏ –Ω–µ—Ç —Ç–∞–±–ª–∏—Ü)
            const baseStats = {
                hp: parseInt(character.baseStats?.health || character.hp || 100),
                armor: parseInt(character.baseStats?.armour || character.armor || 10),
                dmg: parseInt(character.baseStats?.damage || character.dmg || 15)
            };

            // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã –∏–∑ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏ –ø–∞—Å—Å–∏–≤–Ω—ã—Ö —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–µ–π
            const allTables = [
                ...(character.activeAbility?.tables || []),
                ...(character.passiveAbility?.tables || [])
            ];

            // –ï—Å–ª–∏ –Ω–µ—Ç —Ç–∞–±–ª–∏—Ü —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–µ–π, –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–∞–∑–æ–≤—ã–µ —Å—Ç–∞—Ç—ã –ë–ï–ó –º–Ω–æ–∂–∏—Ç–µ–ª–µ–π
            if (allTables.length === 0) {
                return baseStats;
            }

            // –ò—â–µ–º —Ç–∞–±–ª–∏—Ü—É —Å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–π –∫–æ–ª–æ–Ω–∫–æ–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ (Health, Armour, Damage)
            let targetTable = null;
            for (let i = 0; i < allTables.length; i++) {
                const table = allTables[i];
                const headers = table[0];
                const hasHealth = headers.some(h => h.includes('Health') || h.includes('HP'));
                const hasArmour = headers.some(h => h.includes('Armour') || h.includes('Armor'));
                const hasDamage = headers.some(h => h.includes('Damage') && !h.includes('Piercing') && !h.includes('3x'));
                
                if (hasHealth || hasArmour || hasDamage) {
                    targetTable = table;
                    break;
                }
            }

            // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –ø–æ–¥—Ö–æ–¥—è—â—É—é —Ç–∞–±–ª–∏—Ü—É, –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–∞–∑–æ–≤—ã–µ —Å—Ç–∞—Ç—ã
            if (!targetTable) {
                return baseStats;
            }

            const tableHeaders = targetTable[0];
            
            // –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å—ã –Ω—É–∂–Ω—ã—Ö –∫–æ–ª–æ–Ω–æ–∫
            const rarityIndex = tableHeaders.indexOf('Rarity');
            const levelIndex = tableHeaders.indexOf('Level');
            const healthIndex = tableHeaders.findIndex(h => h.includes('Health') || h.includes('HP'));
            const armourIndex = tableHeaders.findIndex(h => h.includes('Armour') || h.includes('Armor'));
            const damageIndex = tableHeaders.findIndex(h => 
                h.includes('Damage') && !h.includes('Piercing') && !h.includes('3x')
            );
            
            // –ò—â–µ–º —Å—Ç—Ä–æ–∫—É —Å –Ω—É–∂–Ω–æ–π —Ä–µ–¥–∫–æ—Å—Ç—å—é
            let targetRow = null;
            let nextRow = null;
            
            for (let i = 1; i < targetTable.length; i++) {
                const row = targetTable[i];
                if (row[rarityIndex] === rarityName) {
                    targetRow = row;
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–ª–µ–¥—É—é—â—É—é —Å—Ç—Ä–æ–∫—É –¥–ª—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–∏
                    if (i + 1 < targetTable.length) {
                        nextRow = targetTable[i + 1];
                    }
                    break;
                }
            }

            // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ —Ç–æ—á–Ω—É—é —Ä–µ–¥–∫–æ—Å—Ç—å, –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–∞–∑–æ–≤—ã–µ —Å—Ç–∞—Ç—ã
            if (!targetRow) {
                return baseStats;
            }

            // –ò–∑–≤–ª–µ–∫–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
            const tableLevel = parseInt(targetRow[levelIndex]);
            let hp = baseStats.hp;
            let armor = baseStats.armor;
            let dmg = baseStats.dmg;
            
            // –ò–∑–≤–ª–µ–∫–∞–µ–º HP –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
            if (healthIndex !== -1) {
                const hpValue = targetRow[healthIndex];
                if (hpValue && typeof hpValue === 'string' && hpValue.includes('-')) {
                    // –ï—Å–ª–∏ –¥–∏–∞–ø–∞–∑–æ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä "30-37"), –±–µ—Ä–µ–º —Å—Ä–µ–¥–Ω–µ–µ
                    const [min, max] = hpValue.split('-').map(v => parseInt(v.trim()));
                    hp = Math.round((min + max) / 2);
                } else if (hpValue && !isNaN(parseInt(hpValue))) {
                    hp = parseInt(hpValue);
                }
            }
            
            // –ò–∑–≤–ª–µ–∫–∞–µ–º Armour –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
            if (armourIndex !== -1) {
                const armorValue = targetRow[armourIndex];
                if (armorValue && typeof armorValue === 'string' && armorValue.includes('-')) {
                    const [min, max] = armorValue.split('-').map(v => parseInt(v.trim()));
                    armor = Math.round((min + max) / 2);
                } else if (armorValue && !isNaN(parseInt(armorValue))) {
                    armor = parseInt(armorValue);
                }
            }
            
            // –ò–∑–≤–ª–µ–∫–∞–µ–º Damage –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
            if (damageIndex !== -1) {
                const dmgValue = targetRow[damageIndex];
                if (dmgValue && typeof dmgValue === 'string' && dmgValue.includes('-')) {
                    const [min, max] = dmgValue.split('-').map(v => parseInt(v.trim()));
                    dmg = Math.round((min + max) / 2);
                } else if (dmgValue && !isNaN(parseInt(dmgValue))) {
                    dmg = parseInt(dmgValue);
                }
            }
            
            // –ò–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è –º–µ–∂–¥—É —É—Ä–æ–≤–Ω—è–º–∏, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            if (level !== tableLevel && nextRow) {
                const nextLevel = parseInt(nextRow[levelIndex]);
                
                // –ò–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è –¥–ª—è HP
                if (healthIndex !== -1) {
                    const nextHpValue = nextRow[healthIndex];
                    let nextHp = hp;
                    if (nextHpValue && typeof nextHpValue === 'string' && nextHpValue.includes('-')) {
                        const [min, max] = nextHpValue.split('-').map(v => parseInt(v.trim()));
                        nextHp = Math.round((min + max) / 2);
                    } else if (nextHpValue && !isNaN(parseInt(nextHpValue))) {
                        nextHp = parseInt(nextHpValue);
                    }
                    
                    if (level > tableLevel && level <= nextLevel) {
                        const progress = (level - tableLevel) / (nextLevel - tableLevel);
                        hp = Math.round(hp + (nextHp - hp) * progress);
                    }
                }
                
                // –ò–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è –¥–ª—è Armour
                if (armourIndex !== -1) {
                    const nextArmorValue = nextRow[armourIndex];
                    let nextArmor = armor;
                    if (nextArmorValue && typeof nextArmorValue === 'string' && nextArmorValue.includes('-')) {
                        const [min, max] = nextArmorValue.split('-').map(v => parseInt(v.trim()));
                        nextArmor = Math.round((min + max) / 2);
                    } else if (nextArmorValue && !isNaN(parseInt(nextArmorValue))) {
                        nextArmor = parseInt(nextArmorValue);
                    }
                    
                    if (level > tableLevel && level <= nextLevel) {
                        const progress = (level - tableLevel) / (nextLevel - tableLevel);
                        armor = Math.round(armor + (nextArmor - armor) * progress);
                    }
                }
                
                // –ò–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è –¥–ª—è Damage
                if (damageIndex !== -1) {
                    const nextDmgValue = nextRow[damageIndex];
                    let nextDmg = dmg;
                    if (nextDmgValue && typeof nextDmgValue === 'string' && nextDmgValue.includes('-')) {
                        const [min, max] = nextDmgValue.split('-').map(v => parseInt(v.trim()));
                        nextDmg = Math.round((min + max) / 2);
                    } else if (nextDmgValue && !isNaN(parseInt(nextDmgValue))) {
                        nextDmg = parseInt(nextDmgValue);
                    }
                    
                    if (level > tableLevel && level <= nextLevel) {
                        const progress = (level - tableLevel) / (nextLevel - tableLevel);
                        dmg = Math.round(dmg + (nextDmg - dmg) * progress);
                    }
                }
            }
            
            return { hp, armor, dmg };
        }

        document.getElementById('attackerFilter').addEventListener('change', renderTable);
        document.getElementById('defenderFilter').addEventListener('change', renderTable);
        document.getElementById('factionFilter').addEventListener('change', renderTable);
        document.getElementById('traitFilter').addEventListener('change', renderTable);
        document.getElementById('damageTypeFilter').addEventListener('change', renderTable);
        document.getElementById('sortOrder').addEventListener('change', renderTable);
        document.getElementById('limitSelect').addEventListener('change', (e) => {
            currentLimit = parseInt(e.target.value);
            renderTable();
        });
    </script>
</body>
</html>