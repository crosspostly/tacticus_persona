<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tacticus Matchup Analyzer - 100 Characters</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a2e;
            color: #e4e4e4;
            padding: 20px;
        }
        .container { max-width: 1900px; margin: 0 auto; }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #00d4ff;
            font-size: 2.5em;
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        }
        
        /* üéØ –ò–ö–û–ù–ö–ê –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò –í –ü–†–ê–í–û–ú –í–ï–†–•–ù–ï–ú –£–ì–õ–£ */
        .sync-icon {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 48px;
            height: 48px;
            background: #00ff88;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0, 255, 136, 0.4);
            transition: all 0.3s;
            font-size: 1.5em;
        }
        .sync-icon:hover {
            background: #00d4ff;
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 212, 255, 0.6);
        }
        .sync-icon.loading {
            animation: rotate 1s linear infinite;
        }
        .sync-icon.success {
            background: #00ff88;
        }
        .sync-icon.error {
            background: #ef4444;
        }
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .sync-tooltip {
            position: fixed;
            top: 75px;
            right: 20px;
            background: #16213e;
            padding: 10px 15px;
            border-radius: 8px;
            border: 2px solid #00d4ff;
            font-size: 0.75em;
            max-width: 250px;
            z-index: 999;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            display: none;
        }
        .sync-tooltip.show {
            display: block;
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: #00d4ff;
            font-size: 1.5em;
            font-weight: bold;
        }
        .loading-overlay.hidden {
            display: none;
        }
        
        /* üéöÔ∏è –ú–û–î–ò–§–ò–ö–ê–¢–û–†–´ */
        .modifiers {
            background: #16213e;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        .modifier-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px 15px;
            background: #0f1a2e;
            border-radius: 5px;
            transition: all 0.3s;
        }
        .modifier-toggle:hover {
            background: #1a2a3e;
        }
        .modifier-toggle input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        .modifier-toggle label {
            cursor: pointer;
            font-size: 0.9em;
        }
        
        .filters {
            background: #16213e;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        .filter-group { display: flex; flex-direction: column; gap: 8px; }
        .filter-group label { color: #00d4ff; font-weight: bold; font-size: 0.9em; }
        select {
            padding: 10px;
            background: #0f1a2e;
            color: #e4e4e4;
            border: 2px solid #00d4ff;
            border-radius: 5px;
            font-size: 0.95em;
            cursor: pointer;
        }
        .limit-group {
            grid-column: span 3;
            display: flex;
            align-items: center;
            gap: 15px;
            justify-content: center;
            padding-top: 10px;
            border-top: 2px solid #0f1a2e;
        }
        .legend {
            background: #16213e;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        .legend-item { display: flex; align-items: center; gap: 8px; }
        .legend-color { width: 30px; height: 20px; border-radius: 3px; }
        .dominate { background: #00ff00; }
        .advantage { background: #4ade80; }
        .balanced { background: #fbbf24; }
        .disadvantage { background: #fb923c; }
        .dominated { background: #ef4444; }
        .matrix-container {
            background: #16213e;
            padding: 20px;
            border-radius: 10px;
            overflow: auto;
            max-height: 70vh;
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            font-size: 0.75em; 
        }
        th, td {
            padding: 8px 4px;
            text-align: center;
            border: 1px solid #0f1a2e;
            min-width: 85px;
        }
        th {
            background: #0f1a2e;
            color: #00d4ff;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        th:first-child, td:first-child {
            position: sticky;
            left: 0;
            background: #0f1a2e;
            font-weight: bold;
            z-index: 5;
            min-width: 140px;
            text-align: left;
            padding-left: 10px;
        }
        th:first-child { z-index: 15; }
        td { cursor: pointer; transition: all 0.2s; position: relative; }
        td:hover {
            transform: scale(1.05);
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
            z-index: 100;
        }
        .cell-dominate { background: #00ff00; color: #000; font-weight: bold; }
        .cell-advantage { background: #4ade80; color: #000; }
        .cell-balanced { background: #fbbf24; color: #000; }
        .cell-disadvantage { background: #fb923c; color: #fff; }
        .cell-dominated { background: #ef4444; color: #fff; }
        
        .detail-panel {
            position: fixed;
            right: -550px;
            top: 0;
            width: 520px;
            height: 100vh;
            background: #16213e;
            box-shadow: -5px 0 20px rgba(0, 0, 0, 0.7);
            padding: 30px;
            overflow-y: auto;
            transition: right 0.3s ease;
            z-index: 1000;
        }
        .detail-panel.active { right: 0; }
        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #ef4444;
            color: #fff;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 1.5em;
            cursor: pointer;
            line-height: 0;
        }
        .close-btn:hover { background: #dc2626; }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #0f1a2e;
        }
        .tab {
            padding: 10px 20px;
            background: #0f1a2e;
            border: none;
            color: #e4e4e4;
            cursor: pointer;
            border-radius: 5px 5px 0 0;
            font-weight: bold;
        }
        .tab.active {
            background: #00d4ff;
            color: #1a1a2e;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        .panel-title {
            font-size: 1.6em;
            color: #00d4ff;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }
        .char-card {
            background: #0f1a2e;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .char-card h3 { 
            color: #00ff88; 
            margin-bottom: 10px; 
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .char-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #00d4ff;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #1a1a2e;
            font-size: 0.9em;
        }
        .stat-label { color: #00d4ff; font-weight: bold; }
        .vs-divider {
            text-align: center;
            font-size: 2em;
            color: #ff6b6b;
            margin: 15px 0;
            font-weight: bold;
        }
        .metric-box {
            background: #1a1a2e;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #00d4ff;
        }
        .metric-box h4 { color: #00d4ff; margin-bottom: 8px; font-size: 1em; }
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            text-align: center;
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
        }
        .trade-indicator {
            background: #0f1a2e;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 2px solid;
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
        }
        .trade-indicator.dominate {
            border-color: #00ff00;
            color: #00ff00;
        }
        .trade-indicator.advantage {
            border-color: #4ade80;
            color: #4ade80;
        }
        .trade-indicator.balanced {
            border-color: #fbbf24;
            color: #fbbf24;
        }
        .trade-indicator.disadvantage {
            border-color: #fb923c;
            color: #fb923c;
        }
        .trade-indicator.dominated {
            border-color: #ef4444;
            color: #ef4444;
        }
        .synergy-list {
            list-style: none;
            padding: 0;
        }
        .synergy-item {
            background: #1a1a2e;
            padding: 12px;
            margin: 8px 0;
            border-radius: 5px;
            border-left: 3px solid #00ff88;
        }
        .partner-badge {
            display: inline-block;
            background: #0f1a2e;
            padding: 5px 10px;
            border-radius: 15px;
            margin: 3px;
            font-size: 0.85em;
            border: 1px solid #00d4ff;
        }
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: #00d4ff;
        }
        .tooltip {
            position: absolute;
            background: #0f1a2e;
            border: 2px solid #00d4ff;
            border-radius: 8px;
            padding: 15px;
            display: none;
            z-index: 999;
            max-width: 320px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
            transition: all 0.2s ease;
        }
        @media (max-width: 768px) {
            .tooltip {
                max-width: 280px;
                font-size: 0.9em;
            }
            .tooltip img {
                width: 60px;
                height: 60px;
            }
        }
        .tooltip.active { 
            display: block; 
            animation: tooltipFadeIn 0.2s ease;
        }
        @keyframes tooltipFadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .tooltip img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-bottom: 10px;
            border: 2px solid #00d4ff;
            box-shadow: 0 2px 10px rgba(0, 212, 255, 0.3);
            object-fit: cover;
            background: #16213e;
        }
        .tooltip .char-name {
            font-weight: bold;
            color: #00d4ff;
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        .tooltip .char-stats {
            font-size: 0.85em;
            line-height: 1.4;
        }
        .tooltip .stat-row {
            display: flex;
            justify-content: space-between;
            margin: 2px 0;
        }
        .tooltip .stat-label {
            color: #888;
        }
        .tooltip .stat-value {
            color: #fff;
            font-weight: bold;
        }
        
        .bonus-icon {
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 0.75em;
            color: #ffcc00;
            animation: bonusPulse 1.5s infinite;
        }

        @keyframes bonusPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.2); }
        }

        .conditional-bonus-item {
            background: linear-gradient(135deg, rgba(255, 204, 0, 0.15), rgba(0, 212, 255, 0.1));
            padding: 10px;
            margin: 8px 0;
            border-radius: 6px;
            border: 2px solid #ffcc00;
        }

        .bonus-badge {
            display: inline-block;
            background: #ffcc00;
            color: #1a1a2e;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7em;
            font-weight: bold;
            margin-left: 5px;
        }
        
        /* üìñ –†–ê–°–ö–†–´–¢–ò–ï –î–ï–¢–ê–õ–ï–ô */
        .expand-btn {
            background: #0f1a2e;
            border: 1px solid #00d4ff;
            color: #00d4ff;
            padding: 5px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
            margin-top: 8px;
            transition: all 0.2s;
        }
        .expand-btn:hover {
            background: #00d4ff;
            color: #1a1a2e;
        }
        .detail-text {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            font-size: 0.85em;
            color: #ccc;
            margin-top: 8px;
            line-height: 1.5;
        }
        .detail-text.expanded {
            max-height: 500px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚öîÔ∏è Warhammer 40K: Tacticus - Matchup Analyzer</h1>
        
        <!-- üéØ –ò–ö–û–ù–ö–ê –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò -->
        <div class="sync-icon" id="syncIcon" onclick="syncAllData()" title="–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö">
            üîÑ
        </div>
        <div class="sync-tooltip" id="syncTooltip"></div>
        
        <!-- üéöÔ∏è –ú–û–î–ò–§–ò–ö–ê–¢–û–†–´ -->
        <div class="modifiers">
            <div class="modifier-toggle">
                <input type="checkbox" id="modTerrain" onchange="recalculateAll()">
                <label for="modTerrain">üèîÔ∏è Terrain (+50% dmg)</label>
            </div>
            <div class="modifier-toggle">
                <input type="checkbox" id="modHighGround" onchange="recalculateAll()">
                <label for="modHighGround">‚¨ÜÔ∏è High Ground (+50% dmg)</label>
            </div>
            <div class="modifier-toggle">
                <input type="checkbox" id="modCrit" onchange="recalculateAll()">
                <label for="modCrit">üí• Crit Chance (avg +10% dmg)</label>
            </div>
            <div class="modifier-toggle">
                <input type="checkbox" id="modRazor" onchange="recalculateAll()">
                <label for="modRazor">üî™ Razor Wire (+50% dmg taken)</label>
            </div>
        </div>
        
        <div class="filters">
            <div class="filter-group">
                <label>üéØ –°–û–†–¢–ò–†–û–í–ö–ê</label>
                <select id="sortOrder">
                    <option value="alpha">–ê–ª—Ñ–∞–≤–∏—Ç (A-Z)</option>
                    <option value="hp">–ü–æ HP (–±–æ–ª—å—à–µ ‚Üí –º–µ–Ω—å—à–µ)</option>
                    <option value="armor">–ü–æ –±—Ä–æ–Ω–µ (–±–æ–ª—å—à–µ ‚Üí –º–µ–Ω—å—à–µ)</option>
                    <option value="damage">–ü–æ —É—Ä–æ–Ω—É (–±–æ–ª—å—à–µ ‚Üí –º–µ–Ω—å—à–µ)</option>
                </select>
            </div>

            <div class="filter-group">
                <label>üè∞ –§–†–ê–ö–¶–ò–Ø</label>
                <select id="factionFilter">
                    <option value="">–í—Å–µ —Ñ—Ä–∞–∫—Ü–∏–∏</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>‚ú® –¢–†–ï–ô–¢</label>
                <select id="traitFilter">
                    <option value="">–í—Å–µ —Ç—Ä–µ–π—Ç—ã</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>üó°Ô∏è –§–ò–õ–¨–¢–† –ê–¢–ê–ö–£–Æ–©–ò–•</label>
                <select id="attackerFilter">
                    <option value="">–í—Å–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>üõ°Ô∏è –§–ò–õ–¨–¢–† –ó–ê–©–ò–©–ê–Æ–©–ò–•–°–Ø</label>
                <select id="defenderFilter">
                    <option value="">–í—Å–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏</option>
                </select>
            </div>

            <div class="filter-group">
                <label>‚ö° –¢–ò–ü –£–†–û–ù–ê</label>
                <select id="damageTypeFilter">
                    <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
                    <option value="melee">–¢–æ–ª—å–∫–æ Melee</option>
                    <option value="ranged">–¢–æ–ª—å–∫–æ Ranged</option>
                    <option value="both">–û–±–∞ —Ç–∏–ø–∞</option>
                </select>
            </div>
            
            <div class="limit-group">
                <label>üìä –ü–û–ö–ê–ó–ê–¢–¨ –ü–ï–†–í–´–•</label>
                <select id="limitSelect">
                    <option value="20">20 –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π</option>
                    <option value="30">30 –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π</option>
                    <option value="50" selected>50 –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π</option>
                    <option value="100">–í—Å–µ (100)</option>
                </select>
            </div>
        </div>

        <div class="legend">
            <div class="legend-item"><div class="legend-color dominate"></div><span>–î–æ–º–∏–Ω–∏—Ä—É—é (2x –±—ã—Å—Ç—Ä–µ–µ)</span></div>
            <div class="legend-item"><div class="legend-color advantage"></div><span>–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ (1.5x)</span></div>
            <div class="legend-item"><div class="legend-color balanced"></div><span>–ë–∞–ª–∞–Ω—Å (¬±30%)</span></div>
            <div class="legend-item"><div class="legend-color disadvantage"></div><span>–ù–µ–¥–æ—Å—Ç–∞—Ç–æ–∫ (1.5x –º–µ–¥–ª–µ–Ω–Ω–µ–µ)</span></div>
            <div class="legend-item"><div class="legend-color dominated"></div><span>–î–æ–º–∏–Ω–∏—Ä—É—é—Ç (2x –º–µ–¥–ª–µ–Ω–Ω–µ–µ)</span></div>
        </div>

        <div class="matrix-container">
            <div id="loading" class="loading">
                –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...
            </div>
            <table id="matchupTable" style="display: none;">
                <thead id="tableHead"></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <div class="detail-panel" id="detailPanel">
        <button class="close-btn" onclick="closeDetail()">√ó</button>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('analysis')">üìä –ê–Ω–∞–ª–∏–∑</button>
            <button class="tab" onclick="switchTab('synergy')">ü§ù –°–∏–Ω–µ—Ä–≥–∏—è</button>
            <button class="tab" onclick="switchTab('counters')">‚ö†Ô∏è –ö–æ–Ω—Ç—Ä—ã</button>
        </div>
        
        <div id="detailContent">
            <div id="analysisTab" class="tab-content active"></div>
            <div id="synergyTab" class="tab-content"></div>
            <div id="countersTab" class="tab-content"></div>
        </div>
    </div>
    
    <div class="tooltip" id="tooltip"></div>
    
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div>
            <div>‚öîÔ∏è –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö...</div>
            <div style="font-size: 0.7em; margin-top: 10px;">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ</div>
        </div>
    </div>

    <script>
        const PIERCE_RATIOS = {
            'Psychic': 100, 'Direct': 100, 'Piercing': 80, 'Melta': 75,
            'Plasma': 65, 'Eviscerating': 50, 'Power': 40, 'Flame': 30,
            'Energy': 30, 'Bolter': 20, 'Chain': 20, 'Pulse': 20,
            'Blast': 15, 'Heavy Round': 15, 'Bio': 15, 'Molecular': 15,
            'Particle': 15, 'Toxic': 15, 'Las': 10, 'Projectile': 5,
            'Physical': 1
        };
        
        const MACHINES_OF_WAR = [
            'Biovore', 'Exorcist', 'Forgefiend', 'Galatian',
            'Malleus Rocket Launcher', 'Plagueburst Crawler',
            'Rukkatrukk', "Tson'ji"
        ];

        let traitsDB = [];
        let characterTraitsDB = [];
        let conditionalBonusesDB = [];
        let characterFactionsDB = [];
        let characterAttackTypesDB = [];
        let passiveAbilitiesDB = [];
        let characters = [];
        let matchupMatrix = {};
        let synergyDatabase = {};
        let counterDatabase = {};
        let currentLimit = 50;
        let currentAttacker = null;
        let currentDefender = null;

        window.addEventListener('load', function() {
            syncAllData();
        });

        async function syncAllData() {
            const syncIcon = document.getElementById('syncIcon');
            const syncTooltip = document.getElementById('syncTooltip');
            const loadingOverlay = document.getElementById('loadingOverlay');
            
            syncIcon.classList.add('loading');
            syncTooltip.textContent = 'üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...';
            syncTooltip.classList.add('show');
            loadingOverlay.classList.remove('hidden');
            
            try {
                let mainData = null;
                let dataSource = '';
                
                try {
                    const txtResponse = await fetch('data.json');
                    if (txtResponse.ok) {
                        const txtContent = await txtResponse.text();
                        mainData = JSON.parse(txtContent);
                        dataSource = 'data.json';
                    }
                } catch (e) {
                    console.log('data.json not found, trying data.json...');
                }
                
                if (!mainData) {
                    const jsonResponse = await fetch('data.json');
                    if (!jsonResponse.ok) throw new Error('–§–∞–π–ª—ã –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
                    mainData = await jsonResponse.json();
                    dataSource = 'data.json';
                }
                
                let dataArray = mainData;
                if (mainData.characters && Array.isArray(mainData.characters)) {
                    dataArray = mainData.characters;
                } else if (!Array.isArray(mainData)) {
                    throw new Error('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö');
                }
                
                const [synergyResponse, counterResponse, enhancedSynergyResponse, enhancedCounterResponse] = await Promise.all([
                    fetch('synergy_database.json').catch(() => null),
                    fetch('counter_database.json').catch(() => null),
                    fetch('enhanced_synergy_database.json').catch(() => null),
                    fetch('enhanced_counter_database.json').catch(() => null)
                ]);
                
                if (synergyResponse?.ok) {
                    synergyDatabase = await synergyResponse.json();
                }
                
                if (enhancedSynergyResponse?.ok) {
                    const enhancedData = await enhancedSynergyResponse.json();
                    synergyDatabase = {...synergyDatabase, ...enhancedData};
                }
                
                if (counterResponse?.ok) {
                    counterDatabase = await counterResponse.json();
                }
                
                if (enhancedCounterResponse?.ok) {
                    const enhancedData = await enhancedCounterResponse.json();
                    counterDatabase = {...counterDatabase, ...enhancedData};
                }
                
                await loadConditionalDatabases();
                
                const filtered = dataArray.filter(c => isCharacter(c) && !MACHINES_OF_WAR.includes(c.name));
                
                characters = filtered.map((c, i) => {
                    // Extract rarity data from activeAbility tables if available
                    const rarities = {};
                    if (c.activeAbility && c.activeAbility.tables) {
                        const tables = c.activeAbility.tables;
                        if (tables && tables.length >= 2) {
                            const headers = tables[0];
                            const statsTable = tables[1];
                            if (headers && headers[0] && statsTable) {
                                const rarityIndex = headers[0].indexOf('Rarity');
                                const healthIndex = headers[0].indexOf('Health');
                                const armorIndex = headers[0].indexOf('Armour');
                                const damageIndex = headers[0].indexOf('Damage');
                                
                                if (rarityIndex !== -1 && statsTable) {
                                    statsTable.forEach(row => {
                                        if (row[rarityIndex]) {
                                            rarities[row[rarityIndex]] = {
                                                health: parseInt(row[healthIndex]) || c.baseStats?.health || 100,
                                                armour: parseInt(row[armorIndex]) || c.baseStats?.armour || 20,
                                                damage: parseInt(row[damageIndex]) || c.baseStats?.damage || 15
                                            };
                                        }
                                    });
                                }
                            }
                        }
                    }
                    
                    return {
                        id: i + 1,
                        name: c.name,
                        hp: parseInt(c.baseStats?.health || c.baseHealth || 100),
                        armor: parseInt(c.baseStats?.armour || c.baseArmour || 20),
                        dmg: parseInt(c.baseStats?.damage || c.baseDamage || 15),
                        melee: c.attacks?.melee || c.meleeAttack || 'N/A',
                        ranged: c.attacks?.ranged || c.rangedAttack || 'N/A',
                        traits: c.traits || '',
                        icon: c.images?.heroIcon || c.images?.heroArt || '',
                        faction: c.faction || 'Unknown',
                        activeAbility: c.activeAbility || {},
                        passiveAbility: c.passiveAbility || {},
                        rarities: rarities
                    };
                });
                
                characters.sort((a, b) => a.name.localeCompare(b.name));
                
                buildMatchupMatrix();
                populateFilters();
                renderTable();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('matchupTable').style.display = 'table';
                loadingOverlay.classList.add('hidden');
                
                syncIcon.classList.remove('loading');
                syncIcon.classList.add('success');
                
                const synergyCount = Object.keys(synergyDatabase).length;
                const counterCount = Object.keys(counterDatabase).length;
                
                syncTooltip.innerHTML = `
                    ‚úÖ ${characters.length} –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π<br>
                    ‚úÖ –°–∏–Ω–µ—Ä–≥–∏–∏: ${synergyCount}<br>
                    ‚úÖ –ö–æ–Ω—Ç—Ä—ã: ${counterCount}<br>
                    <small>–ò—Å—Ç–æ—á–Ω–∏–∫: ${dataSource}</small>
                `;
                
                setTimeout(() => {
                    syncTooltip.classList.remove('show');
                }, 3000);
                
            } catch (error) {
                console.error('Sync error:', error);
                loadingOverlay.classList.add('hidden');
                syncIcon.classList.remove('loading');
                syncIcon.classList.add('error');
                syncIcon.textContent = '‚ùå';
                syncTooltip.innerHTML = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
                syncTooltip.classList.add('show');
            }
        }

        async function loadConditionalDatabases() {
            try {
                const parseCSV = (text) => {
                    const lines = text.trim().split('\n');
                    const headers = lines[0].split(',').map(h => h.trim());
                    return lines.slice(1).map(line => {
                        const values = [];
                        let current = '';
                        let inQuotes = false;

                        for (let char of line) {
                            if (char === '"') {
                                inQuotes = !inQuotes;
                            } else if (char === ',' && !inQuotes) {
                                values.push(current.trim());
                                current = '';
                            } else {
                                current += char;
                            }
                        }
                        values.push(current.trim());

                        return headers.reduce((obj, header, i) => {
                            obj[header] = values[i]?.replace(/^\"|\"$/g, '') || '';
                            return obj;
                        }, {});
                    });
                };

                const [traitsText, charTraitsText, bonusesText, factionsText, attacksText, passivesText] = await Promise.all([
                    fetch('traits_database.csv').then(r => r.ok ? r.text() : null).catch(() => null),
                    fetch('character_traits.csv').then(r => r.ok ? r.text() : null).catch(() => null),
                    fetch('conditional_bonuses.csv').then(r => r.ok ? r.text() : null).catch(() => null),
                    fetch('character_factions.csv').then(r => r.ok ? r.text() : null).catch(() => null),
                    fetch('character_attack_types.csv').then(r => r.ok ? r.text() : null).catch(() => null),
                    fetch('passive_abilities.csv').then(r => r.ok ? r.text() : null).catch(() => null)
                ]);

                if (traitsText) traitsDB = parseCSV(traitsText);
                if (charTraitsText) characterTraitsDB = parseCSV(charTraitsText);
                if (bonusesText) conditionalBonusesDB = parseCSV(bonusesText);
                if (factionsText) characterFactionsDB = parseCSV(factionsText);
                if (attacksText) characterAttackTypesDB = parseCSV(attacksText);
                if (passivesText) passiveAbilitiesDB = parseCSV(passivesText);

                return true;
            } catch (error) {
                console.warn('‚ö†Ô∏è Could not load CSV databases:', error);
                return false;
            }
        }

        function getCharacterTraits(characterName) {
            if (characterTraitsDB.length === 0) {
                const char = characters.find(c => c.name === characterName);
                if (!char || !char.traits) return [];
                return typeof char.traits === 'string' 
                    ? char.traits.split(', ').map(t => t.trim()).filter(t => t)
                    : char.traits;
            }
            return characterTraitsDB
                .filter(row => row.character === characterName)
                .map(row => row.trait);
        }

        function getTraitData(traitName) {
            return traitsDB.find(row => row.trait_name === traitName);
        }

        function getConditionalBonuses(characterName) {
            return conditionalBonusesDB.filter(row => row.character === characterName);
        }

        function getPassiveAbility(characterName) {
            const passive = passiveAbilitiesDB.find(row => row.character === characterName);
            if (!passive) return null;
            
            return {
                name: passive.passive_name,
                type: passive.effect_type,
                damageMult: parseFloat(passive.damage_multiplier) || 1.0,
                defenseMult: parseFloat(passive.defense_multiplier) || 1.0,
                additionalDmg: parseFloat(passive.additional_damage) || 0,
                condition: passive.condition,
                notes: passive.notes
            };
        }

        function isCharacter(entry) {
            return entry.baseStats &&
                   entry.attacks &&
                   (!entry.rawInfobox?.Type ||
                    (entry.rawInfobox?.Type && !entry.rawInfobox.Type.includes("Badge") &&
                     !entry.rawInfobox.Type.includes("Component") &&
                     !entry.rawInfobox.Type.includes("Mythic")));
        }

        function extractAttackInfo(attackStr) {
            if (!attackStr || attackStr === 'N/A') return [null, 0];
            const parts = attackStr.split('/').map(p => p.trim());
            const damageType = parts[0] || 'Physical';
            let hits = 1;
            for (const part of parts) {
                if (part.toLowerCase().includes('hit')) {
                    const match = part.match(/\d+/);
                    if (match) hits = parseInt(match[0]);
                }
            }
            return [damageType, hits];
        }

        function calculateMatchup(attacker, defender) {
            const [rangedType, rangedHits] = extractAttackInfo(attacker.ranged);
            const [meleeType, meleeHits] = extractAttackInfo(attacker.melee);

            const rangedValue = rangedHits * (PIERCE_RATIOS[rangedType] || 0);
            const meleeValue = meleeHits * (PIERCE_RATIOS[meleeType] || 0);

            const [atkType, atkHits] = (rangedValue > meleeValue && rangedHits > 0)
                ? [rangedType, rangedHits]
                : [meleeType, meleeHits];

            const pierce = PIERCE_RATIOS[atkType] || 20;
            const atkTraits = getCharacterTraits(attacker.name);
            const defTraits = getCharacterTraits(defender.name);

            let dmg = attacker.dmg;
            let armor = defender.armor;

            atkTraits.forEach(traitName => {
                const trait = getTraitData(traitName);
                if (trait && trait.effect_type === 'damage_multiplier' && trait.implemented === 'yes') {
                    dmg *= parseFloat(trait.effect_value);
                }
            });
            if (traitsDB.length === 0) {
                if (atkTraits.includes('Crushing Strike')) dmg *= 1.25;
                if (atkTraits.includes('Let the Galaxy Burn')) dmg *= 1.15;
            }

            defTraits.forEach(traitName => {
                const trait = getTraitData(traitName);
                if (trait && trait.effect_type === 'armor_multiplier' && trait.implemented === 'yes') {
                    armor *= parseFloat(trait.effect_value);
                }
            });
            if (traitsDB.length === 0) {
                if (defTraits.includes('Terminator Armour')) armor *= 1.4;
                if (defTraits.includes('Mk X Gravis')) armor *= 1.5;
            }

            let hasConditionalBonus = false;
            let conditionalBonusDetails = null;
            const bonuses = getConditionalBonuses(attacker.name);
            bonuses.forEach(bonus => {
                const conditionMet = bonus.condition_type === 'trait' 
                    ? defTraits.includes(bonus.condition_value)
                    : bonus.condition_type === 'faction'
                    ? defender.faction === bonus.condition_value
                    : false;

                if (conditionMet) {
                    hasConditionalBonus = true;
                    let bonusMultiplier = 1.5;
                    if (bonus.bonus_value && bonus.bonus_value !== 'unknown' && !isNaN(parseFloat(bonus.bonus_value))) {
                        bonusMultiplier = 1 + parseFloat(bonus.bonus_value) / 100;
                    }
                    dmg *= bonusMultiplier;
                    conditionalBonusDetails = {
                        name: bonus.ability_name,
                        type: bonus.ability_type,
                        conditionType: bonus.condition_type,
                        target: bonus.condition_value,
                        multiplier: bonusMultiplier,
                        confidence: bonus.confidence
                    };
                }
            });

            let incomingMult = 1.0;
            defTraits.forEach(traitName => {
                const trait = getTraitData(traitName);
                if (trait && trait.implemented === 'yes') {
                    if (trait.effect_type === 'damage_reduction') {
                        incomingMult *= parseFloat(trait.effect_value);
                    }
                    if (trait.effect_type === 'damage_taken_multiplier') {
                        incomingMult *= parseFloat(trait.effect_value);
                    }
                }
            });
            if (traitsDB.length === 0) {
                if (defTraits.includes('Resilient')) incomingMult *= 0.8;
                if (defTraits.includes('Big Target')) incomingMult *= 1.3;
            }
            
            if (document.getElementById('modTerrain')?.checked) {
                dmg *= 1.5;
            }
            if (document.getElementById('modHighGround')?.checked) {
                dmg *= 1.5;
            }
            if (document.getElementById('modCrit')?.checked) {
                dmg *= 1.1;
            }
            if (document.getElementById('modRazor')?.checked) {
                incomingMult *= 1.5;
            }

            const atkPassive = getPassiveAbility(attacker.name);
            if (atkPassive) {
                if (atkPassive.type === 'direct_damage') {
                    dmg *= atkPassive.damageMult;
                }
                
                if (atkPassive.type === 'conditional_damage' || atkPassive.type === 'scaling') {
                    dmg *= atkPassive.damageMult;
                }
                
                if (atkPassive.additionalDmg > 0) {
                    dmg += atkPassive.additionalDmg;
                }
            }

            const defPassive = getPassiveAbility(defender.name);
            if (defPassive) {
                if (defPassive.type === 'direct_defense') {
                    incomingMult *= defPassive.defenseMult;
                }
                
                if (defPassive.type === 'conditional_defense') {
                    incomingMult *= defPassive.defenseMult;
                }
            }

            const dmgAfterArmor = Math.max(1, dmg - armor);
            const dmgWithPierce = Math.max(1, dmg * (pierce / 100));
            let dmgPerHit = Math.max(dmgAfterArmor, dmgWithPierce);
            
            if (defTraits.includes('Mk X Gravis')) {
                const secondPassArmor = Math.max(1, dmgPerHit - armor);
                const secondPassPierce = Math.max(1, dmgPerHit * (pierce / 100));
                dmgPerHit = Math.max(secondPassArmor, secondPassPierce);
            }
            
            dmgPerHit *= incomingMult;
            const totalDmg = dmgPerHit * atkHits;

            const attackEff = Math.min(150, (totalDmg / defender.hp) * 100);
            const roundsToKill = defender.hp / Math.max(1, totalDmg);
            const defenseEff = Math.min(100, Math.max(5, roundsToKill * 20));

            const [defRangedType, defRangedHits] = extractAttackInfo(defender.ranged);
            const [defMeleeType, defMeleeHits] = extractAttackInfo(defender.melee);

            const defRangedValue = defRangedHits * (PIERCE_RATIOS[defRangedType] || 0);
            const defMeleeValue = defMeleeHits * (PIERCE_RATIOS[defMeleeType] || 0);

            const [defAtkType, defAtkHits] = (defRangedValue > defMeleeValue && defRangedHits > 0)
                ? [defRangedType, defRangedHits]
                : [defMeleeType, defMeleeHits];

            const defPierce = PIERCE_RATIOS[defAtkType] || 20;
            let defDmg = defender.dmg;
            let myArmor = attacker.armor;

            defTraits.forEach(traitName => {
                const trait = getTraitData(traitName);
                if (trait && trait.effect_type === 'damage_multiplier' && trait.implemented === 'yes') {
                    defDmg *= parseFloat(trait.effect_value);
                }
            });

            atkTraits.forEach(traitName => {
                const trait = getTraitData(traitName);
                if (trait && trait.effect_type === 'armor_multiplier' && trait.implemented === 'yes') {
                    myArmor *= parseFloat(trait.effect_value);
                }
            });

            let myIncomingMult = 1.0;
            atkTraits.forEach(traitName => {
                const trait = getTraitData(traitName);
                if (trait && trait.implemented === 'yes') {
                    if (trait.effect_type === 'damage_reduction') {
                        myIncomingMult *= parseFloat(trait.effect_value);
                    }
                    if (trait.effect_type === 'damage_taken_multiplier') {
                        myIncomingMult *= parseFloat(trait.effect_value);
                    }
                }
            });

            const defDmgAfterArmor = Math.max(1, defDmg - myArmor);
            const defDmgWithPierce = Math.max(1, defDmg * (defPierce / 100));
            let defDmgPerHit = Math.max(defDmgAfterArmor, defDmgWithPierce);

            if (atkTraits.includes('Mk X Gravis')) {
                const secondPass = Math.max(defDmgAfterArmor, defDmgWithPierce);
                defDmgPerHit = secondPass;
            }

            defDmgPerHit *= myIncomingMult;
            const defTotalDmg = defDmgPerHit * defAtkHits;
            const roundsToKillMe = attacker.hp / Math.max(1, defTotalDmg);

            return {
                attack: Math.round(attackEff * 10) / 10,
                defense: Math.round(defenseEff * 10) / 10,
                roundsToKill: Math.round(roundsToKill * 10) / 10,
                roundsToKillMe: Math.round(roundsToKillMe * 10) / 10,
                dmgPerHit: Math.round(dmgPerHit),
                totalDmgPerTurn: Math.round(totalDmg),
                hasConditionalBonus: hasConditionalBonus,
                conditionalBonus: conditionalBonusDetails
            };
        }

        function buildMatchupMatrix() {
            matchupMatrix = {};
            characters.forEach(attacker => {
                matchupMatrix[attacker.name] = {};
                characters.forEach(defender => {
                    matchupMatrix[attacker.name][defender.name] = null;
                });
            });
        }
        
        function recalculateAll() {
            buildMatchupMatrix();
            renderTable();
        }

        function getMatchup(attacker, defender) {
            if (matchupMatrix[attacker.name][defender.name] === null) {
                matchupMatrix[attacker.name][defender.name] = calculateMatchup(attacker, defender);
            }
            return matchupMatrix[attacker.name][defender.name];
        }

        function populateFilters() {
            const atkFilter = document.getElementById('attackerFilter');
            const defFilter = document.getElementById('defenderFilter');
            const factionFilter = document.getElementById('factionFilter');
            const traitFilter = document.getElementById('traitFilter');
            
            atkFilter.innerHTML = '<option value="">–í—Å–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏</option>';
            defFilter.innerHTML = '<option value="">–í—Å–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏</option>';
            
            const factions = [...new Set(characters.map(c => c.faction))].sort();
            factionFilter.innerHTML = '<option value="">–í—Å–µ —Ñ—Ä–∞–∫—Ü–∏–∏</option>';
            factions.forEach(faction => {
                if (faction && faction !== 'Unknown') {
                    const opt = document.createElement('option');
                    opt.value = faction;
                    opt.textContent = faction;
                    factionFilter.appendChild(opt);
                }
            });
            
            const allTraits = new Set();
            characters.forEach(char => {
                const traits = getCharacterTraits(char.name);
                traits.forEach(t => allTraits.add(t));
            });
            
            const sortedTraits = [...allTraits].sort();
            traitFilter.innerHTML = '<option value="">–í—Å–µ —Ç—Ä–µ–π—Ç—ã</option>';
            sortedTraits.forEach(trait => {
                if (trait) {
                    const opt = document.createElement('option');
                    opt.value = trait;
                    opt.textContent = trait;
                    traitFilter.appendChild(opt);
                }
            });
            
            characters.forEach(char => {
                const opt1 = document.createElement('option');
                opt1.value = char.name;
                opt1.textContent = char.name;
                atkFilter.appendChild(opt1);
                
                const opt2 = document.createElement('option');
                opt2.value = char.name;
                opt2.textContent = char.name;
                defFilter.appendChild(opt2);
            });
        }

        function getTradeClass(myRounds, theirRounds) {
            const ratio = myRounds / theirRounds;
            if (ratio <= 0.5) return 'cell-dominate';
            if (ratio <= 0.67) return 'cell-advantage';
            if (ratio <= 1.3) return 'cell-balanced';
            if (ratio <= 2.0) return 'cell-disadvantage';
            return 'cell-dominated';
        }

        function renderTable() {
            const atkFilter = document.getElementById('attackerFilter').value;
            const defFilter = document.getElementById('defenderFilter').value;
            const factionFilter = document.getElementById('factionFilter').value;
            const traitFilter = document.getElementById('traitFilter').value;
            const damageTypeFilter = document.getElementById('damageTypeFilter').value;
            const sortOrder = document.getElementById('sortOrder').value;
            const limit = parseInt(document.getElementById('limitSelect').value);
            
            let filteredChars = characters.filter(c => {
                if (factionFilter && c.faction !== factionFilter) return false;
                if (traitFilter && !getCharacterTraits(c.name).includes(traitFilter)) return false;
                if (damageTypeFilter) {
                    const hasMelee = c.melee && c.melee !== 'N/A';
                    const hasRanged = c.ranged && c.ranged !== 'N/A';
                    if (damageTypeFilter === 'melee' && !hasMelee) return false;
                    if (damageTypeFilter === 'ranged' && !hasRanged) return false;
                    if (damageTypeFilter === 'both' && (!hasMelee || !hasRanged)) return false;
                }
                return true;
            });
            
            if (sortOrder === 'alpha') {
                filteredChars.sort((a, b) => a.name.localeCompare(b.name));
            } else if (sortOrder === 'hp') {
                filteredChars.sort((a, b) => b.hp - a.hp);
            } else if (sortOrder === 'armor') {
                filteredChars.sort((a, b) => b.armor - a.armor);
            } else if (sortOrder === 'damage') {
                filteredChars.sort((a, b) => b.dmg - a.dmg);
            }
            
            let displayedAtk = filteredChars.slice(0, limit);
            if (atkFilter) {
                displayedAtk = filteredChars.filter(c => c.name === atkFilter);
            }
            
            let displayedDef = filteredChars.slice(0, limit);
            if (defFilter) {
                displayedDef = filteredChars.filter(c => c.name === defFilter);
            }
            
            const thead = document.getElementById('tableHead');
            const tbody = document.getElementById('tableBody');
            
            thead.innerHTML = '';
            tbody.innerHTML = '';
            
            const headerRow = document.createElement('tr');
            const corner = document.createElement('th');
            corner.textContent = '–ê–¢–ê–ö–£–Æ–©–ò–ô ‚Üì / –ó–ê–©–ò–©–ê–Æ–©–ò–ô–°–Ø ‚Üí';
            corner.colSpan = 1;
            headerRow.appendChild(corner);
            
            displayedDef.forEach((def, index) => {
                const nameTh = document.createElement('th');
                nameTh.innerHTML = `${index + 1}. ${def.name}`;
                nameTh.onmouseenter = (e) => showTooltip(e, def);
                nameTh.onmouseleave = hideTooltip;
                headerRow.appendChild(nameTh);
            });
            thead.appendChild(headerRow);
            
            displayedAtk.forEach((atk, atkIndex) => {
                const row = document.createElement('tr');
                
                const nameCell = document.createElement('td');
                nameCell.innerHTML = `${atkIndex + 1}. ${atk.name}`;
                nameCell.onmouseenter = (e) => showTooltip(e, atk);
                nameCell.onmouseleave = hideTooltip;
                row.appendChild(nameCell);
                
                displayedDef.forEach(def => {
                    const metrics = getMatchup(atk, def);
                    const cell = document.createElement('td');
                    cell.innerHTML = `
                        <div style="font-size: 0.85em; font-weight: 600; position: relative;">
                            ‚öîÔ∏è ${metrics.attack}%
                            ${metrics.hasConditionalBonus ? '<span class="bonus-icon">‚ö°</span>' : ''}
                        </div>
                        <div style="font-size: 0.85em; font-weight: 600; margin-top: 2px;">
                            üõ°Ô∏è ${metrics.defense}%
                        </div>
                    `;
                    cell.className = getTradeClass(metrics.roundsToKill, metrics.roundsToKillMe);
                    cell.onclick = () => showDetail(atk, def, metrics);
                    row.appendChild(cell);
                });
                
                tbody.appendChild(row);
            });
        }

        function showTooltip(event, char) {
            const tooltip = document.getElementById('tooltip');
            const hasImage = char.icon && char.icon.trim() !== '';
            
            tooltip.innerHTML = `
                ${hasImage ? 
                    `<img src="${char.icon}" alt="${char.name}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                     <div style="width:80px;height:80px;background:#16213e;border-radius:50%;margin-bottom:10px;display:none;align-items:center;justify-content:center;color:#888;font-size:2em;">üë§</div>` : 
                    '<div style="width:80px;height:80px;background:#16213e;border-radius:50%;margin-bottom:10px;display:flex;align-items:center;justify-content:center;color:#888;font-size:2em;">üë§</div>'
                }
                <div class="char-name">${char.name}</div>
                <div class="char-stats">
                    <div class="stat-row">
                        <span class="stat-label">HP:</span>
                        <span class="stat-value">${char.hp}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">ARM:</span>
                        <span class="stat-value">${char.armor}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">DMG:</span>
                        <span class="stat-value">${char.dmg}</span>
                    </div>
                    <div style="margin-top:5px;color:#888;font-size:0.9em;">
                        <div>‚öîÔ∏è ${char.melee}</div>
                        <div>üèπ ${char.ranged}</div>
                    </div>
                </div>
            `;
            
            let left = event.pageX + 15;
            let top = event.pageY + 15;
            const tooltipWidth = 320;
            const tooltipHeight = 220;
            
            if (left + tooltipWidth > window.innerWidth) {
                left = event.pageX - tooltipWidth - 15;
            }
            if (top + tooltipHeight > window.innerHeight) {
                top = event.pageY - tooltipHeight - 15;
            }
            
            left = Math.max(10, Math.min(left, window.innerWidth - tooltipWidth - 10));
            top = Math.max(10, Math.min(top, window.innerHeight - tooltipHeight - 10));
            
            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
            tooltip.classList.add('active');
        }

        function hideTooltip() {
            document.getElementById('tooltip').classList.remove('active');
        }

        function showDetail(attacker, defender, metrics) {
            currentAttacker = attacker;
            currentDefender = defender;
            
            const calculatedMetrics = metrics || getMatchup(attacker, defender);
            
            renderAnalysisTab(attacker, defender, calculatedMetrics);
            renderSynergyTab(attacker);
            renderCountersTab(defender);
            
            document.getElementById('detailPanel').classList.add('active');
        }

        function closeDetail() {
            document.getElementById('detailPanel').classList.remove('active');
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        function renderAnalysisTab(atk, def, metrics) {
            const [atkType, atkHits] = extractAttackInfo(atk.ranged)[0] ? extractAttackInfo(atk.ranged) : extractAttackInfo(atk.melee);
            const pierce = PIERCE_RATIOS[atkType] || 20;
            
            const atkTraits = getCharacterTraits(atk.name);
            const defTraits = getCharacterTraits(def.name);
            
            const ratio = metrics.roundsToKill / metrics.roundsToKillMe;
            let tradeResult = '';
            let tradeClass = '';
            
            if (ratio <= 0.5) {
                tradeResult = `üü¢ ${atk.name} –î–û–ú–ò–ù–ò–†–£–ï–¢ (+${(metrics.roundsToKillMe - metrics.roundsToKill).toFixed(1)} —Ä–∞—É–Ω–¥–∞ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞)`;
                tradeClass = 'dominate';
            } else if (ratio <= 0.67) {
                tradeResult = `üü¢ ${atk.name} –∏–º–µ–µ—Ç –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ (+${(metrics.roundsToKillMe - metrics.roundsToKill).toFixed(1)} —Ä–∞—É–Ω–¥–∞)`;
                tradeClass = 'advantage';
            } else if (ratio <= 1.3) {
                tradeResult = `üü° –°–ë–ê–õ–ê–ù–°–ò–†–û–í–ê–ù–ù–´–ô –†–ê–ó–ú–ï–ù (—Ä–∞–∑–Ω–∏—Ü–∞ ${Math.abs(metrics.roundsToKillMe - metrics.roundsToKill).toFixed(1)} —Ä–∞—É–Ω–¥–∞)`;
                tradeClass = 'balanced';
            } else if (ratio <= 2.0) {
                tradeResult = `üî¥ ${def.name} –∏–º–µ–µ—Ç –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ (+${(metrics.roundsToKill - metrics.roundsToKillMe).toFixed(1)} —Ä–∞—É–Ω–¥–∞)`;
                tradeClass = 'disadvantage';
            } else {
                tradeResult = `üî¥ ${def.name} –î–û–ú–ò–ù–ò–†–£–ï–¢ (+${(metrics.roundsToKill - metrics.roundsToKillMe).toFixed(1)} —Ä–∞—É–Ω–¥–∞ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞)`;
                tradeClass = 'dominated';
            }
            
            document.getElementById('analysisTab').innerHTML = `
                <div class="panel-title">–î–ï–¢–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó</div>
                
                <div class="char-card">
                    <h3>
                        ${atk.icon ? `<img src="${atk.icon}" class="char-icon">` : ''}
                        ‚öîÔ∏è ${atk.name}
                    </h3>
                    <div class="stat-row"><span class="stat-label">HP:</span><span>${atk.hp}</span></div>
                    <div class="stat-row"><span class="stat-label">–ë—Ä–æ–Ω—è:</span><span>${atk.armor}</span></div>
                    <div class="stat-row"><span class="stat-label">–£—Ä–æ–Ω:</span><span>${atk.dmg}</span></div>
                    <div class="stat-row"><span class="stat-label">–ë–ª–∏–∂–Ω–∏–π:</span><span>${atk.melee}</span></div>
                    <div class="stat-row"><span class="stat-label">–î–∞–ª—å–Ω–∏–π:</span><span>${atk.ranged}</span></div>
                    <div class="stat-row"><span class="stat-label">Traits:</span><span style="font-size: 0.75em;">${atkTraits.join(', ')}</span></div>
                </div>
                
                <div class="vs-divider">‚öîÔ∏è VS ‚öîÔ∏è</div>
                
                <div class="char-card">
                    <h3>
                        ${def.icon ? `<img src="${def.icon}" class="char-icon">` : ''}
                        üõ°Ô∏è ${def.name}
                    </h3>
                    <div class="stat-row"><span class="stat-label">HP:</span><span>${def.hp}</span></div>
                    <div class="stat-row"><span class="stat-label">–ë—Ä–æ–Ω—è:</span><span>${def.armor}</span></div>
                    <div class="stat-row"><span class="stat-label">–£—Ä–æ–Ω:</span><span>${def.dmg}</span></div>
                    <div class="stat-row"><span class="stat-label">–ë–ª–∏–∂–Ω–∏–π:</span><span>${def.melee}</span></div>
                    <div class="stat-row"><span class="stat-label">–î–∞–ª—å–Ω–∏–π:</span><span>${def.ranged}</span></div>
                    <div class="stat-row"><span class="stat-label">Traits:</span><span style="font-size: 0.75em;">${defTraits.join(', ')}</span></div>
                </div>
                
                <div class="metric-box" style="border-left-color: #00d4ff;">
                    <h4>‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò –†–ï–î–ö–û–°–¢–ò –ò –£–†–û–í–ù–Ø</h4>
                    
                    <div style="margin: 15px 0;">
                        <label style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>üîµ ${atk.name} (–†–µ–¥–∫–æ—Å—Ç—å):</span>
                            <span id="atkRarityLabel" style="color: #00ff88; font-weight: bold;">Common</span>
                        </label>
                        <input type="range" 
                               id="atkRaritySlider" 
                               min="0" max="5" value="0" 
                               step="1"
                               style="width: 100%; cursor: pointer;"
                               onchange="updateRarityCalculation()">
                        <div style="display: flex; justify-content: space-between; font-size: 0.7em; color: #888; margin-top: 5px;">
                            <span>Com</span>
                            <span>Unc</span>
                            <span>Rare</span>
                            <span>Epic</span>
                            <span>Leg</span>
                            <span>Myth</span>
                        </div>
                    </div>
                    
                    <div style="margin: 15px 0; padding-top: 10px; border-top: 1px solid #0f1a2e;">
                        <label style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>üîµ ${atk.name} (–£—Ä–æ–≤–µ–Ω—å):</span>
                            <span id="atkLevelLabel" style="color: #00d4ff; font-weight: bold;">1</span>
                        </label>
                        <input type="range" 
                               id="atkLevelSlider" 
                               min="1" max="55" value="1" 
                               step="1"
                               style="width: 100%; cursor: pointer;"
                               onchange="updateRarityCalculation()">
                        <div style="display: flex; justify-content: space-between; font-size: 0.7em; color: #888; margin-top: 5px;">
                            <span>Lvl 1</span>
                            <span>Lvl 28</span>
                            <span>Lvl 55 (MAX)</span>
                        </div>
                    </div>
                    
                    <div style="margin: 15px 0; padding-top: 10px; border-top: 1px solid #0f1a2e;">
                        <label style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>üî¥ ${def.name} (–†–µ–¥–∫–æ—Å—Ç—å):</span>
                            <span id="defRarityLabel" style="color: #00ff88; font-weight: bold;">Common</span>
                        </label>
                        <input type="range" 
                               id="defRaritySlider" 
                               min="0" max="5" value="0" 
                               step="1"
                               style="width: 100%; cursor: pointer;"
                               onchange="updateRarityCalculation()">
                        <div style="display: flex; justify-content: space-between; font-size: 0.7em; color: #888; margin-top: 5px;">
                            <span>Com</span>
                            <span>Unc</span>
                            <span>Rare</span>
                            <span>Epic</span>
                            <span>Leg</span>
                            <span>Myth</span>
                        </div>
                    </div>
                    
                    <div style="margin: 15px 0; padding-top: 10px; border-top: 1px solid #0f1a2e;">
                        <label style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>üî¥ ${def.name} (–£—Ä–æ–≤–µ–Ω—å):</span>
                            <span id="defLevelLabel" style="color: #00d4ff; font-weight: bold;">1</span>
                        </label>
                        <input type="range" 
                               id="defLevelSlider" 
                               min="1" max="55" value="1" 
                               step="1"
                               style="width: 100%; cursor: pointer;"
                               onchange="updateRarityCalculation()">
                        <div style="display: flex; justify-content: space-between; font-size: 0.7em; color: #888; margin-top: 5px;">
                            <span>Lvl 1</span>
                            <span>Lvl 28</span>
                            <span>Lvl 55 (MAX)</span>
                        </div>
                    </div>
                    
                    <div id="rarityStatsDisplay" style="background: #0f1a2e; padding: 12px; border-radius: 5px; margin-top: 15px; font-size: 0.9em;">
                        <div style="text-align: center; color: #00d4ff; font-weight: bold; margin-bottom: 10px;">
                            üìä –¢–ï–ö–£–©–ò–ï –•–ê–†–ê–ö–¢–ï–†–ò–°–¢–ò–ö–ò
                        </div>
                        <div style="display: flex; justify-content: space-between; margin: 8px 0; padding: 8px; background: rgba(0, 212, 255, 0.1); border-radius: 3px;">
                            <span style="font-weight: 600;">${atk.name}:</span>
                            <span style="color: #00ff88; font-family: monospace;">
                                HP: <strong>${atk.hp}</strong> | 
                                ARM: <strong>${atk.armor}</strong> | 
                                DMG: <strong>${atk.dmg}</strong>
                            </span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin: 8px 0; padding: 8px; background: rgba(239, 68, 68, 0.1); border-radius: 3px;">
                            <span style="font-weight: 600;">${def.name}:</span>
                            <span style="color: #ff6b6b; font-family: monospace;">
                                HP: <strong>${def.hp}</strong> | 
                                ARM: <strong>${def.armor}</strong> | 
                                DMG: <strong>${def.dmg}</strong>
                            </span>
                        </div>
                        <div style="margin-top: 10px; padding: 8px; background: rgba(255, 204, 0, 0.1); border-left: 3px solid #ffcc00; border-radius: 5px; font-size: 0.85em;">
                            <div style="color: #ffcc00; font-weight: bold; margin-bottom: 5px;">üí° –ü–†–ò–ú–ï–ß–ê–ù–ò–ï</div>
                            <div style="color: #ccc;">
                                –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —Ä–∞—Å—Ç—É—Ç —Å —Ä–µ–¥–∫–æ—Å—Ç—å—é –∏ —É—Ä–æ–≤–Ω–µ–º. 
                                –ü–∞—Å—Å–∏–≤–Ω—ã–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –∞–∫—Ç–∏–≤–∏—Ä—É—é—Ç—Å—è —Å –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–π —Ä–µ–¥–∫–æ—Å—Ç–∏ (–æ–±—ã—á–Ω–æ Rare).
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="metric-box">
                    <h4>‚öîÔ∏è –≠–§–§–ï–ö–¢–ò–í–ù–û–°–¢–¨ –ê–¢–ê–ö–ò</h4>
                    <div class="metric-value" style="background: #${getColorForPct(metrics.attack)}">${metrics.attack}%</div>
                    <p style="font-size: 0.85em; margin-top: 5px; color: #888;">
                        ‚îî‚îÄ –Ø —É–±–∏–≤–∞—é ${def.name} –∑–∞ <strong style="color: #fff;">${metrics.roundsToKill} —Ä–∞—É–Ω–¥–∞</strong><br>
                        ‚îî‚îÄ –£—Ä–æ–Ω –∑–∞ —Ö–æ–¥: ${metrics.totalDmgPerTurn} (${metrics.dmgPerHit} √ó ${atkHits} hits)<br>
                        ‚îî‚îÄ –¢–∏–ø: ${atkType} (${pierce}% pierce)
                    </p>
                </div>
                
                <div class="metric-box">
                    <h4>üõ°Ô∏è –≠–§–§–ï–ö–¢–ò–í–ù–û–°–¢–¨ –ó–ê–©–ò–¢–´</h4>
                    <div class="metric-value" style="background: #${getColorForPct(metrics.defense)}">${metrics.defense}%</div>
                    <p style="font-size: 0.85em; margin-top: 5px; color: #888;">
                        ‚îî‚îÄ ${def.name} —É–±–∏–≤–∞–µ—Ç –º–µ–Ω—è –∑–∞ <strong style="color: #fff;">${metrics.roundsToKillMe} —Ä–∞—É–Ω–¥–∞</strong><br>
                        ‚îî‚îÄ –ú–æ—è –∂–∏–≤—É—á–µ—Å—Ç—å: ${atk.hp} HP / ${atk.armor} armor
                    </p>
                </div>
                
                <div class="trade-indicator ${tradeClass}">
                    ‚öñÔ∏è –ò–¢–û–ì –†–ê–ó–ú–ï–ù–ê<br>
                    <div style="font-size: 0.9em; margin-top: 8px;">
                        ${tradeResult}
                    </div>
                </div>
                
                ${metrics.hasConditionalBonus && metrics.conditionalBonus ? `
                    <div class="metric-box" style="border-left-color: #ffcc00;">
                        <h4>‚ö° –£–°–õ–û–í–ù–´–ô –ë–û–ù–£–°</h4>
                        <div class="conditional-bonus-item">
                            <div style="font-weight: bold; color: #ffcc00; margin-bottom: 5px;">
                                ${metrics.conditionalBonus.name}
                                <span class="bonus-badge">${metrics.conditionalBonus.type}</span>
                            </div>
                            <div style="font-size: 0.85em; color: #ccc; margin: 5px 0;">
                                –£—Å–ª–æ–≤–∏–µ: ${metrics.conditionalBonus.conditionType === 'trait' ? '–¢—Ä–µ–π—Ç' : '–§—Ä–∞–∫—Ü–∏—è'} "${metrics.conditionalBonus.target}" ‚úÖ
                            </div>
                            <div style="font-size: 1.1em; color: #00ff88; margin-top: 8px; font-weight: bold;">
                                –ë–æ–Ω—É—Å: +${Math.round((metrics.conditionalBonus.multiplier - 1) * 100)}% —É—Ä–æ–Ω–∞
                            </div>
                        </div>
                    </div>
                ` : ''}
                
                ${(() => {
                    const atkPassive = getPassiveAbility(atk.name);
                    const defPassive = getPassiveAbility(def.name);
                    
                    let passiveHTML = '';
                    
                    if (atkPassive && atkPassive.type !== 'utility' && atkPassive.type !== 'utility_summon' && atkPassive.type !== 'none' && atkPassive.type !== 'unknown') {
                        passiveHTML += `
                            <div class="metric-box" style="border-left-color: #ffcc00;">
                                <h4>‚ö° –ü–ê–°–°–ò–í–ö–ê –ê–¢–ê–ö–£–Æ–©–ï–ì–û</h4>
                                <div style="background: #0f1a2e; padding: 12px; border-radius: 5px;">
                                    <div style="font-weight: bold; color: #ffcc00; margin-bottom: 8px;">
                                        ${atkPassive.name}
                                    </div>
                                    <div style="font-size: 0.85em; color: #ccc; margin-bottom: 8px;">
                                        ${atkPassive.notes}
                                    </div>
                                    ${atkPassive.damageMult > 1.0 ? `
                                        <div style="color: #00ff88; font-weight: bold;">
                                            ‚úÖ +${Math.round((atkPassive.damageMult - 1) * 100)}% —É—Ä–æ–Ω–∞ (—É—á—Ç–µ–Ω–æ)
                                        </div>
                                    ` : ''}
                                    ${atkPassive.additionalDmg > 0 ? `
                                        <div style="color: #00ff88; font-weight: bold;">
                                            ‚úÖ +${Math.round(atkPassive.additionalDmg)} –¥–æ–ø. —É—Ä–æ–Ω–∞ (—É—á—Ç–µ–Ω–æ)
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    }
                    
                    if (defPassive && defPassive.type !== 'utility' && defPassive.type !== 'utility_summon' && defPassive.type !== 'none' && defPassive.type !== 'unknown') {
                        passiveHTML += `
                            <div class="metric-box" style="border-left-color: #00d4ff;">
                                <h4>üõ°Ô∏è –ü–ê–°–°–ò–í–ö–ê –ó–ê–©–ò–¢–ù–ò–ö–ê</h4>
                                <div style="background: #0f1a2e; padding: 12px; border-radius: 5px;">
                                    <div style="font-weight: bold; color: #00d4ff; margin-bottom: 8px;">
                                        ${defPassive.name}
                                    </div>
                                    <div style="font-size: 0.85em; color: #ccc; margin-bottom: 8px;">
                                        ${defPassive.notes}
                                    </div>
                                    ${defPassive.defenseMult < 1.0 ? `
                                        <div style="color: #00ff88; font-weight: bold;">
                                            ‚úÖ ${Math.round((1 - defPassive.defenseMult) * 100)}% –º–µ–Ω—å—à–µ —É—Ä–æ–Ω–∞ (—É—á—Ç–µ–Ω–æ)
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    }
                    
                    return passiveHTML;
                })()}
            `;
        }

        function renderSynergyTab(attacker) {
            const synergies = synergyDatabase[attacker.name] || [];
            
            if (synergies.length === 0) {
                document.getElementById('synergyTab').innerHTML = `
                    <div class="panel-title">ü§ù –°–ò–ù–ï–†–ì–ò–Ø</div>
                    <div style="background: #0f1a2e; padding: 15px; border-radius: 8px; text-align: center;">
                        <p style="color: #888;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å–∏–Ω–µ—Ä–≥–∏—è—Ö –¥–ª—è ${attacker.name}</p>
                    </div>
                `;
                return;
            }
            
            let html = `<div class="panel-title">ü§ù –°–ò–ù–ï–†–ì–ò–Ø</div>`;
            
            synergies.forEach((syn, idx) => {
                const partners = syn.partners || [];
                const partnersList = Array.isArray(partners) 
                    ? partners.map(p => `<span class="partner-badge">${p}</span>`).join('')
                    : '';
                
                const shortDesc = syn.effect || syn.best_with || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è';
                const fullDesc = `
                    <strong>–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:</strong> ${syn.effect || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}<br>
                    <strong>–õ—É—á—à–µ –≤—Å–µ–≥–æ —Å:</strong> ${syn.best_with || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}<br>
                    ${syn.positioning ? `<strong>–ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:</strong> ${syn.positioning}<br>` : ''}
                    ${syn.notes ? `<strong>–ü—Ä–∏–º–µ—á–∞–Ω–∏—è:</strong> ${syn.notes}<br>` : ''}
                    ${syn.passive_buffs ? `<strong>–ü–∞—Å—Å–∏–≤–Ω—ã–µ –±–∞—Ñ—Ñ—ã:</strong> ${syn.passive_buffs}<br>` : ''}
                    ${syn.strategy ? `<strong>–°—Ç—Ä–∞—Ç–µ–≥–∏—è:</strong> ${syn.strategy}<br>` : ''}
                    ${syn.active ? `<strong>–ê–∫—Ç–∏–≤–Ω–∞—è:</strong> ${syn.active}<br>` : ''}
                    <small style="color: #666;">–ò—Å—Ç–æ—á–Ω–∏–∫: ${syn.source || 'unknown'}</small>
                `;
                
                html += `
                    <div class="synergy-item">
                        <div style="font-weight: bold; color: #00ff88; margin-bottom: 5px;">
                            ${getTypeIcon(syn.type)} ${formatType(syn.type)}
                        </div>
                        <div style="font-size: 0.9em; margin-bottom: 5px;">${shortDesc}</div>
                        ${partnersList ? `<div style="margin-top: 8px;">${partnersList}</div>` : ''}
                        <button class="expand-btn" onclick="toggleDetail('syn${idx}')">üìñ –ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
                        <div class="detail-text" id="syn${idx}">${fullDesc}</div>
                    </div>
                `;
            });
            
            document.getElementById('synergyTab').innerHTML = html;
        }

        function renderCountersTab(defender) {
            const counters = counterDatabase[defender.name] || [];
            
            if (counters.length === 0) {
                document.getElementById('countersTab').innerHTML = `
                    <div class="panel-title">‚ö†Ô∏è –ö–û–ù–¢–†–´</div>
                    <div style="background: #0f1a2e; padding: 15px; border-radius: 8px;">
                        <div class="synergy-item" style="border-left-color: #00ff88;">
                            ‚úÖ –ù–µ—Ç —è–≤–Ω—ã—Ö —Å–ª–∞–±–æ—Å—Ç–µ–π —É ${defender.name}
                        </div>
                    </div>
                `;
                return;
            }
            
            let html = `<div class="panel-title">‚ö†Ô∏è –ö–û–ù–¢–†–´</div>`;
            
            counters.forEach((counter, idx) => {
                const counterTypes = counter.counter_types || [];
                const typesList = counterTypes.map(t => `<span class="partner-badge" style="border-color: #fbbf24;">${t}</span>`).join('');
                
                const shortDesc = counter.weakness || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è';
                const fullDesc = `
                    <strong>–°–ª–∞–±–æ—Å—Ç—å:</strong> ${counter.weakness || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}<br>
                    <strong>–¢–∏–ø—ã –∫–æ–Ω—Ç—Ä–æ–≤:</strong> ${counterTypes.join(', ') || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}<br>
                    ${counter.counter_trait ? `<strong>–ö–æ–Ω—Ç—Ä—è—â–∏–π —Ç—Ä–µ–π—Ç:</strong> ${counter.counter_trait}<br>` : ''}
                    ${counter.reason ? `<strong>–ü—Ä–∏—á–∏–Ω–∞:</strong> ${counter.reason}<br>` : ''}
                    <strong>–ö–∞–∫ –∫–æ–Ω—Ç—Ä–∏—Ç—å:</strong> ${getCounterStrategy(counter)}<br>
                    <small style="color: #666;">–ò—Å—Ç–æ—á–Ω–∏–∫: ${counter.source || 'unknown'} | –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${counter.confidence || 'medium'}</small>
                `;
                
                html += `
                    <div class="synergy-item" style="border-left-color: #fbbf24;">
                        <div style="font-weight: bold; color: #fbbf24; margin-bottom: 5px;">
                            ${getReasonIcon(counter.reason)} ${formatReason(counter.reason)}
                        </div>
                        <div style="font-size: 0.9em; margin-bottom: 5px;">${shortDesc}</div>
                        ${typesList ? `<div style="margin-top: 8px;">${typesList}</div>` : ''}
                        <button class="expand-btn" onclick="toggleDetail('cnt${idx}')">üìñ –ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
                        <div class="detail-text" id="cnt${idx}">${fullDesc}</div>
                    </div>
                `;
            });
            
            document.getElementById('countersTab').innerHTML = html;
        }
        
        function toggleDetail(id) {
            const element = document.getElementById(id);
            element.classList.toggle('expanded');
        }
        
        function getTypeIcon(type) {
            const icons = {
                'faction_buff': 'üèõÔ∏è',
                'damage_amplifier': 'üí•',
                'multi_hit_team': '‚öîÔ∏è‚öîÔ∏è',
                'multi_hit_damage': 'üó°Ô∏è',
                'suppress_counter': 'üö´',
                'ranged_multi_hit': 'üèπ',
                'summon_warrior': 'üëª',
                'necron_synergy': 'üíÄ',
                'mech_healer': 'üîß',
                'admech_core': '‚öôÔ∏è',
                'reactivate_ability': 'üîÑ',
                'markerlight': 'üéØ',
                'psychic_master': 'üß†',
                'multi_hit_buffer': 'üí™',
                'multi_hit_core': '‚öîÔ∏è',
                'multi_hit_meta': 'üëë',
                'damage_stat_buffer': 'üìà',
                'guardsmen_summoner': 'ü™ñ',
                'resurrect_tank': '‚ôªÔ∏è',
                'passive_healer': 'üíö',
                'admech_reactivator': 'ü§ñ'
            };
            return icons[type] || 'ü§ù';
        }
        
        function formatType(type) {
            return type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }
        
        function getReasonIcon(reason) {
            const icons = {
                'slow_ramp': 'üêå',
                'positioning_dependent': 'üìç',
                'low_defense': '‚ù§Ô∏è',
                'niche_utility': 'üéØ',
                'positioning_squishy': 'üíî',
                'overwatch_counterable': 'üëÅÔ∏è',
                'mech_only': '‚öôÔ∏è',
                'tau_dependent': 'üîµ',
                'positioning_difficult': 'üìê',
                'psychic_resistance': 'üß†',
                'delayed_summon': '‚è±Ô∏è',
                'setup_dependent': 'üîß',
                'can_be_surrounded': '‚≠ï',
                'passive_only_non_lethal': 'üíî',
                'anti_summon': 'üö´üëª',
                'anti_tank_weapons': 'üî´',
                'anti_nurgle': '‚ò†Ô∏è'
            };
            return icons[reason] || '‚ö†Ô∏è';
        }
        
        function formatReason(reason) {
            return reason.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }
        
        function getCounterStrategy(counter) {
            if (counter.counter_types) {
                return `–ò—Å–ø–æ–ª—å–∑—É–π ${counter.counter_types.join(' –∏–ª–∏ ')} –ø—Ä–æ—Ç–∏–≤ —ç—Ç–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞`;
            }
            return '–ê—Ç–∞–∫—É–π —Å–ª–∞–±—ã–µ –º–µ—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ';
        }

        function getColorForPct(pct) {
            if (pct >= 90) return '00ff00';
            if (pct >= 70) return '4ade80';
            if (pct >= 50) return 'fbbf24';
            if (pct >= 30) return 'fb923c';
            return 'ef4444';
        }

        const RARITY_NAMES = ['Common', 'Uncommon', 'Rare', 'Epic', 'Legendary', 'Mythic'];

        function updateRarityCalculation() {
            const atkRarityIndex = parseInt(document.getElementById('atkRaritySlider').value);
            const defRarityIndex = parseInt(document.getElementById('defRaritySlider').value);
            const atkLevel = parseInt(document.getElementById('atkLevelSlider').value);
            const defLevel = parseInt(document.getElementById('defLevelSlider').value);
            
            const atkRarityName = RARITY_NAMES[atkRarityIndex];
            const defRarityName = RARITY_NAMES[defRarityIndex];
            
            document.getElementById('atkRarityLabel').textContent = atkRarityName;
            document.getElementById('defRarityLabel').textContent = defRarityName;
            document.getElementById('atkLevelLabel').textContent = atkLevel;
            document.getElementById('defLevelLabel').textContent = defLevel;
            
            const atkBaseStats = currentAttacker.rarities?.[atkRarityName] || {
                health: currentAttacker.hp,
                armour: currentAttacker.armor,
                damage: currentAttacker.dmg
            };
            
            const defBaseStats = currentDefender.rarities?.[defRarityName] || {
                health: currentDefender.hp,
                armour: currentDefender.armor,
                damage: currentDefender.dmg
            };
            
            const levelScaling = (baseStat, level) => {
                return Math.round(baseStat * (1 + 0.02 * (level - 1)));
            };
            
            const tempAttacker = {
                ...currentAttacker,
                hp: levelScaling(parseInt(atkBaseStats.health), atkLevel),
                armor: levelScaling(parseInt(atkBaseStats.armour), atkLevel),
                dmg: levelScaling(parseInt(atkBaseStats.damage), atkLevel)
            };
            
            const tempDefender = {
                ...currentDefender,
                hp: levelScaling(parseInt(defBaseStats.health), defLevel),
                armor: levelScaling(parseInt(defBaseStats.armour), defLevel),
                dmg: levelScaling(parseInt(defBaseStats.damage), defLevel)
            };
            
            const newMetrics = calculateMatchup(tempAttacker, tempDefender);
            
            document.getElementById('rarityStatsDisplay').innerHTML = `
                <div style="text-align: center; color: #00d4ff; font-weight: bold; margin-bottom: 10px;">
                    üìä –¢–ï–ö–£–©–ò–ï –•–ê–†–ê–ö–¢–ï–†–ò–°–¢–ò–ö–ò
                </div>
                <div style="display: flex; justify-content: space-between; margin: 8px 0; padding: 8px; background: rgba(0, 212, 255, 0.1); border-radius: 3px;">
                    <span style="font-weight: 600;">${tempAttacker.name} (${atkRarityName} Lvl ${atkLevel}):</span>
                    <span style="color: #00ff88; font-family: monospace;">
                        HP: <strong>${tempAttacker.hp}</strong> | 
                        ARM: <strong>${tempAttacker.armor}</strong> | 
                        DMG: <strong>${tempAttacker.dmg}</strong>
                    </span>
                </div>
                <div style="display: flex; justify-content: space-between; margin: 8px 0; padding: 8px; background: rgba(239, 68, 68, 0.1); border-radius: 3px;">
                    <span style="font-weight: 600;">${tempDefender.name} (${defRarityName} Lvl ${defLevel}):</span>
                    <span style="color: #ff6b6b; font-family: monospace;">
                        HP: <strong>${tempDefender.hp}</strong> | 
                        ARM: <strong>${tempDefender.armor}</strong> | 
                        DMG: <strong>${tempDefender.dmg}</strong>
                    </span>
                </div>
                <div style="margin-top: 10px; padding: 8px; background: rgba(0, 255, 136, 0.1); border-radius: 3px; text-align: center; font-size: 0.85em;">
                    <span style="color: #00ff88;">–†–∞–∑–Ω–∏—Ü–∞ HP: ${Math.abs(tempAttacker.hp - tempDefender.hp)}</span> | 
                    <span style="color: #00d4ff;">–†–∞–∑–Ω–∏—Ü–∞ DMG: ${Math.abs(tempAttacker.dmg - tempDefender.dmg)}</span>
                </div>
            `;
            
            renderAnalysisTab(tempAttacker, tempDefender, newMetrics);
        }

        document.getElementById('attackerFilter').addEventListener('change', renderTable);
        document.getElementById('defenderFilter').addEventListener('change', renderTable);
        document.getElementById('factionFilter').addEventListener('change', renderTable);
        document.getElementById('traitFilter').addEventListener('change', renderTable);
        document.getElementById('damageTypeFilter').addEventListener('change', renderTable);
        document.getElementById('sortOrder').addEventListener('change', renderTable);
        document.getElementById('limitSelect').addEventListener('change', (e) => {
            currentLimit = parseInt(e.target.value);
            renderTable();
        });
    </script>
</body>
</html>