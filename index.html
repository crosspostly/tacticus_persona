<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tacticus Matchup Analyzer - 100 Characters</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a2e;
            color: #e4e4e4;
            padding: 20px;
        }
        .container { max-width: 1900px; margin: 0 auto; }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #00d4ff;
            font-size: 2.5em;
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        }
        .import-section {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #16213e;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #00d4ff;
            z-index: 100;
            min-width: 200px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }
        .import-section h3 {
            color: #00d4ff;
            margin: 0 0 10px 0;
            font-size: 0.9em;
            text-align: center;
        }
        .import-btn {
            background: #00d4ff;
            color: #1a1a2e;
            border: none;
            padding: 8px 15px;
            font-size: 0.9em;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-bottom: 5px;
        }
        .import-btn:hover {
            background: #00ff88;
            transform: scale(1.02);
        }
        .auto-load-status {
            font-size: 0.8em;
            color: #888;
            text-align: center;
            margin-top: 5px;
        }
        .auto-load-status.success {
            color: #00ff88;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: #00d4ff;
            font-size: 1.5em;
            font-weight: bold;
        }
        .loading-overlay.hidden {
            display: none;
        }
        .filters {
            background: #16213e;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .filter-group { display: flex; flex-direction: column; gap: 10px; }
        .filter-group label { color: #00d4ff; font-weight: bold; }
        select {
            padding: 10px;
            background: #0f1a2e;
            color: #e4e4e4;
            border: 2px solid #00d4ff;
            border-radius: 5px;
            font-size: 1em;
            cursor: pointer;
        }
        .limit-group {
            grid-column: span 2;
            display: flex;
            align-items: center;
            gap: 15px;
            justify-content: center;
        }
        .legend {
            background: #16213e;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        .legend-item { display: flex; align-items: center; gap: 8px; }
        .legend-color { width: 30px; height: 20px; border-radius: 3px; }
        .excellent { background: #00ff00; }
        .good { background: #4ade80; }
        .neutral { background: #fbbf24; }
        .poor { background: #fb923c; }
        .terrible { background: #ef4444; }
        .matrix-container {
            background: #16213e;
            padding: 20px;
            border-radius: 10px;
            overflow: auto;
            max-height: 70vh;
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            font-size: 0.75em; 
        }
        th, td {
            padding: 6px 4px;
            text-align: center;
            border: 1px solid #0f1a2e;
            min-width: 70px;
        }
        th {
            background: #0f1a2e;
            color: #00d4ff;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        th:first-child, td:first-child {
            position: sticky;
            left: 0;
            background: #0f1a2e;
            font-weight: bold;
            z-index: 5;
            min-width: 140px;
            text-align: left;
            padding-left: 10px;
        }
        th:first-child { z-index: 15; }
        .number-header {
            background: #0a1429;
            color: #ffd700;
            font-weight: bold;
            font-size: 0.8em;
            min-width: 30px;
        }
        .number-cell {
            background: #0a1429;
            color: #ffd700;
            font-weight: bold;
            font-size: 0.8em;
            min-width: 30px;
        }
        td { cursor: pointer; transition: all 0.2s; }
        td:hover {
            transform: scale(1.05);
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
            z-index: 100;
        }
        .cell-90-100 { background: #00ff00; color: #000; font-weight: bold; }
        .cell-70-89 { background: #4ade80; color: #000; }
        .cell-50-69 { background: #fbbf24; color: #000; }
        .cell-30-49 { background: #fb923c; color: #fff; }
        .cell-0-29 { background: #ef4444; color: #fff; }
        
        .detail-panel {
            position: fixed;
            right: -550px;
            top: 0;
            width: 520px;
            height: 100vh;
            background: #16213e;
            box-shadow: -5px 0 20px rgba(0, 0, 0, 0.7);
            padding: 30px;
            overflow-y: auto;
            transition: right 0.3s ease;
            z-index: 1000;
        }
        .detail-panel.active { right: 0; }
        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #ef4444;
            color: #fff;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 1.5em;
            cursor: pointer;
            line-height: 0;
        }
        .close-btn:hover { background: #dc2626; }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #0f1a2e;
        }
        .tab {
            padding: 10px 20px;
            background: #0f1a2e;
            border: none;
            color: #e4e4e4;
            cursor: pointer;
            border-radius: 5px 5px 0 0;
            font-weight: bold;
        }
        .tab.active {
            background: #00d4ff;
            color: #1a1a2e;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        .panel-title {
            font-size: 1.6em;
            color: #00d4ff;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }
        .char-card {
            background: #0f1a2e;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .char-card h3 { 
            color: #00ff88; 
            margin-bottom: 10px; 
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .char-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #00d4ff;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #1a1a2e;
            font-size: 0.9em;
        }
        .stat-label { color: #00d4ff; font-weight: bold; }
        .vs-divider {
            text-align: center;
            font-size: 2em;
            color: #ff6b6b;
            margin: 15px 0;
            font-weight: bold;
        }
        .metric-box {
            background: #1a1a2e;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #00d4ff;
        }
        .metric-box h4 { color: #00d4ff; margin-bottom: 8px; font-size: 1em; }
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            text-align: center;
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
        }
        .synergy-list {
            list-style: none;
            padding: 0;
        }
        .synergy-item {
            background: #1a1a2e;
            padding: 12px;
            margin: 8px 0;
            border-radius: 5px;
            border-left: 3px solid #00ff88;
        }
        .partner-badge {
            display: inline-block;
            background: #0f1a2e;
            padding: 5px 10px;
            border-radius: 15px;
            margin: 3px;
            font-size: 0.85em;
            border: 1px solid #00d4ff;
        }
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: #00d4ff;
        }
        .tooltip {
            position: absolute;
            background: #0f1a2e;
            border: 2px solid #00d4ff;
            border-radius: 8px;
            padding: 15px;
            display: none;
            z-index: 999;
            max-width: 320px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
            transition: all 0.2s ease;
        }
        @media (max-width: 768px) {
            .tooltip {
                max-width: 280px;
                font-size: 0.9em;
            }
            .tooltip img {
                width: 60px;
                height: 60px;
            }
        }
        .tooltip.active { 
            display: block; 
            animation: tooltipFadeIn 0.2s ease;
        }
        @keyframes tooltipFadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .tooltip img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-bottom: 10px;
            border: 2px solid #00d4ff;
            box-shadow: 0 2px 10px rgba(0, 212, 255, 0.3);
            object-fit: cover;
            background: #16213e;
        }
        .tooltip .char-name {
            font-weight: bold;
            color: #00d4ff;
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        .tooltip .char-stats {
            font-size: 0.85em;
            line-height: 1.4;
        }
        .tooltip .stat-row {
            display: flex;
            justify-content: space-between;
            margin: 2px 0;
        }
        .tooltip .stat-label {
            color: #888;
        }
        .tooltip .stat-value {
            color: #fff;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚öîÔ∏è Warhammer 40K: Tacticus - Matchup Analyzer</h1>
        
        <div class="import-section">
            <h3>üìÅ –î–ê–ù–ù–´–ï</h3>
            <button class="import-btn" onclick="document.getElementById('fileInput').click()">
                –ó–∞–≥—Ä—É–∑–∏—Ç—å JSON
            </button>
            <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="loadJSON(event)">
            <button class="import-btn" onclick="useEmbeddedData()">
                –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            </button>
            <div id="autoLoadStatus" class="auto-load-status">
                –ó–∞–≥—Ä—É–∑–∫–∞ data.json...
            </div>
        </div>
        
        <div class="filters">
            <div class="filter-group">
                <label>üó°Ô∏è –§–ò–õ–¨–¢–† –ê–¢–ê–ö–£–Æ–©–ò–•</label>
                <select id="attackerFilter">
                    <option value="">–í—Å–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>üõ°Ô∏è –§–ò–õ–¨–¢–† –ó–ê–©–ò–©–ê–Æ–©–ò–•–°–Ø</label>
                <select id="defenderFilter">
                    <option value="">–í—Å–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏</option>
                </select>
            </div>
            
            <div class="limit-group">
                <label>üìä –ü–û–ö–ê–ó–ê–¢–¨ –ü–ï–†–í–´–•</label>
                <select id="limitSelect">
                    <option value="20">20 –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π</option>
                    <option value="30">30 –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π</option>
                    <option value="50" selected>50 –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π</option>
                    <option value="100">–í—Å–µ (100)</option>
                </select>
            </div>
        </div>

        <div class="legend">
            <div class="legend-item"><div class="legend-color excellent"></div><span>–û—Ç–ª–∏—á–Ω–æ (90-100%)</span></div>
            <div class="legend-item"><div class="legend-color good"></div><span>–•–æ—Ä–æ—à–æ (70-89%)</span></div>
            <div class="legend-item"><div class="legend-color neutral"></div><span>–ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ (50-69%)</span></div>
            <div class="legend-item"><div class="legend-color poor"></div><span>–ü–ª–æ—Ö–æ (30-49%)</span></div>
            <div class="legend-item"><div class="legend-color terrible"></div><span>–£–∂–∞—Å–Ω–æ (0-29%)</span></div>
        </div>

        <div class="matrix-container">
            <div id="loading" class="loading">
                –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö... –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ.
            </div>
            <table id="matchupTable" style="display: none;">
                <thead id="tableHead"></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <div class="detail-panel" id="detailPanel">
        <button class="close-btn" onclick="closeDetail()">√ó</button>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('analysis')">üìä –ê–Ω–∞–ª–∏–∑</button>
            <button class="tab" onclick="switchTab('synergy')">ü§ù –°–∏–Ω–µ—Ä–≥–∏—è</button>
            <button class="tab" onclick="switchTab('counters')">‚ö†Ô∏è –ö–æ–Ω—Ç—Ä—ã</button>
        </div>
        
        <div id="detailContent">
            <div id="analysisTab" class="tab-content active"></div>
            <div id="synergyTab" class="tab-content"></div>
            <div id="countersTab" class="tab-content"></div>
        </div>
    </div>
    
    <div class="tooltip" id="tooltip"></div>
    
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div>
            <div>‚öîÔ∏è –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
            <div style="font-size: 0.7em; margin-top: 10px;">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ</div>
        </div>
    </div>

    <script>
        // EMBEDDED SAMPLE DATA (will calculate on-the-fly)
        const EMBEDDED_CHARACTERS = [
            {id:1,name:"Abaddon The Despoiler",hp:100,armor:25,dmg:15,melee:"Power / 5 hits",ranged:"Bolter / 3 hits / Range 2",traits:"Let the Galaxy Burn, Resilient, Terminator Armour",icon:"https://tacticus.wiki.gg/images/Abaddon_The_Despoiler_Icon_Large.png?d3a9b6"},
            {id:2,name:"Abraxas",hp:70,armor:20,dmg:18,melee:"Flame / 2 hits",ranged:"Psychic / 1 hit / Range 2",traits:"Daemon, Flying, Summon, Weaver of Fates",icon:"https://tacticus.wiki.gg/images/Abraxas_Icon_Large.png?df9c9b"}
        ];
        
        const PIERCE_RATIOS = {
            'Psychic': 100, 'Direct': 100, 'Piercing': 80, 'Melta': 75,
            'Plasma': 65, 'Eviscerating': 50, 'Power': 40, 'Flame': 30,
            'Energy': 30, 'Bolter': 20, 'Chain': 20, 'Pulse': 20,
            'Blast': 15, 'Heavy Round': 15, 'Bio': 15, 'Molecular': 15,
            'Particle': 15, 'Toxic': 15, 'Las': 10, 'Projectile': 5,
            'Physical': 1
        };
        
 const MACHINES_OF_WAR = [
            'Biovore', 'Exorcist', 'Forgefiend', 'Galatian',
            'Malleus Rocket Launcher', 'Plagueburst Crawler',
            'Rukkatrukk', "Tson'ji"
        ];

        // Function to check if entry is a character (has baseStats and attacks, not a machine/badge/component)
        function isCharacter(entry) {
            return entry.baseStats &&
                   entry.attacks &&
                   (!entry.rawInfobox?.Type ||
                    (entry.rawInfobox?.Type && !entry.rawInfobox.Type.includes("Badge") &&
                     !entry.rawInfobox.Type.includes("Component") &&
                     !entry.rawInfobox.Type.includes("Mythic")));
        }
        
        let characters = [];
        let matchupMatrix = {};
        let currentLimit = 50;
        let currentAttacker = null;
        let currentDefender = null;

        // Auto-load data.json on page load
        window.addEventListener('load', function() {
            autoLoadDataJSON();
        });

        function autoLoadDataJSON() {
            const statusDiv = document.getElementById('autoLoadStatus');
            const loadingOverlay = document.getElementById('loadingOverlay');
            
            statusDiv.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ data.json...';
            loadingOverlay.classList.remove('hidden');
            
            fetch('data.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('–§–∞–π–ª data.json –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    }
                    return response.json();
                })
                .then(data => {
                    const filtered = data.filter(c => isCharacter(c) && !MACHINES_OF_WAR.includes(c.name));
                    
                    characters = filtered.map((c, i) => ({
                        id: i + 1,
                        name: c.name,
                        hp: parseInt(c.baseStats?.health || c.baseHealth || 100),
                        armor: parseInt(c.baseStats?.armour || c.baseArmour || 20),
                        dmg: parseInt(c.baseStats?.damage || c.baseDamage || 15),
                        melee: c.attacks?.melee || c.meleeAttack || 'N/A',
                        ranged: c.attacks?.ranged || c.rangedAttack || 'N/A',
                        traits: c.traits || '',
                        icon: c.images?.heroIcon || c.images?.heroArt || '',
                        faction: c.faction || 'Unknown',
                        activeAbility: c.activeAbility?.name || 'N/A',
                        passiveAbility: c.passiveAbility?.name || 'N/A'
                    }));
                    
                    buildMatchupMatrix();
                    populateFilters();
                    renderTable();
                    
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('matchupTable').style.display = 'table';
                    loadingOverlay.classList.add('hidden');
                    
                    statusDiv.textContent = `‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${characters.length} –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π`;
                    statusDiv.classList.add('success');
                })
                .catch(error => {
                    console.log('Auto-load failed:', error);
                    loadingOverlay.classList.add('hidden');
                    statusDiv.textContent = '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ';
                    statusDiv.classList.remove('success');
                });
        }

        function extractAttackInfo(attackStr) {
            if (!attackStr || attackStr === 'N/A') return [null, 0];
            const parts = attackStr.split('/').map(p => p.trim());
            const damageType = parts[0] || 'Physical';
            let hits = 1;
            for (const part of parts) {
                if (part.toLowerCase().includes('hit')) {
                    const match = part.match(/\\d+/);
                    if (match) hits = parseInt(match[0]);
                }
            }
            return [damageType, hits];
        }

        function calculateMatchup(attacker, defender) {
            const atkTraits = attacker.traits ? attacker.traits.split(', ') : [];
            const defTraits = defender.traits ? defender.traits.split(', ') : [];
            
            // Get attack info
            const [rangedType, rangedHits] = extractAttackInfo(attacker.ranged);
            const [meleeType, meleeHits] = extractAttackInfo(attacker.melee);
            
            const [atkType, atkHits] = (rangedType && rangedHits > 0) 
                ? [rangedType, rangedHits] 
                : [meleeType, meleeHits];
            
            const pierce = PIERCE_RATIOS[atkType] || 20;
            
            // ATTACK calculation
            let dmgMult = 1.0;
            if (atkTraits.includes('Crushing Strike')) dmgMult *= 1.25;
            if (atkTraits.includes('Let the Galaxy Burn')) dmgMult *= 1.15;
            
            let armorMult = 1.0;
            let incomingMult = 1.0;
            if (defTraits.includes('Resilient')) incomingMult *= 0.80;
            if (defTraits.includes('Terminator Armour')) armorMult *= 1.40;
            if (defTraits.includes('Big Target')) incomingMult *= 1.30;
            if (defTraits.includes('Mk X Gravis')) armorMult *= 1.50;
            
            const effectiveDmg = attacker.dmg * dmgMult;
            const effectiveArmor = defender.armor * armorMult;
            
            const dmgAfterArmor = Math.max(1, effectiveDmg - effectiveArmor);
            const dmgAfterPierce = Math.max(1, effectiveDmg * (pierce / 100));
            const dmgPerHit = Math.max(dmgAfterArmor, dmgAfterPierce);
            
            const totalDmg = dmgPerHit * atkHits * incomingMult;
            const attackEff = Math.min(100, (totalDmg / defender.hp) * 100);
            
            // DEFENSE calculation (reverse)
            const [defRangedType, defRangedHits] = extractAttackInfo(defender.ranged);
            const [defMeleeType, defMeleeHits] = extractAttackInfo(defender.melee);
            
            const [defType, defHits] = (defRangedType && defRangedHits > 0)
                ? [defRangedType, defRangedHits]
                : [defMeleeType, defMeleeHits];
            
            const defPierce = PIERCE_RATIOS[defType] || 20;
            
            let defDmgMult = 1.0;
            if (defTraits.includes('Crushing Strike')) defDmgMult *= 1.25;
            
            let atkArmorMult = 1.0;
            let atkIncomingMult = 1.0;
            if (atkTraits.includes('Resilient')) atkIncomingMult *= 0.80;
            if (atkTraits.includes('Terminator Armour')) atkArmorMult *= 1.40;
            if (atkTraits.includes('Big Target')) atkIncomingMult *= 1.30;
            
            const defEffectiveDmg = defender.dmg * defDmgMult;
            const atkEffectiveArmor = attacker.armor * atkArmorMult;
            
            const defDmgAfterArmor = Math.max(1, defEffectiveDmg - atkEffectiveArmor);
            const defDmgAfterPierce = Math.max(1, defEffectiveDmg * (defPierce / 100));
            const defDmgPerHit = Math.max(defDmgAfterArmor, defDmgAfterPierce);
            
            const totalDefDmg = defDmgPerHit * defHits * atkIncomingMult;
            const damageTakenPct = (totalDefDmg / attacker.hp) * 100;
            const defenseEff = Math.max(0, 100 - damageTakenPct);
            
            const average = (attackEff + defenseEff) / 2;
            
            return {
                attack: Math.round(attackEff * 10) / 10,
                defense: Math.round(defenseEff * 10) / 10,
                average: Math.round(average * 10) / 10
            };
        }

        function loadJSON(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const loadingOverlay = document.getElementById('loadingOverlay');
            const reader = new FileReader();
            loadingOverlay.classList.remove('hidden');
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    const filtered = data.filter(c => isCharacter(c) && !MACHINES_OF_WAR.includes(c.name));
                    
                    characters = filtered.map((c, i) => ({
                        id: i + 1,
                        name: c.name,
                        hp: parseInt(c.baseStats?.health || c.baseHealth || 100),
                        armor: parseInt(c.baseStats?.armour || c.baseArmour || 20),
                        dmg: parseInt(c.baseStats?.damage || c.baseDamage || 15),
                        melee: c.attacks?.melee || c.meleeAttack || 'N/A',
                        ranged: c.attacks?.ranged || c.rangedAttack || 'N/A',
                        traits: c.traits || '',
                        icon: c.images?.heroIcon || c.images?.heroArt || '',
                        faction: c.faction || 'Unknown',
                        activeAbility: c.activeAbility?.name || 'N/A',
                        passiveAbility: c.passiveAbility?.name || 'N/A'
                    }));
                    
                    buildMatchupMatrix();
                    populateFilters();
                    renderTable();
                    
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('matchupTable').style.display = 'table';
                    loadingOverlay.classList.add('hidden');
                    
                    const statusDiv = document.getElementById('autoLoadStatus');
                    statusDiv.textContent = `‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${characters.length} –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π`;
                    statusDiv.classList.add('success');
                    
                    alert(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${characters.length} –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π!`);
                } catch (error) {
                    loadingOverlay.classList.add('hidden');
                    alert('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ JSON: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function useEmbeddedData() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.classList.remove('hidden');
            
            // Small delay to show loading for embedded data
            setTimeout(() => {
                characters = EMBEDDED_CHARACTERS;
                buildMatchupMatrix();
                populateFilters();
                renderTable();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('matchupTable').style.display = 'table';
                loadingOverlay.classList.add('hidden');
                
                const statusDiv = document.getElementById('autoLoadStatus');
                statusDiv.textContent = `‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ ${characters.length} –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π`;
                statusDiv.classList.add('success');
            }, 500);
        }

        function buildMatchupMatrix() {
            matchupMatrix = {};
            // Build matrix lazily - only calculate when needed for performance
            characters.forEach(attacker => {
                matchupMatrix[attacker.name] = {};
                characters.forEach(defender => {
                    matchupMatrix[attacker.name][defender.name] = null; // Lazy initialization
                });
            });
        }

        function getMatchup(attacker, defender) {
            // Lazy calculation - only compute when actually needed
            if (matchupMatrix[attacker.name][defender.name] === null) {
                matchupMatrix[attacker.name][defender.name] = calculateMatchup(attacker, defender);
            }
            return matchupMatrix[attacker.name][defender.name];
        }

        function populateFilters() {
            const atkFilter = document.getElementById('attackerFilter');
            const defFilter = document.getElementById('defenderFilter');
            
            atkFilter.innerHTML = '<option value="">–í—Å–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏</option>';
            defFilter.innerHTML = '<option value="">–í—Å–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏</option>';
            
            characters.forEach(char => {
                const opt1 = document.createElement('option');
                opt1.value = char.name;
                opt1.textContent = char.name;
                atkFilter.appendChild(opt1);
                
                const opt2 = document.createElement('option');
                opt2.value = char.name;
                opt2.textContent = char.name;
                defFilter.appendChild(opt2);
            });
        }

        function getEffectivenessClass(pct) {
            if (pct >= 90) return 'cell-90-100';
            if (pct >= 70) return 'cell-70-89';
            if (pct >= 50) return 'cell-50-69';
            if (pct >= 30) return 'cell-30-49';
            return 'cell-0-29';
        }

        function renderTable() {
            const atkFilter = document.getElementById('attackerFilter').value;
            const defFilter = document.getElementById('defenderFilter').value;
            const limit = parseInt(document.getElementById('limitSelect').value);
            
            let displayedAtk = characters.slice(0, limit);
            if (atkFilter) {
                displayedAtk = characters.filter(c => c.name === atkFilter);
            }
            
            let displayedDef = characters.slice(0, limit);
            if (defFilter) {
                displayedDef = characters.filter(c => c.name === defFilter);
            }
            
            const thead = document.getElementById('tableHead');
            const tbody = document.getElementById('tableBody');
            
            thead.innerHTML = '';
            tbody.innerHTML = '';
            
            // Show loading message for large datasets
            if (displayedAtk.length * displayedDef.length > 1000) {
                const statusDiv = document.getElementById('autoLoadStatus');
                statusDiv.textContent = `üîÑ –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –º–∞—Ç—Ä–∏—Ü—ã ${displayedAtk.length}√ó${displayedDef.length}...`;
            }
            
            // Header row with numbering
            const headerRow = document.createElement('tr');
            const corner = document.createElement('th');
            corner.textContent = '–ê–¢–ê–ö–£–Æ–©–ò–ô ‚Üì / –ó–ê–©–ò–©–ê–Æ–©–ò–ô–°–Ø ‚Üí';
            corner.colSpan = 2;
            headerRow.appendChild(corner);
            
            displayedDef.forEach((def, index) => {
                const numTh = document.createElement('th');
                numTh.className = 'number-header';
                numTh.textContent = index + 1;
                headerRow.appendChild(numTh);
                
                const nameTh = document.createElement('th');
                nameTh.textContent = def.name;
                nameTh.onmouseenter = (e) => showTooltip(e, def);
                nameTh.onmouseleave = hideTooltip;
                headerRow.appendChild(nameTh);
            });
            thead.appendChild(headerRow);
            
            // Data rows with numbering
            displayedAtk.forEach((atk, atkIndex) => {
                const row = document.createElement('tr');
                
                const numCell = document.createElement('td');
                numCell.className = 'number-cell';
                numCell.textContent = atkIndex + 1;
                row.appendChild(numCell);
                
                const nameCell = document.createElement('td');
                nameCell.textContent = atk.name;
                nameCell.onmouseenter = (e) => showTooltip(e, atk);
                nameCell.onmouseleave = hideTooltip;
                row.appendChild(nameCell);
                
                displayedDef.forEach(def => {
                    const metrics = getMatchup(atk, def);
                    const cell = document.createElement('td');
                    cell.innerHTML = `
                        <div style="font-size: 0.7em; color: #888;">${metrics.attack}% / ${metrics.defense}%</div>
                        <div style="font-weight: bold; font-size: 1.1em;">${metrics.average}%</div>
                    `;
                    cell.className = getEffectivenessClass(metrics.average);
                    cell.onclick = () => showDetail(atk, def, metrics);
                    row.appendChild(cell);
                });
                
                tbody.appendChild(row);
            });
            
            // Update status after completion
            if (displayedAtk.length * displayedDef.length > 1000) {
                const statusDiv = document.getElementById('autoLoadStatus');
                const totalCells = displayedAtk.length * displayedDef.length;
                statusDiv.textContent = `‚úÖ –ú–∞—Ç—Ä–∏—Ü–∞ –≥–æ—Ç–æ–≤–∞: ${totalCells} —è—á–µ–µ–∫`;
            }
        }

        function showTooltip(event, char) {
            const tooltip = document.getElementById('tooltip');
            const hasImage = char.icon && char.icon.trim() !== '';
            
            tooltip.innerHTML = `
                ${hasImage ? 
                    `<img src="${char.icon}" alt="${char.name}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                     <div style="width:80px;height:80px;background:#16213e;border-radius:50%;margin-bottom:10px;display:none;align-items:center;justify-content:center;color:#888;font-size:2em;">üë§</div>` : 
                    '<div style="width:80px;height:80px;background:#16213e;border-radius:50%;margin-bottom:10px;display:flex;align-items:center;justify-content:center;color:#888;font-size:2em;">üë§</div>'
                }
                <div class="char-name">${char.name}</div>
                <div class="char-stats">
                    <div class="stat-row">
                        <span class="stat-label">HP:</span>
                        <span class="stat-value">${char.hp}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">ARM:</span>
                        <span class="stat-value">${char.armor}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">DMG:</span>
                        <span class="stat-value">${char.dmg}</span>
                    </div>
                    <div style="margin-top:5px;color:#888;font-size:0.9em;">
                        <div>‚öîÔ∏è ${char.melee}</div>
                        <div>üèπ ${char.ranged}</div>
                    </div>
                </div>
            `;
            
            // Position tooltip intelligently to avoid going off-screen
            let left = event.pageX + 15;
            let top = event.pageY + 15;
            const tooltipWidth = window.innerWidth <= 768 ? 280 : 320;
            const tooltipHeight = window.innerWidth <= 768 ? 180 : 200;
            
            // Check if tooltip would go off right edge
            if (left + tooltipWidth > window.innerWidth) {
                left = event.pageX - tooltipWidth - 15;
            }
            
            // Check if tooltip would go off bottom edge
            if (top + tooltipHeight > window.innerHeight) {
                top = event.pageY - tooltipHeight - 15;
            }
            
            // Ensure tooltip stays within viewport
            left = Math.max(10, Math.min(left, window.innerWidth - tooltipWidth - 10));
            top = Math.max(10, Math.min(top, window.innerHeight - tooltipHeight - 10));
            
            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
            tooltip.classList.add('active');
        }

        function hideTooltip() {
            document.getElementById('tooltip').classList.remove('active');
        }

        function showDetail(attacker, defender, metrics) {
            currentAttacker = attacker;
            currentDefender = defender;
            
            // Ensure metrics are calculated
            const calculatedMetrics = metrics || getMatchup(attacker, defender);
            
            renderAnalysisTab(attacker, defender, calculatedMetrics);
            renderSynergyTab(attacker);
            renderCountersTab(defender);
            
            document.getElementById('detailPanel').classList.add('active');
        }

        function closeDetail() {
            document.getElementById('detailPanel').classList.remove('active');
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        function renderAnalysisTab(atk, def, metrics) {
            const [atkType, atkHits] = extractAttackInfo(atk.ranged)[0] ? extractAttackInfo(atk.ranged) : extractAttackInfo(atk.melee);
            const pierce = PIERCE_RATIOS[atkType] || 20;
            
            document.getElementById('analysisTab').innerHTML = `
                <div class="panel-title">–î–ï–¢–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó</div>
                
                <div class="char-card">
                    <h3>
                        ${atk.icon ? `<img src="${atk.icon}" class="char-icon">` : ''}
                        ‚öîÔ∏è ${atk.name}
                    </h3>
                    <div class="stat-row"><span class="stat-label">HP:</span><span>${atk.hp}</span></div>
                    <div class="stat-row"><span class="stat-label">–ë—Ä–æ–Ω—è:</span><span>${atk.armor}</span></div>
                    <div class="stat-row"><span class="stat-label">–£—Ä–æ–Ω:</span><span>${atk.dmg}</span></div>
                    <div class="stat-row"><span class="stat-label">–ë–ª–∏–∂–Ω–∏–π:</span><span>${atk.melee}</span></div>
                    <div class="stat-row"><span class="stat-label">–î–∞–ª—å–Ω–∏–π:</span><span>${atk.ranged}</span></div>
                    <div class="stat-row"><span class="stat-label">Traits:</span><span style="font-size: 0.8em;">${atk.traits}</span></div>
                </div>
                
                <div class="vs-divider">‚öîÔ∏è VS ‚öîÔ∏è</div>
                
                <div class="char-card">
                    <h3>
                        ${def.icon ? `<img src="${def.icon}" class="char-icon">` : ''}
                        üõ°Ô∏è ${def.name}
                    </h3>
                    <div class="stat-row"><span class="stat-label">HP:</span><span>${def.hp}</span></div>
                    <div class="stat-row"><span class="stat-label">–ë—Ä–æ–Ω—è:</span><span>${def.armor}</span></div>
                    <div class="stat-row"><span class="stat-label">–£—Ä–æ–Ω:</span><span>${def.dmg}</span></div>
                    <div class="stat-row"><span class="stat-label">–ë–ª–∏–∂–Ω–∏–π:</span><span>${def.melee}</span></div>
                    <div class="stat-row"><span class="stat-label">–î–∞–ª—å–Ω–∏–π:</span><span>${def.ranged}</span></div>
                    <div class="stat-row"><span class="stat-label">Traits:</span><span style="font-size: 0.8em;">${def.traits}</span></div>
                </div>
                
                <div class="metric-box">
                    <h4>‚öîÔ∏è –≠–§–§–ï–ö–¢–ò–í–ù–û–°–¢–¨ –ê–¢–ê–ö–ò</h4>
                    <div class="metric-value" style="background: #${getColorForPct(metrics.attack)}">${metrics.attack}%</div>
                    <p style="font-size: 0.85em; margin-top: 5px;">
                        ${atkType} (${pierce}% pierce) √ó ${atkHits} hits
                    </p>
                </div>
                
                <div class="metric-box">
                    <h4>üõ°Ô∏è –≠–§–§–ï–ö–¢–ò–í–ù–û–°–¢–¨ –ó–ê–©–ò–¢–´</h4>
                    <div class="metric-value" style="background: #${getColorForPct(metrics.defense)}">${metrics.defense}%</div>
                </div>
                
                <div class="metric-box">
                    <h4>üìä –°–†–ï–î–ù–Ø–Ø –≠–§–§–ï–ö–¢–ò–í–ù–û–°–¢–¨</h4>
                    <div class="metric-value" style="background: #${getColorForPct(metrics.average)}">${metrics.average}%</div>
                    <p style="font-size: 0.85em; margin-top: 5px;">
                        –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ –¥–ª—è —Å–ø–∞—Ä–∏–Ω–≥–∞
                    </p>
                </div>
            `;
        }

        function renderSynergyTab(attacker) {
            const traits = attacker.traits ? attacker.traits.split(', ') : [];
            
            document.getElementById('synergyTab').innerHTML = `
                <div class="panel-title">ü§ù –°–ò–ù–ï–†–ì–ò–Ø</div>
                
                <div style="background: #0f1a2e; padding: 15px; border-radius: 8px;">
                    <h4 style="color: #00ff88; margin-bottom: 10px;">–õ—É—á—à–∏–µ –ø–∞—Ä—Ç–Ω—ë—Ä—ã –¥–ª—è ${attacker.name}</h4>
                    <ul class="synergy-list">
                        ${traits.includes('Healer') ? '<li class="synergy-item">üíö <b>Healer</b> - —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —Ç–∞–Ω–∫–∞–º–∏ (Resilient, –≤—ã—Å–æ–∫–∏–π HP)</li>' : ''}
                        ${traits.includes('Summon') ? '<li class="synergy-item">üëª <b>Summoner</b> - —Å–∏–Ω–µ—Ä–≥–∏—è —Å buff –ø–µ—Ä—Å–æ–Ω–∞–∂–∞–º–∏</li>' : ''}
                        ${traits.includes('Psyker') ? '<li class="synergy-item">üß† <b>Psyker</b> - –∫–æ–º–±–æ —Å –¥—Ä—É–≥–∏–º–∏ Psyker</li>' : ''}
                        ${traits.includes('Heavy Weapon') ? '<li class="synergy-item">üî´ <b>Heavy Weapon</b> - –ø–æ–ª—É—á–∞–µ—Ç buff –æ—Ç Thaddeus Noble</li>' : ''}
                    </ul>
                    
                    <p style="margin-top: 15px; padding: 10px; background: #1a1a2e; border-radius: 5px; font-size: 0.9em;">
                        üí° –ó–∞–≥—Ä—É–∑–∏—Ç–µ –ø–æ–ª–Ω—ã–π JSON –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–∏–Ω–µ—Ä–≥–∏—è—Ö
                    </p>
                </div>
            `;
        }

        function renderCountersTab(defender) {
            const armor = defender.armor;
            const hp = defender.hp;
            const traits = defender.traits ? defender.traits.split(', ') : [];
            
            const counters = [];
            if (armor > 25) counters.push('–í—ã—Å–æ–∫–æ–µ –ø—Ä–æ–±–∏—Ç–∏–µ (Psychic, Piercing, Melta)');
            if (hp < 80) counters.push('Burst damage –∏ multi-hit –∞—Ç–∞–∫–∏');
            if (traits.includes('Big Target')) counters.push('Beast Slayer –ø–µ—Ä—Å–æ–Ω–∞–∂–∏ (+30% —É—Ä–æ–Ω–∞)');
            if (traits.includes('Close Combat Weakness')) counters.push('Melee –∞—Ç–∞–∫—É—é—â–∏–µ (+50% —É—Ä–æ–Ω–∞)');
            
            document.getElementById('countersTab').innerHTML = `
                <div class="panel-title">‚ö†Ô∏è –ö–û–ù–¢–†–´</div>
                
                <div style="background: #0f1a2e; padding: 15px; border-radius: 8px;">
                    <h4 style="color: #fbbf24; margin-bottom: 10px;">–°–ª–∞–±–æ—Å—Ç–∏ ${defender.name}</h4>
                    <ul class="synergy-list">
                        ${counters.map(c => `<li class="synergy-item">‚ö†Ô∏è ${c}</li>`).join('')}
                        ${counters.length === 0 ? '<li class="synergy-item">‚úÖ –ù–µ—Ç —è–≤–Ω—ã—Ö —Å–ª–∞–±–æ—Å—Ç–µ–π</li>' : ''}
                    </ul>
                </div>
            `;
        }

        function getColorForPct(pct) {
            if (pct >= 90) return '00ff00';
            if (pct >= 70) return '4ade80';
            if (pct >= 50) return 'fbbf24';
            if (pct >= 30) return 'fb923c';
            return 'ef4444';
        }

        document.getElementById('attackerFilter').addEventListener('change', renderTable);
        document.getElementById('defenderFilter').addEventListener('change', renderTable);
        document.getElementById('limitSelect').addEventListener('change', (e) => {
            currentLimit = parseInt(e.target.value);
            renderTable();
        });
    </script>
</body>
</html>
