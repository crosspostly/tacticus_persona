<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tacticus Matchup Analyzer - 100 Characters</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a2e;
            color: #e4e4e4;
            padding: 20px;
        }
        .container { max-width: 1900px; margin: 0 auto; }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #00d4ff;
            font-size: 2.5em;
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        }
        
        /* üÜï –ö–ù–û–ü–ö–ê –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò */
        .sync-button {
            background: #00ff88;
            color: #1a1a2e;
            border: none;
            padding: 15px 30px;
            font-size: 1.1em;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            margin: 0 auto 20px;
            display: block;
            box-shadow: 0 4px 15px rgba(0, 255, 136, 0.3);
        }
        .sync-button:hover {
            background: #00d4ff;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 212, 255, 0.4);
        }
        .sync-button:active {
            transform: translateY(0);
        }
        
        .auto-load-status {
            font-size: 0.85em;
            color: #888;
            text-align: center;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        .auto-load-status.success {
            color: #00ff88;
        }
        .auto-load-status.error {
            color: #ff6b6b;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: #00d4ff;
            font-size: 1.5em;
            font-weight: bold;
        }
        .loading-overlay.hidden {
            display: none;
        }
        .filters {
            background: #16213e;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        .filter-group { display: flex; flex-direction: column; gap: 8px; }
        .filter-group label { color: #00d4ff; font-weight: bold; font-size: 0.9em; }
        select {
            padding: 10px;
            background: #0f1a2e;
            color: #e4e4e4;
            border: 2px solid #00d4ff;
            border-radius: 5px;
            font-size: 0.95em;
            cursor: pointer;
        }
        .limit-group {
            grid-column: span 3;
            display: flex;
            align-items: center;
            gap: 15px;
            justify-content: center;
            padding-top: 10px;
            border-top: 2px solid #0f1a2e;
        }
        .legend {
            background: #16213e;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        .legend-item { display: flex; align-items: center; gap: 8px; }
        .legend-color { width: 30px; height: 20px; border-radius: 3px; }
        .excellent { background: #00ff00; }
        .good { background: #4ade80; }
        .neutral { background: #fbbf24; }
        .poor { background: #fb923c; }
        .terrible { background: #ef4444; }
        .matrix-container {
            background: #16213e;
            padding: 20px;
            border-radius: 10px;
            overflow: auto;
            max-height: 70vh;
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            font-size: 0.75em; 
        }
        th, td {
            padding: 6px 4px;
            text-align: center;
            border: 1px solid #0f1a2e;
            min-width: 70px;
        }
        th {
            background: #0f1a2e;
            color: #00d4ff;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        th:first-child, td:first-child {
            position: sticky;
            left: 0;
            background: #0f1a2e;
            font-weight: bold;
            z-index: 5;
            min-width: 140px;
            text-align: left;
            padding-left: 10px;
        }
        th:first-child { z-index: 15; }
        td { cursor: pointer; transition: all 0.2s; position: relative; }
        td:hover {
            transform: scale(1.05);
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
            z-index: 100;
        }
        .cell-90-100 { background: #00ff00; color: #000; font-weight: bold; }
        .cell-70-89 { background: #4ade80; color: #000; }
        .cell-50-69 { background: #fbbf24; color: #000; }
        .cell-30-49 { background: #fb923c; color: #fff; }
        .cell-0-29 { background: #ef4444; color: #fff; }
        
        .detail-panel {
            position: fixed;
            right: -550px;
            top: 0;
            width: 520px;
            height: 100vh;
            background: #16213e;
            box-shadow: -5px 0 20px rgba(0, 0, 0, 0.7);
            padding: 30px;
            overflow-y: auto;
            transition: right 0.3s ease;
            z-index: 1000;
        }
        .detail-panel.active { right: 0; }
        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #ef4444;
            color: #fff;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 1.5em;
            cursor: pointer;
            line-height: 0;
        }
        .close-btn:hover { background: #dc2626; }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #0f1a2e;
        }
        .tab {
            padding: 10px 20px;
            background: #0f1a2e;
            border: none;
            color: #e4e4e4;
            cursor: pointer;
            border-radius: 5px 5px 0 0;
            font-weight: bold;
        }
        .tab.active {
            background: #00d4ff;
            color: #1a1a2e;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        .panel-title {
            font-size: 1.6em;
            color: #00d4ff;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }
        .char-card {
            background: #0f1a2e;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .char-card h3 { 
            color: #00ff88; 
            margin-bottom: 10px; 
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .char-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #00d4ff;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #1a1a2e;
            font-size: 0.9em;
        }
        .stat-label { color: #00d4ff; font-weight: bold; }
        .vs-divider {
            text-align: center;
            font-size: 2em;
            color: #ff6b6b;
            margin: 15px 0;
            font-weight: bold;
        }
        .metric-box {
            background: #1a1a2e;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #00d4ff;
        }
        .metric-box h4 { color: #00d4ff; margin-bottom: 8px; font-size: 1em; }
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            text-align: center;
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
        }
        .synergy-list {
            list-style: none;
            padding: 0;
        }
        .synergy-item {
            background: #1a1a2e;
            padding: 12px;
            margin: 8px 0;
            border-radius: 5px;
            border-left: 3px solid #00ff88;
        }
        .partner-badge {
            display: inline-block;
            background: #0f1a2e;
            padding: 5px 10px;
            border-radius: 15px;
            margin: 3px;
            font-size: 0.85em;
            border: 1px solid #00d4ff;
        }
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: #00d4ff;
        }
        .tooltip {
            position: absolute;
            background: #0f1a2e;
            border: 2px solid #00d4ff;
            border-radius: 8px;
            padding: 15px;
            display: none;
            z-index: 999;
            max-width: 320px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
            transition: all 0.2s ease;
        }
        @media (max-width: 768px) {
            .tooltip {
                max-width: 280px;
                font-size: 0.9em;
            }
            .tooltip img {
                width: 60px;
                height: 60px;
            }
        }
        .tooltip.active { 
            display: block; 
            animation: tooltipFadeIn 0.2s ease;
        }
        @keyframes tooltipFadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .tooltip img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-bottom: 10px;
            border: 2px solid #00d4ff;
            box-shadow: 0 2px 10px rgba(0, 212, 255, 0.3);
            object-fit: cover;
            background: #16213e;
        }
        .tooltip .char-name {
            font-weight: bold;
            color: #00d4ff;
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        .tooltip .char-stats {
            font-size: 0.85em;
            line-height: 1.4;
        }
        .tooltip .stat-row {
            display: flex;
            justify-content: space-between;
            margin: 2px 0;
        }
        .tooltip .stat-label {
            color: #888;
        }
        .tooltip .stat-value {
            color: #fff;
            font-weight: bold;
        }
        
        .bonus-icon {
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 0.75em;
            color: #ffcc00;
            animation: bonusPulse 1.5s infinite;
        }

        @keyframes bonusPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.2); }
        }

        .conditional-bonus-item {
            background: linear-gradient(135deg, rgba(255, 204, 0, 0.15), rgba(0, 212, 255, 0.1));
            padding: 10px;
            margin: 8px 0;
            border-radius: 6px;
            border: 2px solid #ffcc00;
        }

        .bonus-badge {
            display: inline-block;
            background: #ffcc00;
            color: #1a1a2e;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7em;
            font-weight: bold;
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚öîÔ∏è Warhammer 40K: Tacticus - Matchup Analyzer</h1>
        
        <!-- üÜï –ö–ù–û–ü–ö–ê –í–ú–ï–°–¢–û –ü–õ–ê–í–ê–Æ–©–ï–ô –ü–ê–ù–ï–õ–ò -->
        <button class="sync-button" onclick="syncAllData()">
            üîÑ –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø
        </button>
        <div id="autoLoadStatus" class="auto-load-status">
            –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö...
        </div>
        
        <div class="filters">
            <div class="filter-group">
                <label>üéØ –°–û–†–¢–ò–†–û–í–ö–ê</label>
                <select id="sortOrder">
                    <option value="alpha">–ê–ª—Ñ–∞–≤–∏—Ç (A-Z)</option>
                    <option value="hp">–ü–æ HP (–±–æ–ª—å—à–µ ‚Üí –º–µ–Ω—å—à–µ)</option>
                    <option value="armor">–ü–æ –±—Ä–æ–Ω–µ (–±–æ–ª—å—à–µ ‚Üí –º–µ–Ω—å—à–µ)</option>
                    <option value="damage">–ü–æ —É—Ä–æ–Ω—É (–±–æ–ª—å—à–µ ‚Üí –º–µ–Ω—å—à–µ)</option>
                </select>
            </div>

            <div class="filter-group">
                <label>üè∞ –§–†–ê–ö–¶–ò–Ø</label>
                <select id="factionFilter">
                    <option value="">–í—Å–µ —Ñ—Ä–∞–∫—Ü–∏–∏</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>‚ú® –¢–†–ï–ô–¢</label>
                <select id="traitFilter">
                    <option value="">–í—Å–µ —Ç—Ä–µ–π—Ç—ã</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>üó°Ô∏è –§–ò–õ–¨–¢–† –ê–¢–ê–ö–£–Æ–©–ò–•</label>
                <select id="attackerFilter">
                    <option value="">–í—Å–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>üõ°Ô∏è –§–ò–õ–¨–¢–† –ó–ê–©–ò–©–ê–Æ–©–ò–•–°–Ø</label>
                <select id="defenderFilter">
                    <option value="">–í—Å–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏</option>
                </select>
            </div>

            <div class="filter-group">
                <label>‚ö° –¢–ò–ü –£–†–û–ù–ê</label>
                <select id="damageTypeFilter">
                    <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
                    <option value="melee">–¢–æ–ª—å–∫–æ Melee</option>
                    <option value="ranged">–¢–æ–ª—å–∫–æ Ranged</option>
                    <option value="both">–û–±–∞ —Ç–∏–ø–∞</option>
                </select>
            </div>
            
            <div class="limit-group">
                <label>üìä –ü–û–ö–ê–ó–ê–¢–¨ –ü–ï–†–í–´–•</label>
                <select id="limitSelect">
                    <option value="20">20 –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π</option>
                    <option value="30">30 –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π</option>
                    <option value="50" selected>50 –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π</option>
                    <option value="100">–í—Å–µ (100)</option>
                </select>
            </div>
        </div>

        <div class="legend">
            <div class="legend-item"><div class="legend-color excellent"></div><span>–û—Ç–ª–∏—á–Ω–æ (90-100%)</span></div>
            <div class="legend-item"><div class="legend-color good"></div><span>–•–æ—Ä–æ—à–æ (70-89%)</span></div>
            <div class="legend-item"><div class="legend-color neutral"></div><span>–ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ (50-69%)</span></div>
            <div class="legend-item"><div class="legend-color poor"></div><span>–ü–ª–æ—Ö–æ (30-49%)</span></div>
            <div class="legend-item"><div class="legend-color terrible"></div><span>–£–∂–∞—Å–Ω–æ (0-29%)</span></div>
        </div>

        <div class="matrix-container">
            <div id="loading" class="loading">
                –ù–∞–∂–º–∏—Ç–µ "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è" –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
            </div>
            <table id="matchupTable" style="display: none;">
                <thead id="tableHead"></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <div class="detail-panel" id="detailPanel">
        <button class="close-btn" onclick="closeDetail()">√ó</button>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('analysis')">üìä –ê–Ω–∞–ª–∏–∑</button>
            <button class="tab" onclick="switchTab('synergy')">ü§ù –°–∏–Ω–µ—Ä–≥–∏—è</button>
            <button class="tab" onclick="switchTab('counters')">‚ö†Ô∏è –ö–æ–Ω—Ç—Ä—ã</button>
        </div>
        
        <div id="detailContent">
            <div id="analysisTab" class="tab-content active"></div>
            <div id="synergyTab" class="tab-content"></div>
            <div id="countersTab" class="tab-content"></div>
        </div>
    </div>
    
    <div class="tooltip" id="tooltip"></div>
    
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div>
            <div>‚öîÔ∏è –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö...</div>
            <div style="font-size: 0.7em; margin-top: 10px;">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ</div>
        </div>
    </div>

    <script>
        const PIERCE_RATIOS = {
            'Psychic': 100, 'Direct': 100, 'Piercing': 80, 'Melta': 75,
            'Plasma': 65, 'Eviscerating': 50, 'Power': 40, 'Flame': 30,
            'Energy': 30, 'Bolter': 20, 'Chain': 20, 'Pulse': 20,
            'Blast': 15, 'Heavy Round': 15, 'Bio': 15, 'Molecular': 15,
            'Particle': 15, 'Toxic': 15, 'Las': 10, 'Projectile': 5,
            'Physical': 1
        };
        
        const MACHINES_OF_WAR = [
            'Biovore', 'Exorcist', 'Forgefiend', 'Galatian',
            'Malleus Rocket Launcher', 'Plagueburst Crawler',
            'Rukkatrukk', "Tson'ji"
        ];

        let traitsDB = [];
        let characterTraitsDB = [];
        let conditionalBonusesDB = [];
        let characterFactionsDB = [];
        let characterAttackTypesDB = [];

        async function loadConditionalDatabases() {
            try {
                const parseCSV = (text) => {
                    const lines = text.trim().split('\n');
                    const headers = lines[0].split(',').map(h => h.trim());
                    return lines.slice(1).map(line => {
                        const values = [];
                        let current = '';
                        let inQuotes = false;

                        for (let char of line) {
                            if (char === '"') {
                                inQuotes = !inQuotes;
                            } else if (char === ',' && !inQuotes) {
                                values.push(current.trim());
                                current = '';
                            } else {
                                current += char;
                            }
                        }
                        values.push(current.trim());

                        return headers.reduce((obj, header, i) => {
                            obj[header] = values[i]?.replace(/^\"|\"$/g, '') || '';
                            return obj;
                        }, {});
                    });
                };

                const [traitsText, charTraitsText, bonusesText, factionsText, attacksText] = await Promise.all([
                    fetch('traits_database.csv').then(r => r.ok ? r.text() : null).catch(() => null),
                    fetch('character_traits.csv').then(r => r.ok ? r.text() : null).catch(() => null),
                    fetch('conditional_bonuses.csv').then(r => r.ok ? r.text() : null).catch(() => null),
                    fetch('character_factions.csv').then(r => r.ok ? r.text() : null).catch(() => null),
                    fetch('character_attack_types.csv').then(r => r.ok ? r.text() : null).catch(() => null)
                ]);

                if (traitsText) traitsDB = parseCSV(traitsText);
                if (charTraitsText) characterTraitsDB = parseCSV(charTraitsText);
                if (bonusesText) conditionalBonusesDB = parseCSV(bonusesText);
                if (factionsText) characterFactionsDB = parseCSV(factionsText);
                if (attacksText) characterAttackTypesDB = parseCSV(attacksText);

                console.log('‚úÖ CSV databases loaded:', {
                    traits: traitsDB.length,
                    charTraits: characterTraitsDB.length,
                    bonuses: conditionalBonusesDB.length,
                    factions: characterFactionsDB.length,
                    attacks: characterAttackTypesDB.length
                });

                return true;
            } catch (error) {
                console.warn('‚ö†Ô∏è Could not load CSV databases:', error);
                return false;
            }
        }

        function getCharacterTraits(characterName) {
            if (characterTraitsDB.length === 0) {
                const char = characters.find(c => c.name === characterName);
                if (!char || !char.traits) return [];
                return typeof char.traits === 'string' 
                    ? char.traits.split(', ').map(t => t.trim()).filter(t => t)
                    : char.traits;
            }
            return characterTraitsDB
                .filter(row => row.character === characterName)
                .map(row => row.trait);
        }

        function getTraitData(traitName) {
            return traitsDB.find(row => row.trait_name === traitName);
        }

        function getConditionalBonuses(characterName) {
            return conditionalBonusesDB.filter(row => row.character === characterName);
        }

        function isCharacter(entry) {
            return entry.baseStats &&
                   entry.attacks &&
                   (!entry.rawInfobox?.Type ||
                    (entry.rawInfobox?.Type && !entry.rawInfobox.Type.includes("Badge") &&
                     !entry.rawInfobox.Type.includes("Component") &&
                     !entry.rawInfobox.Type.includes("Mythic")));
        }
        
        let characters = [];
        let matchupMatrix = {};
        let synergyDatabase = {};
        let counterDatabase = {};
        let currentLimit = 50;
        let currentAttacker = null;
        let currentDefender = null;

        window.addEventListener('load', function() {
            // –ù–µ –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∂–∞–µ–º - –∂–¥—ë–º –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏
        });

        async function syncAllData() {
            const statusDiv = document.getElementById('autoLoadStatus');
            const loadingOverlay = document.getElementById('loadingOverlay');
            
            statusDiv.textContent = 'üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...';
            statusDiv.className = 'auto-load-status';
            loadingOverlay.classList.remove('hidden');
            
            try {
                let mainData = null;
                let dataSource = '';
                
                try {
                    const txtResponse = await fetch('data.txt');
                    if (txtResponse.ok) {
                        const txtContent = await txtResponse.text();
                        mainData = JSON.parse(txtContent);
                        dataSource = 'data.txt';
                    }
                } catch (e) {
                    console.log('data.txt not found, trying data.json...');
                }
                
                if (!mainData) {
                    const jsonResponse = await fetch('data.json');
                    if (!jsonResponse.ok) throw new Error('–§–∞–π–ª—ã –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
                    mainData = await jsonResponse.json();
                    dataSource = 'data.json';
                }
                
                let dataArray = mainData;
                if (mainData.characters && Array.isArray(mainData.characters)) {
                    dataArray = mainData.characters;
                    console.log('‚úÖ Detected new data.json structure with "characters" key');
                } else if (!Array.isArray(mainData)) {
                    throw new Error('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö');
                }
                
                // üÜï –ó–ê–ì–†–£–ñ–ê–ï–ú ENHANCED –ë–ê–ó–´ –î–ê–ù–ù–´–•
                const [synergyResponse, counterResponse, enhancedSynergyResponse, enhancedCounterResponse] = await Promise.all([
                    fetch('synergy_database.json').catch(() => null),
                    fetch('counter_database.json').catch(() => null),
                    fetch('enhanced_synergy_database.json').catch(() => null),
                    fetch('enhanced_counter_database.json').catch(() => null)
                ]);
                
                if (synergyResponse?.ok) {
                    synergyDatabase = await synergyResponse.json();
                }
                
                // üÜï –ü–†–ò–û–†–ò–¢–ï–¢ ENHANCED –ë–ê–ó–ê–ú
                if (enhancedSynergyResponse?.ok) {
                    const enhancedData = await enhancedSynergyResponse.json();
                    synergyDatabase = {...synergyDatabase, ...enhancedData};
                    console.log('‚úÖ Enhanced synergy database loaded');
                }
                
                if (counterResponse?.ok) {
                    counterDatabase = await counterResponse.json();
                }
                
                // üÜï –ü–†–ò–û–†–ò–¢–ï–¢ ENHANCED –ë–ê–ó–ê–ú
                if (enhancedCounterResponse?.ok) {
                    const enhancedData = await enhancedCounterResponse.json();
                    counterDatabase = {...counterDatabase, ...enhancedData};
                    console.log('‚úÖ Enhanced counter database loaded');
                }
                
                await loadConditionalDatabases();
                
                const filtered = dataArray.filter(c => isCharacter(c) && !MACHINES_OF_WAR.includes(c.name));
                
                characters = filtered.map((c, i) => ({
                    id: i + 1,
                    name: c.name,
                    hp: parseInt(c.baseStats?.health || c.baseHealth || 100),
                    armor: parseInt(c.baseStats?.armour || c.baseArmour || 20),
                    dmg: parseInt(c.baseStats?.damage || c.baseDamage || 15),
                    melee: c.attacks?.melee || c.meleeAttack || 'N/A',
                    ranged: c.attacks?.ranged || c.rangedAttack || 'N/A',
                    traits: c.traits || '',
                    icon: c.images?.heroIcon || c.images?.heroArt || '',
                    faction: c.faction || 'Unknown',
                    activeAbility: c.activeAbility || {},
                    passiveAbility: c.passiveAbility || {}
                }));
                
                characters.sort((a, b) => a.name.localeCompare(b.name));
                
                buildMatchupMatrix();
                populateFilters();
                renderTable();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('matchupTable').style.display = 'table';
                loadingOverlay.classList.add('hidden');
                
                const synergyStatus = Object.keys(synergyDatabase).length > 0 ? '‚úÖ' : '‚ö†Ô∏è';
                const counterStatus = Object.keys(counterDatabase).length > 0 ? '‚úÖ' : '‚ö†Ô∏è';
                const csvStatus = traitsDB.length > 0 ? '‚úÖ' : '‚ö†Ô∏è';
                
                statusDiv.innerHTML = `
                    ‚úÖ ${characters.length} –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π<br>
                    ${csvStatus} CSV –±–∞–∑—ã (${traitsDB.length} traits)<br>
                    ${synergyStatus} –°–∏–Ω–µ—Ä–≥–∏–∏ (${Object.keys(synergyDatabase).length}) | ${counterStatus} –ö–æ–Ω—Ç—Ä—ã (${Object.keys(counterDatabase).length})<br>
                    <small>–ò—Å—Ç–æ—á–Ω–∏–∫: ${dataSource}</small>
                `;
                statusDiv.classList.add('success');
                
            } catch (error) {
                console.error('Sync error:', error);
                loadingOverlay.classList.add('hidden');
                statusDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
                statusDiv.classList.add('error');
            }
        }

        function loadFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const loadingOverlay = document.getElementById('loadingOverlay');
            const reader = new FileReader();
            loadingOverlay.classList.remove('hidden');
            
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    let dataArray = data;
                    if (data.characters && Array.isArray(data.characters)) {
                        dataArray = data.characters;
                    } else if (!Array.isArray(data)) {
                        throw new Error('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');
                    }
                    
                    const filtered = dataArray.filter(c => isCharacter(c) && !MACHINES_OF_WAR.includes(c.name));
                    
                    characters = filtered.map((c, i) => ({
                        id: i + 1,
                        name: c.name,
                        hp: parseInt(c.baseStats?.health || c.baseHealth || 100),
                        armor: parseInt(c.baseStats?.armour || c.baseArmour || 20),
                        dmg: parseInt(c.baseStats?.damage || c.baseDamage || 15),
                        melee: c.attacks?.melee || c.meleeAttack || 'N/A',
                        ranged: c.attacks?.ranged || c.rangedAttack || 'N/A',
                        traits: c.traits || '',
                        icon: c.images?.heroIcon || c.images?.heroArt || '',
                        faction: c.faction || 'Unknown',
                        activeAbility: c.activeAbility || {},
                        passiveAbility: c.passiveAbility || {}
                    }));
                    
                    characters.sort((a, b) => a.name.localeCompare(b.name));
                    
                    buildMatchupMatrix();
                    populateFilters();
                    renderTable();
                    
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('matchupTable').style.display = 'table';
                    loadingOverlay.classList.add('hidden');
                    
                    const statusDiv = document.getElementById('autoLoadStatus');
                    statusDiv.innerHTML = `‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${characters.length} –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π<br><small>–ò–∑ —Ñ–∞–π–ª–∞</small>`;
                    statusDiv.classList.add('success');
                    
                } catch (error) {
                    loadingOverlay.classList.add('hidden');
                    alert('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function extractAttackInfo(attackStr) {
            if (!attackStr || attackStr === 'N/A') return [null, 0];
            const parts = attackStr.split('/').map(p => p.trim());
            const damageType = parts[0] || 'Physical';
            let hits = 1;
            for (const part of parts) {
                if (part.toLowerCase().includes('hit')) {
                    const match = part.match(/\d+/);
                    if (match) hits = parseInt(match[0]);
                }
            }
            return [damageType, hits];
        }

        function calculateMatchup(attacker, defender) {
            const [rangedType, rangedHits] = extractAttackInfo(attacker.ranged);
            const [meleeType, meleeHits] = extractAttackInfo(attacker.melee);
            const [atkType, atkHits] = (rangedType && rangedHits > 0) 
                ? [rangedType, rangedHits] 
                : [meleeType, meleeHits];

            const pierce = PIERCE_RATIOS[atkType] || 20;

            const atkTraits = getCharacterTraits(attacker.name);
            const defTraits = getCharacterTraits(defender.name);

            let dmg = attacker.dmg;
            let armor = defender.armor;

            atkTraits.forEach(traitName => {
                const trait = getTraitData(traitName);
                if (trait && trait.effect_type === 'damage_multiplier' && trait.implemented === 'yes') {
                    dmg *= parseFloat(trait.effect_value);
                }
            });

            if (traitsDB.length === 0) {
                if (atkTraits.includes('Crushing Strike')) dmg *= 1.25;
                if (atkTraits.includes('Let the Galaxy Burn')) dmg *= 1.15;
            }

            defTraits.forEach(traitName => {
                const trait = getTraitData(traitName);
                if (trait && trait.effect_type === 'armor_multiplier' && trait.implemented === 'yes') {
                    armor *= parseFloat(trait.effect_value);
                }
            });

            if (traitsDB.length === 0) {
                if (defTraits.includes('Terminator Armour')) armor *= 1.4;
                if (defTraits.includes('Mk X Gravis')) armor *= 1.5;
            }

            let hasConditionalBonus = false;
            let conditionalBonusDetails = null;

            const bonuses = getConditionalBonuses(attacker.name);
            bonuses.forEach(bonus => {
                const conditionMet = bonus.condition_type === 'trait' 
                    ? defTraits.includes(bonus.condition_value)
                    : bonus.condition_type === 'faction'
                    ? defender.faction === bonus.condition_value
                    : false;

                if (conditionMet) {
                    hasConditionalBonus = true;

                    let bonusMultiplier = 1.5;
                    if (bonus.bonus_value && bonus.bonus_value !== 'unknown' && !isNaN(parseFloat(bonus.bonus_value))) {
                        bonusMultiplier = 1 + parseFloat(bonus.bonus_value) / 100;
                    }

                    dmg *= bonusMultiplier;

                    conditionalBonusDetails = {
                        name: bonus.ability_name,
                        type: bonus.ability_type,
                        conditionType: bonus.condition_type,
                        target: bonus.condition_value,
                        multiplier: bonusMultiplier,
                        confidence: bonus.confidence
                    };
                }
            });

            let incomingMult = 1.0;
            defTraits.forEach(traitName => {
                const trait = getTraitData(traitName);
                if (trait && trait.implemented === 'yes') {
                    if (trait.effect_type === 'damage_reduction') {
                        incomingMult *= parseFloat(trait.effect_value);
                    }
                    if (trait.effect_type === 'damage_taken_multiplier') {
                        incomingMult *= parseFloat(trait.effect_value);
                    }
                }
            });

            if (traitsDB.length === 0) {
                if (defTraits.includes('Resilient')) incomingMult *= 0.8;
                if (defTraits.includes('Big Target')) incomingMult *= 1.3;
            }

            const dmgAfterArmor = Math.max(1, dmg - armor);
            const dmgPierce = Math.max(1, dmg * (pierce / 100));
            const dmgPerHit = Math.max(dmgAfterArmor, dmgPierce);

            const totalDmg = dmgPerHit * atkHits * incomingMult;
            const attackEff = Math.min(100, (totalDmg / defender.hp) * 100);

            // üÜï –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–û–†–ú–£–õ–ê –ó–ê–©–ò–¢–´
            // –°—Ç–∞—Ä–∞—è: const defenseEff = Math.min(100, Math.max(0, armorRatio * 50 + 25));
            // –ü—Ä–æ–±–ª–µ–º–∞: –ø—Ä–∏ armor >= dmg * 1.5 –¥–∞–≤–∞–ª–∞ 100%
            
            // –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞:
            // - –ï—Å–ª–∏ –±—Ä–æ–Ω—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –±–ª–æ–∫–∏—Ä—É–µ—Ç —É—Ä–æ–Ω (armor >= dmg) ‚Üí –≤—ã—Å–æ–∫–∞—è –∑–∞—â–∏—Ç–∞
            // - –ï—Å–ª–∏ –±—Ä–æ–Ω—è —á–∞—Å—Ç–∏—á–Ω–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç ‚Üí —Å—Ä–µ–¥–Ω—è—è –∑–∞—â–∏—Ç–∞
            // - –£—á–∏—Ç—ã–≤–∞–µ–º pierce - —á–µ–º –≤—ã—à–µ pierce, —Ç–µ–º –Ω–∏–∂–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –±—Ä–æ–Ω–∏
            
            const armorEffectiveness = Math.max(0, (armor - dmg * (pierce / 100)));
            const hpProtectionRounds = defender.hp / Math.max(1, dmg - armor);
            
            // –ó–∞—â–∏—Ç–∞ = –∫–æ–º–±–∏–Ω–∞—Ü–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∏—è —É—Ä–æ–Ω–∞ + –≤—ã–∂–∏–≤–∞–µ–º–æ—Å—Ç–∏
            // –ú–∞–∫—Å–∏–º—É–º 85% (–Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –¥–∞—ë–º 100%)
            const rawDefense = (armorEffectiveness / dmg) * 40 + Math.min(30, hpProtectionRounds * 3);
            const defenseEff = Math.min(85, Math.max(5, rawDefense));

            const average = (attackEff + defenseEff) / 2;

            return {
                attack: Math.round(attackEff * 10) / 10,
                defense: Math.round(defenseEff * 10) / 10,
                average: Math.round(average * 10) / 10,
                hasConditionalBonus: hasConditionalBonus,
                conditionalBonus: conditionalBonusDetails
            };
        }

        function buildMatchupMatrix() {
            matchupMatrix = {};
            characters.forEach(attacker => {
                matchupMatrix[attacker.name] = {};
                characters.forEach(defender => {
                    matchupMatrix[attacker.name][defender.name] = null;
                });
            });
        }

        function getMatchup(attacker, defender) {
            if (matchupMatrix[attacker.name][defender.name] === null) {
                matchupMatrix[attacker.name][defender.name] = calculateMatchup(attacker, defender);
            }
            return matchupMatrix[attacker.name][defender.name];
        }

        function populateFilters() {
            const atkFilter = document.getElementById('attackerFilter');
            const defFilter = document.getElementById('defenderFilter');
            const factionFilter = document.getElementById('factionFilter');
            const traitFilter = document.getElementById('traitFilter');
            
            atkFilter.innerHTML = '<option value="">–í—Å–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏</option>';
            defFilter.innerHTML = '<option value="">–í—Å–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏</option>';
            
            const factions = [...new Set(characters.map(c => c.faction))].sort();
            factionFilter.innerHTML = '<option value="">–í—Å–µ —Ñ—Ä–∞–∫—Ü–∏–∏</option>';
            factions.forEach(faction => {
                if (faction && faction !== 'Unknown') {
                    const opt = document.createElement('option');
                    opt.value = faction;
                    opt.textContent = faction;
                    factionFilter.appendChild(opt);
                }
            });
            
            const allTraits = new Set();
            characters.forEach(char => {
                const traits = getCharacterTraits(char.name);
                traits.forEach(t => allTraits.add(t));
            });
            
            const sortedTraits = [...allTraits].sort();
            traitFilter.innerHTML = '<option value="">–í—Å–µ —Ç—Ä–µ–π—Ç—ã</option>';
            sortedTraits.forEach(trait => {
                if (trait) {
                    const opt = document.createElement('option');
                    opt.value = trait;
                    opt.textContent = trait;
                    traitFilter.appendChild(opt);
                }
            });
            
            characters.forEach(char => {
                const opt1 = document.createElement('option');
                opt1.value = char.name;
                opt1.textContent = char.name;
                atkFilter.appendChild(opt1);
                
                const opt2 = document.createElement('option');
                opt2.value = char.name;
                opt2.textContent = char.name;
                defFilter.appendChild(opt2);
            });
        }

        function getEffectivenessClass(pct) {
            if (pct >= 90) return 'cell-90-100';
            if (pct >= 70) return 'cell-70-89';
            if (pct >= 50) return 'cell-50-69';
            if (pct >= 30) return 'cell-30-49';
            return 'cell-0-29';
        }

        function renderTable() {
            const atkFilter = document.getElementById('attackerFilter').value;
            const defFilter = document.getElementById('defenderFilter').value;
            const factionFilter = document.getElementById('factionFilter').value;
            const traitFilter = document.getElementById('traitFilter').value;
            const damageTypeFilter = document.getElementById('damageTypeFilter').value;
            const sortOrder = document.getElementById('sortOrder').value;
            const limit = parseInt(document.getElementById('limitSelect').value);
            
            let filteredChars = characters.filter(c => {
                if (factionFilter && c.faction !== factionFilter) return false;
                if (traitFilter && !getCharacterTraits(c.name).includes(traitFilter)) return false;
                if (damageTypeFilter) {
                    const hasMelee = c.melee && c.melee !== 'N/A';
                    const hasRanged = c.ranged && c.ranged !== 'N/A';
                    if (damageTypeFilter === 'melee' && !hasMelee) return false;
                    if (damageTypeFilter === 'ranged' && !hasRanged) return false;
                    if (damageTypeFilter === 'both' && (!hasMelee || !hasRanged)) return false;
                }
                return true;
            });
            
            if (sortOrder === 'alpha') {
                filteredChars.sort((a, b) => a.name.localeCompare(b.name));
            } else if (sortOrder === 'hp') {
                filteredChars.sort((a, b) => b.hp - a.hp);
            } else if (sortOrder === 'armor') {
                filteredChars.sort((a, b) => b.armor - a.armor);
            } else if (sortOrder === 'damage') {
                filteredChars.sort((a, b) => b.dmg - a.dmg);
            }
            
            let displayedAtk = filteredChars.slice(0, limit);
            if (atkFilter) {
                displayedAtk = filteredChars.filter(c => c.name === atkFilter);
            }
            
            let displayedDef = filteredChars.slice(0, limit);
            if (defFilter) {
                displayedDef = filteredChars.filter(c => c.name === defFilter);
            }
            
            const thead = document.getElementById('tableHead');
            const tbody = document.getElementById('tableBody');
            
            thead.innerHTML = '';
            tbody.innerHTML = '';
            
            const headerRow = document.createElement('tr');
            const corner = document.createElement('th');
            corner.textContent = '–ê–¢–ê–ö–£–Æ–©–ò–ô ‚Üì / –ó–ê–©–ò–©–ê–Æ–©–ò–ô–°–Ø ‚Üí';
            corner.colSpan = 1;
            headerRow.appendChild(corner);
            
            displayedDef.forEach((def, index) => {
                const nameTh = document.createElement('th');
                nameTh.innerHTML = `${index + 1}. ${def.name}`;
                nameTh.onmouseenter = (e) => showTooltip(e, def);
                nameTh.onmouseleave = hideTooltip;
                headerRow.appendChild(nameTh);
            });
            thead.appendChild(headerRow);
            
            displayedAtk.forEach((atk, atkIndex) => {
                const row = document.createElement('tr');
                
                const nameCell = document.createElement('td');
                nameCell.innerHTML = `${atkIndex + 1}. ${atk.name}`;
                nameCell.onmouseenter = (e) => showTooltip(e, atk);
                nameCell.onmouseleave = hideTooltip;
                row.appendChild(nameCell);
                
                displayedDef.forEach(def => {
                    const metrics = getMatchup(atk, def);
                    const cell = document.createElement('td');
                    cell.innerHTML = `
                        <div style="font-size: 0.7em; color: #888;">${metrics.attack}% / ${metrics.defense}%</div>
                        <div style="font-weight: bold; font-size: 1.1em; position: relative;">
                            ${metrics.average}%
                            ${metrics.hasConditionalBonus ? '<span class="bonus-icon">‚ö°</span>' : ''}
                        </div>
                    `;
                    cell.className = getEffectivenessClass(metrics.average);
                    cell.onclick = () => showDetail(atk, def, metrics);
                    row.appendChild(cell);
                });
                
                tbody.appendChild(row);
            });
        }

        function showTooltip(event, char) {
            const tooltip = document.getElementById('tooltip');
            const hasImage = char.icon && char.icon.trim() !== '';
            
            tooltip.innerHTML = `
                ${hasImage ? 
                    `<img src="${char.icon}" alt="${char.name}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                     <div style="width:80px;height:80px;background:#16213e;border-radius:50%;margin-bottom:10px;display:none;align-items:center;justify-content:center;color:#888;font-size:2em;">üë§</div>` : 
                    '<div style="width:80px;height:80px;background:#16213e;border-radius:50%;margin-bottom:10px;display:flex;align-items:center;justify-content:center;color:#888;font-size:2em;">üë§</div>'
                }
                <div class="char-name">${char.name}</div>
                <div class="char-stats">
                    <div class="stat-row">
                        <span class="stat-label">HP:</span>
                        <span class="stat-value">${char.hp}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">ARM:</span>
                        <span class="stat-value">${char.armor}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">DMG:</span>
                        <span class="stat-value">${char.dmg}</span>
                    </div>
                    <div style="margin-top:5px;color:#888;font-size:0.9em;">
                        <div>‚öîÔ∏è ${char.melee}</div>
                        <div>üèπ ${char.ranged}</div>
                    </div>
                </div>
            `;
            
            let left = event.pageX + 15;
            let top = event.pageY + 15;
            const tooltipWidth = window.innerWidth <= 768 ? 280 : 320;
            const tooltipHeight = window.innerWidth <= 768 ? 180 : 200;
            
            if (left + tooltipWidth > window.innerWidth) {
                left = event.pageX - tooltipWidth - 15;
            }
            
            if (top + tooltipHeight > window.innerHeight) {
                top = event.pageY - tooltipHeight - 15;
            }
            
            left = Math.max(10, Math.min(left, window.innerWidth - tooltipWidth - 10));
            top = Math.max(10, Math.min(top, window.innerHeight - tooltipHeight - 10));
            
            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
            tooltip.classList.add('active');
        }

        function hideTooltip() {
            document.getElementById('tooltip').classList.remove('active');
        }

        function showDetail(attacker, defender, metrics) {
            currentAttacker = attacker;
            currentDefender = defender;
            
            const calculatedMetrics = metrics || getMatchup(attacker, defender);
            
            renderAnalysisTab(attacker, defender, calculatedMetrics);
            renderSynergyTab(attacker);
            renderCountersTab(defender);
            
            document.getElementById('detailPanel').classList.add('active');
        }

        function closeDetail() {
            document.getElementById('detailPanel').classList.remove('active');
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        function renderAnalysisTab(atk, def, metrics) {
            const [atkType, atkHits] = extractAttackInfo(atk.ranged)[0] ? extractAttackInfo(atk.ranged) : extractAttackInfo(atk.melee);
            const pierce = PIERCE_RATIOS[atkType] || 20;
            
            const atkTraits = getCharacterTraits(atk.name);
            const defTraits = getCharacterTraits(def.name);
            
            document.getElementById('analysisTab').innerHTML = `
                <div class="panel-title">–î–ï–¢–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó</div>
                
                <div class="char-card">
                    <h3>
                        ${atk.icon ? `<img src="${atk.icon}" class="char-icon">` : ''}
                        ‚öîÔ∏è ${atk.name}
                    </h3>
                    <div class="stat-row"><span class="stat-label">HP:</span><span>${atk.hp}</span></div>
                    <div class="stat-row"><span class="stat-label">–ë—Ä–æ–Ω—è:</span><span>${atk.armor}</span></div>
                    <div class="stat-row"><span class="stat-label">–£—Ä–æ–Ω:</span><span>${atk.dmg}</span></div>
                    <div class="stat-row"><span class="stat-label">–ë–ª–∏–∂–Ω–∏–π:</span><span>${atk.melee}</span></div>
                    <div class="stat-row"><span class="stat-label">–î–∞–ª—å–Ω–∏–π:</span><span>${atk.ranged}</span></div>
                    <div class="stat-row"><span class="stat-label">Traits:</span><span style="font-size: 0.75em;">${atkTraits.join(', ')}</span></div>
                </div>
                
                <div class="vs-divider">‚öîÔ∏è VS ‚öîÔ∏è</div>
                
                <div class="char-card">
                    <h3>
                        ${def.icon ? `<img src="${def.icon}" class="char-icon">` : ''}
                        üõ°Ô∏è ${def.name}
                    </h3>
                    <div class="stat-row"><span class="stat-label">HP:</span><span>${def.hp}</span></div>
                    <div class="stat-row"><span class="stat-label">–ë—Ä–æ–Ω—è:</span><span>${def.armor}</span></div>
                    <div class="stat-row"><span class="stat-label">–£—Ä–æ–Ω:</span><span>${def.dmg}</span></div>
                    <div class="stat-row"><span class="stat-label">–ë–ª–∏–∂–Ω–∏–π:</span><span>${def.melee}</span></div>
                    <div class="stat-row"><span class="stat-label">–î–∞–ª—å–Ω–∏–π:</span><span>${def.ranged}</span></div>
                    <div class="stat-row"><span class="stat-label">Traits:</span><span style="font-size: 0.75em;">${defTraits.join(', ')}</span></div>
                </div>
                
                <div class="metric-box">
                    <h4>‚öîÔ∏è –≠–§–§–ï–ö–¢–ò–í–ù–û–°–¢–¨ –ê–¢–ê–ö–ò</h4>
                    <div class="metric-value" style="background: #${getColorForPct(metrics.attack)}">${metrics.attack}%</div>
                    <p style="font-size: 0.85em; margin-top: 5px;">
                        ${atkType} (${pierce}% pierce) √ó ${atkHits} hits
                    </p>
                </div>
                
                <div class="metric-box">
                    <h4>üõ°Ô∏è –≠–§–§–ï–ö–¢–ò–í–ù–û–°–¢–¨ –ó–ê–©–ò–¢–´</h4>
                    <div class="metric-value" style="background: #${getColorForPct(metrics.defense)}">${metrics.defense}%</div>
                    <p style="font-size: 0.85em; margin-top: 5px; color: #888;">
                        –£—á–∏—Ç—ã–≤–∞–µ—Ç –±—Ä–æ–Ω—é, HP –∏ pierce –∞—Ç–∞–∫—É—é—â–µ–≥–æ
                    </p>
                </div>
                
                <div class="metric-box">
                    <h4>üìä –°–†–ï–î–ù–Ø–Ø –≠–§–§–ï–ö–¢–ò–í–ù–û–°–¢–¨</h4>
                    <div class="metric-value" style="background: #${getColorForPct(metrics.average)}">${metrics.average}%</div>
                    <p style="font-size: 0.85em; margin-top: 5px;">
                        –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ –¥–ª—è —Å–ø–∞—Ä–∏–Ω–≥–∞
                    </p>
                </div>
                
                ${metrics.hasConditionalBonus && metrics.conditionalBonus ? `
                    <div class="metric-box" style="border-left-color: #ffcc00;">
                        <h4>‚ö° –£–°–õ–û–í–ù–´–ô –ë–û–ù–£–°</h4>
                        <div class="conditional-bonus-item">
                            <div style="font-weight: bold; color: #ffcc00; margin-bottom: 5px;">
                                ${metrics.conditionalBonus.name}
                                <span class="bonus-badge">${metrics.conditionalBonus.type}</span>
                            </div>
                            <div style="font-size: 0.85em; color: #ccc; margin: 5px 0;">
                                –£—Å–ª–æ–≤–∏–µ: ${metrics.conditionalBonus.conditionType === 'trait' ? '–¢—Ä–µ–π—Ç' : '–§—Ä–∞–∫—Ü–∏—è'} "${metrics.conditionalBonus.target}" ‚úÖ
                            </div>
                            <div style="font-size: 1.1em; color: #00ff88; margin-top: 8px; font-weight: bold;">
                                –ë–æ–Ω—É—Å: +${Math.round((metrics.conditionalBonus.multiplier - 1) * 100)}% —É—Ä–æ–Ω–∞
                            </div>
                            <div style="font-size: 0.75em; color: #888; margin-top: 5px;">
                                –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${metrics.conditionalBonus.confidence}
                            </div>
                        </div>
                    </div>
                ` : ''}
            `;
        }

        function renderSynergyTab(attacker) {
            const synergies = synergyDatabase[attacker.name] || [];
            
            if (synergies.length === 0) {
                document.getElementById('synergyTab').innerHTML = `
                    <div class="panel-title">ü§ù –°–ò–ù–ï–†–ì–ò–Ø</div>
                    <div style="background: #0f1a2e; padding: 15px; border-radius: 8px; text-align: center;">
                        <p style="color: #888;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å–∏–Ω–µ—Ä–≥–∏—è—Ö –¥–ª—è ${attacker.name}</p>
                    </div>
                `;
                return;
            }
            
            let html = `<div class="panel-title">ü§ù –°–ò–ù–ï–†–ì–ò–Ø</div>`;
            
            synergies.forEach(syn => {
                const partners = syn.partners || syn.best_with || [];
                const partnersList = Array.isArray(partners) 
                    ? partners.map(p => `<span class="partner-badge">${p}</span>`).join('')
                    : (typeof partners === 'string' ? `<span class="partner-badge">${partners}</span>` : '');
                
                html += `
                    <div class="synergy-item">
                        <div style="font-weight: bold; color: #00ff88; margin-bottom: 5px;">
                            ${syn.type === 'faction_buff' ? 'üèõÔ∏è –§—Ä–∞–∫—Ü–∏–æ–Ω–Ω—ã–π –ë–∞—Ñ—Ñ' : 
                              syn.type === 'trait_buff' ? '‚ú® –¢—Ä–µ–π—Ç –ë–∞—Ñ—Ñ' :
                              syn.type === 'tank' ? 'üõ°Ô∏è –¢–∞–Ω–∫' :
                              syn.type === 'support' ? 'üíö –ü–æ–¥–¥–µ—Ä–∂–∫–∞' :
                              syn.type === 'summon' ? 'üëª –ü—Ä–∏–∑—ã–≤–∞—Ç–µ–ª—å' : 'ü§ù –°–∏–Ω–µ—Ä–≥–∏—è'}
                        </div>
                        <div style="font-size: 0.9em; margin-bottom: 5px;">${syn.effect || syn.best_with || ''}</div>
                        ${syn.target_faction ? `<div style="font-size: 0.85em; color: #888;">–¶–µ–ª—å: ${syn.target_faction}</div>` : ''}
                        ${syn.target_trait ? `<div style="font-size: 0.85em; color: #888;">–¢—Ä–µ–π—Ç: ${syn.target_trait}</div>` : ''}
                        ${partnersList ? `<div style="margin-top: 8px;">${partnersList}</div>` : ''}
                        ${syn.source ? `<div style="font-size: 0.7em; color: #666; margin-top: 5px;">üìö ${syn.source}</div>` : ''}
                    </div>
                `;
            });
            
            document.getElementById('synergyTab').innerHTML = html;
        }

        function renderCountersTab(defender) {
            const counters = counterDatabase[defender.name] || [];
            
            if (counters.length === 0) {
                document.getElementById('countersTab').innerHTML = `
                    <div class="panel-title">‚ö†Ô∏è –ö–û–ù–¢–†–´</div>
                    <div style="background: #0f1a2e; padding: 15px; border-radius: 8px;">
                        <div class="synergy-item" style="border-left-color: #00ff88;">
                            ‚úÖ –ù–µ—Ç —è–≤–Ω—ã—Ö —Å–ª–∞–±–æ—Å—Ç–µ–π —É ${defender.name}
                        </div>
                    </div>
                `;
                return;
            }
            
            let html = `<div class="panel-title">‚ö†Ô∏è –ö–û–ù–¢–†–´</div>`;
            
            counters.forEach(counter => {
                const counterTypes = counter.counter_types || (counter.counter_type ? [counter.counter_type] : []);
                const typesList = counterTypes.map(t => `<span class="partner-badge" style="border-color: #fbbf24;">${t}</span>`).join('');
                const traitBadge = counter.counter_trait ? `<span class="partner-badge" style="border-color: #fbbf24;">${counter.counter_trait}</span>` : '';
                
                html += `
                    <div class="synergy-item" style="border-left-color: #fbbf24;">
                        <div style="font-weight: bold; color: #fbbf24; margin-bottom: 5px;">
                            ${counter.reason === 'low_hp' ? '‚ù§Ô∏è –ù–∏–∑–∫–æ–µ HP' :
                              counter.reason === 'high_armor' ? 'üõ°Ô∏è –í—ã—Å–æ–∫–∞—è –ë—Ä–æ–Ω—è' :
                              counter.reason === 'big_target' ? 'üéØ –ë–æ–ª—å—à–∞—è –¶–µ–ª—å' :
                              counter.reason === 'flying' ? 'ü¶Ö –õ–µ—Ç–∞—é—â–∏–π' :
                              counter.reason === 'melee_weakness' ? '‚öîÔ∏è –°–ª–∞–±–æ—Å—Ç—å –∫ –ú–∏–ª–∏' : '‚ö†Ô∏è –°–ª–∞–±–æ—Å—Ç—å'}
                        </div>
                        <div style="font-size: 0.9em; margin-bottom: 5px;">${counter.weakness}</div>
                        ${typesList ? `<div style="margin-top: 8px;">${typesList}</div>` : ''}
                        ${traitBadge ? `<div style="margin-top: 8px;">${traitBadge}</div>` : ''}
                        ${counter.source ? `<div style="font-size: 0.7em; color: #666; margin-top: 5px;">üìö ${counter.source}</div>` : ''}
                    </div>
                `;
            });
            
            document.getElementById('countersTab').innerHTML = html;
        }

        function getColorForPct(pct) {
            if (pct >= 90) return '00ff00';
            if (pct >= 70) return '4ade80';
            if (pct >= 50) return 'fbbf24';
            if (pct >= 30) return 'fb923c';
            return 'ef4444';
        }

        document.getElementById('attackerFilter').addEventListener('change', renderTable);
        document.getElementById('defenderFilter').addEventListener('change', renderTable);
        document.getElementById('factionFilter').addEventListener('change', renderTable);
        document.getElementById('traitFilter').addEventListener('change', renderTable);
        document.getElementById('damageTypeFilter').addEventListener('change', renderTable);
        document.getElementById('sortOrder').addEventListener('change', renderTable);
        document.getElementById('limitSelect').addEventListener('change', (e) => {
            currentLimit = parseInt(e.target.value);
            renderTable();
        });
    </script>
</body>
</html>